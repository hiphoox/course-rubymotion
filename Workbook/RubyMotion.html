<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title>Programming RubyMotion</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Helvetica,sans-serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: #880009;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: #880009;
}

strong {
  font-weight: bold;
  color: #880009;
}

h1, h2, h3, h4, h5, h6 {
  color: #880009;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1 {
  border-bottom: 1px solid #dddddd;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
  color: #666666;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #4f4f4f; }
ul > li > * { color: #666666; }

.monospaced, code, pre {
  font-family: Inconsolata;
  font-size: inherit;
  color: #4d4d4c;
  padding: 0;
  margin: 0;
}


#author {
  color: #880009;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
  color: #666666;
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
  color: #666666;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding:: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #4f4f4f;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1.5px solid #dddddd;
  background: #f4f4f4;
  padding: 0.5em;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
  font-family: Inconsolata;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #f2f2f2;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #666666;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
  color: #4f4f4f;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid red;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}

/*
  pygmentize filter
*/
.highlight .hll { background-color: #8e908c; color:#ffd27e; font-family: Inconsolata; }
.highlight  { background: #f4f4f4; font-family: Inconsolata; }
.highlight .c { color: #8e908c; font-style: italic; font-family: Inconsolata; } /* Comment */
.highlight .err { border: 1px solid #FF0000; font-family: Inconsolata; } /* Error */
.highlight .k { color: #8959a8; font-family: Inconsolata; } /* Keyword */
.highlight .o { color: #666666; font-family: Inconsolata; } /* Operator */

.highlight .cm { color: #8e908c; font-style: italic; font-family: Inconsolata; } /* Comment.Multiline */
.highlight .cp { color: #8e908c; font-family: Inconsolata; } /* Comment.Preproc */
.highlight .c1 { color: #8e908c; font-style: italic; font-family: Inconsolata; } /* Comment.Single */
.highlight .cs { color: #8e908c; font-weight: bold; font-family: Inconsolata; } /* Comment.Special */
.highlight .gd { color: #A00000; font-family: Inconsolata; } /* Generic.Deleted */
.highlight .ge { font-style: italic; font-family: Inconsolata; } /* Generic.Emph */
.highlight .gr { color: #FF0000; font-family: Inconsolata; } /* Generic.Error */

.highlight .gh { color: #000080; font-weight: bold; font-family: Inconsolata; } /* Generic.Heading */
.highlight .gi { color: #00A000; font-family: Inconsolata; } /* Generic.Inserted */
.highlight .go { color: #808080; font-family: Inconsolata; } /* Generic.Output */
.highlight .gp { color: #4d4d4c; font-weight: bold; font-family: Inconsolata; } /* Generic.Prompt */
.highlight .gs { font-weight: bold; font-family: Inconsolata; } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold; font-family: Inconsolata; } /* Generic.Subheading */
.highlight .gt { color: #800080; font-family: Inconsolata; } /* Generic.Traceback */


.highlight .kc { color: #8959a8; font-family: Inconsolata; } /* Keyword.Constant */
.highlight .kd { color: #8959a8; font-family: Inconsolata; } /* Keyword.Declaration */
.highlight .kn { color: #8959a8; font-family: Inconsolata; } /* Keyword.Namespace */
.highlight .kp { color: #8959a8; font-family: Inconsolata; } /* Keyword.Pseudo */
.highlight .kr { color: #8959a8; font-family: Inconsolata; } /* Keyword.Reserved */
.highlight .kt { color: #8959a8; font-family: Inconsolata; } /* Keyword.Type */


.highlight .m { color: #666666; font-family: Inconsolata; } /* Literal.Number */
.highlight .s { color: #BB4444; font-family: Inconsolata; } /* Literal.String */

.highlight .na { color: #BB4444; font-family: Inconsolata; } /* Name.Attribute */
.highlight .nb { color: #718c00; font-family: Inconsolata; } /* Name.Builtin */
.highlight .nc { color: #c82829; font-family: Inconsolata; } /* Name.Class */
.highlight .no { color: #c82829; font-family: Inconsolata; } /* Name.Constant */
.highlight .nd { color: #AA22FF; font-family: Inconsolata; } /* Name.Decorator */
.highlight .ni { color: #999999; font-family: Inconsolata; } /* Name.Entity */
.highlight .ne { color: #D2413A; font-family: Inconsolata; } /* Name.Exception */
.highlight .nf { color: #4271ae; font-family: Inconsolata; } /* Name.Function */
.highlight .nl { color: #A0A000; font-family: Inconsolata; } /* Name.Label */
.highlight .nn { color: #0000FF; font-family: Inconsolata; } /* Name.Namespace */
.highlight .nt { color: #008000; font-family: Inconsolata; } /* Name.Tag */
.highlight .nv { color: #4d4d4c; font-family: Inconsolata; } /* Name.Variable */
.highlight .bp { color: #AA22FF; font-family: Inconsolata; } /* Name.Builtin.Pseudo */
.highlight .vc { color: #4d4d4c; font-family: Inconsolata; } /* Name.Variable.Class */
.highlight .vg { color: #3e999f; font-family: Inconsolata; } /* Name.Variable.Global */
.highlight .vi { color: #3e999f; font-family: Inconsolata; } /* Name.Variable.Instance */


.highlight .ow { color: #f5871f; font-family: Inconsolata; } /* Operator.Word */
.highlight .w { color: #f5871f; font-family: Inconsolata; } /* Text.Whitespace */
.highlight .mf { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Float */
.highlight .mh { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Hex */
.highlight .mi { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Integer */
.highlight .mo { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Oct */
.highlight .sb { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Backtick */
.highlight .sc { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Char */
.highlight .sd { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Doc */
.highlight .s2 { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Double */
.highlight .se { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Escape */
.highlight .sh { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Heredoc */
.highlight .si { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Interpol */
.highlight .sx { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Other */
.highlight .sr { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Regex */
.highlight .s1 { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Single */
.highlight .ss { color: #f5871f; font-family: Inconsolata; } /* Literal.String.Symbol */


.highlight .il { color: #f5871f; font-family: Inconsolata; } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Programming RubyMotion</h1>
<span id="author">Norberto Ortigoza</span><br />
<span id="revnumber">version 0.1,</span>
<span id="revdate">Oct 01, 2012</span>
</div>
<div id="content">
<h1 id="_day_1">Day 1</h1>
<h1 id="_chapter_02_first_application">Chapter 02 - First Application</h1>
<div class="sect1">
<h2 id="_time_zone_converter_app">Time Zone Converter App</h2>
<div class="sectionbody">
<div class="paragraph"><p>It is time to create a new Ruby Motion app for doing time zone conversions, run the following command in your terminal:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create TimeZoneConverter
</pre></div></div></div>
<div class="paragraph"><p>And then take a look inside</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>TimeZoneConverter

<span class="nv">$ </span>ls
</pre></div></div></div>
<div class="paragraph"><p>You will see the following directories created</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Rakefile app resources spec</code></pre>
</div></div>
<div class="paragraph"><p>Now feel free to execute the following command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>If everything goes well, you will see an ugly black window.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image1.png" alt="Empty Application" />
</div>
<div class="title">Figure 1. Empty Application</div>
</div>
<div class="sect2">
<h3 id="_view_controller">View Controller</h3>
<div class="paragraph"><p>A view controller class provides a quite utile mechanism to manage views in iOS applications; it could coordinate efforts with the model and other view controllers in order to build an entire application.</p></div>
</div>
<div class="sect2">
<h3 id="_adding_a_view_controller">Adding a View Controller</h3>
<div class="paragraph"><p>Open your file <strong>app_delegate.rb</strong> in app folder. And add the code between starts in it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

 <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>
    <span class="o">****************************************************************</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="no">RootViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
    <span class="o">****************************************************************</span>
    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now create a new file named <strong>root_view_controller.rb</strong> in app folder and add the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RootViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and run the rake command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>You should see a gray styled view, congratulations you have added your first View Controller, it wasn&#8217;t really that hard, was it?</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image2.png" alt="View Controller Added" />
</div>
<div class="title">Figure 2. View Controller Added</div>
</div>
<div class="paragraph"><p>It’s time to create our human interface controls, create a new file named <strong>root_view_uitilities.rb</strong> and add the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">location_label</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

  <span class="n">label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
  <span class="n">label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span><span class="p">;</span>
  <span class="n">label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-CondensedBold&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Time Zone&quot;</span>
  <span class="n">label</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">time_label</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

  <span class="n">label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
  <span class="n">label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span><span class="p">;</span>
  <span class="n">label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Time&quot;</span>
  <span class="n">label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span><span class="p">;</span>
  <span class="n">label</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">select_time_zone_Button</span> <span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

  <span class="n">button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">)</span>
  <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Select&quot;</span><span class="p">,</span><span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">button</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">zone_picker</span> <span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

  <span class="n">picker</span> <span class="o">=</span>  <span class="no">UIPickerView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">250</span><span class="p">))</span>
  <span class="n">picker</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">picker</span><span class="o">.</span><span class="n">showsSelectionIndicator</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">picker</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and compile the project to see if everything goes well, and then open the file <strong>root_view_controller.rb</strong> We are going to add our controls, add the code between the starts in it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RootViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

<span class="o">****************************************************************</span>
  <span class="k">def</span> <span class="nf">set_default_time_zone</span>

    <span class="vi">@defaultTimeZoneLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span>  <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">localTimeZone</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">set_default_time</span>

    <span class="n">defaultTimeZone</span> <span class="o">=</span> <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">timeZoneWithName</span><span class="p">(</span><span class="vi">@defaultTimeZoneLabel</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="no">NSDateFormatter</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">setDateFormat</span><span class="p">(</span><span class="s1">&#39;HH:mm&#39;</span><span class="p">)</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">setTimeZone</span><span class="p">(</span><span class="n">defaultTimeZone</span><span class="p">)</span>
    <span class="n">dateFormat</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">stringFromDate</span><span class="p">(</span><span class="no">NSDate</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="vi">@defaultTimeLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;UTC &quot;</span><span class="o">+</span><span class="p">(</span><span class="no">NSTimeZone</span><span class="o">.</span><span class="n">localTimeZone</span><span class="o">.</span><span class="n">secondsFromGMT</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="n">dateFormat</span>
  <span class="k">end</span>
<span class="o">****************************************************************</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>
<span class="o">****************************************************************</span>
    <span class="vi">@defaultTimeZoneLabel</span> <span class="o">=</span> <span class="n">location_label</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">120</span><span class="p">)</span>
    <span class="vi">@defaultTimeLabel</span> <span class="o">=</span> <span class="n">time_label</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span>

    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@defaultTimeZoneLabel</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@defaultTimeLabel</span><span class="p">)</span>

    <span class="n">set_default_time_zone</span>
    <span class="n">set_default_time</span>
<span class="o">****************************************************************</span>
    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your program and you should see two new labels added to the screen, the first one indicates the current timezone name, and the second one the current time.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image3.png" alt="Controls Added" />
</div>
<div class="title">Figure 3. Controls Added</div>
</div>
<div class="paragraph"><p>Let stop one moment right here, to see the properties of the "UILabel" that we just added, without exit hold ‘command’ key and hover mouse on simulator screen. You can see a red-bordered box appears among the application elements, select the first Time Zone area, the interactive console should display the instance corresponding to that label.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt;</code></pre>
</div></div>
<div class="paragraph"><p>And then explore the text property of the UILabel</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; self.text</code></pre>
</div></div>
<div class="paragraph"><p>It should return a string</p></div>
<div class="listingblock">
<div class="content">
<pre><code>=&gt; "America/Mexico_City"</code></pre>
</div></div>
<div class="paragraph"><p>Let&#8217;s say that we are extreme curious and we want to know the class of the "text" property from UILabel</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; self.text.class
=&gt; String</code></pre>
</div></div>
<div class="paragraph"><p>As we may expect its a String, but now what if we want to know the superclass of the "text" property from UILabel</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; self.text.superclass
=&gt; NSMutableString</code></pre>
</div></div>
<div class="paragraph"><p>Now what if we look for the "String" ancestors, type the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; String.ancestors</code></pre>
</div></div>
<div class="paragraph"><p>What are those classes that appears? Yes you are right those are from the Cocoa Framework</p></div>
<div class="listingblock">
<div class="content">
<pre><code>=&gt; [String, NSMutableString, NSString, Comparable, NSObject, Kernel]</code></pre>
</div></div>
<div class="paragraph"><p>We also can see the available methods, type the following in your terminal</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; methods</code></pre>
</div></div>
<div class="paragraph"><p>Well, you can see many of them, but yes we can use grep, to find something more specific</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9447e60&gt;)&gt; methods.grep(/class/)</code></pre>
</div></div>
<div class="paragraph"><p>If you want to return to the main session, you can enter the following command:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(#&lt;UILabel:0x9591580&gt;)&gt; quit</code></pre>
</div></div>
<div class="paragraph"><p>Type self, so you can be sure that you are in the main session:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; self
=&gt; main
(main)&gt;</code></pre>
</div></div>
<div class="paragraph"><p>So far we have discovered some interesting things, also we can find the instance variables of our RootViewController</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; RootViewController.instance_variables
=&gt; [:__classpath__]</code></pre>
</div></div>
<div class="paragraph"><p>And of course we can find out all the elements of the application</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; UIApplication.sharedApplication.keyWindow.rootViewController.view.subviews
=&gt; [#&lt;UILabel:0x95448e0&gt;, #&lt;UILabel:0x9544c30&gt;, #&lt;UIButton:0x9545110&gt;, #&lt;UILabel:0x9537eb0&gt;</code></pre>
</div></div>
<div class="paragraph"><p>and then recursive elements:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>(main)&gt; UIApplication.sharedApplication.keyWindow.recursiveDescription</code></pre>
</div></div>
<div class="paragraph"><p>You can use include of the arrays to ask if a method exists</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[].methods.include? :[]</code></pre>
</div></div>
<div class="paragraph"><p>And also to ask for and Objetive-C Method</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[].methods.include?(:'objectAtIndex:')</code></pre>
</div></div>
<div class="paragraph"><p>It’s time to add a control that let us select from different time zones, open the <strong>root_view_controller.rb</strong> and add the code the following code to it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RootViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">set_default_time_zone</span>

    <span class="vi">@defaultTimeZoneLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span>  <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">localTimeZone</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">set_default_time</span>

    <span class="n">defaultTimeZone</span> <span class="o">=</span> <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">timeZoneWithName</span><span class="p">(</span><span class="vi">@defaultTimeZoneLabel</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="no">NSDateFormatter</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">setDateFormat</span><span class="p">(</span><span class="s1">&#39;HH:mm&#39;</span><span class="p">)</span>
    <span class="n">formatter</span><span class="o">.</span><span class="n">setTimeZone</span><span class="p">(</span><span class="n">defaultTimeZone</span><span class="p">)</span>
    <span class="n">dateFormat</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">stringFromDate</span><span class="p">(</span><span class="no">NSDate</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="vi">@defaultTimeLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;UTC &quot;</span><span class="o">+</span><span class="p">(</span><span class="no">NSTimeZone</span><span class="o">.</span><span class="n">localTimeZone</span><span class="o">.</span><span class="n">secondsFromGMT</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s2">&quot;  &quot;</span><span class="o">+</span><span class="n">dateFormat</span>
  <span class="k">end</span>

 <span class="o">****************************************************************</span>
  <span class="k">def</span> <span class="nf">present_local_zone_picker</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

    <span class="n">button</span> <span class="o">=</span> <span class="n">sender</span>
    <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">244</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">216</span><span class="p">)</span>
    <span class="vi">@currentZoneLabel</span> <span class="o">=</span> <span class="vi">@defaultTimeZoneLabel</span>

    <span class="k">if</span> <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">isHidden</span>
      <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Choose&quot;</span><span class="p">,</span><span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Select&quot;</span><span class="p">,</span><span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
      <span class="n">set_default_time</span>
    <span class="k">end</span>
  <span class="k">end</span>


<span class="c1"># UIPicker View Controller DataSource</span>

  <span class="k">def</span> <span class="nf">numberOfComponentsInPickerView</span><span class="p">(</span><span class="n">pickerView</span><span class="p">)</span>

    <span class="mi">1</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">pickerView</span><span class="p">(</span><span class="n">pickerView</span><span class="p">,</span><span class="n">numberOfRowsInComponent</span><span class="ss">:component</span><span class="p">)</span>

    <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">knownTimeZoneNames</span><span class="o">.</span><span class="n">count</span>
  <span class="k">end</span>


<span class="c1"># UIPicker View Controller Delegate</span>

  <span class="k">def</span> <span class="nf">pickerView</span><span class="p">(</span><span class="n">pickerView</span><span class="p">,</span> <span class="n">titleForRow</span><span class="ss">:row</span><span class="p">,</span><span class="n">forComponent</span><span class="ss">:component</span><span class="p">)</span>

    <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">knownTimeZoneNames</span><span class="o">[</span><span class="n">row</span><span class="o">]</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">pickerView</span><span class="p">(</span><span class="n">pickerView</span><span class="p">,</span> <span class="n">didSelectRow</span><span class="ss">:row</span><span class="p">,</span> <span class="n">inComponent</span><span class="ss">:component</span><span class="p">)</span>

    <span class="vi">@currentZoneLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">NSTimeZone</span><span class="o">.</span><span class="n">knownTimeZoneNames</span><span class="o">[</span><span class="n">row</span><span class="o">]</span>
  <span class="k">end</span>


<span class="o">****************************************************************</span>
  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="vi">@defaultTimeZoneLabel</span> <span class="o">=</span> <span class="n">location_label</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">120</span><span class="p">)</span>
    <span class="vi">@defaultTimeLabel</span> <span class="o">=</span> <span class="n">time_label</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">150</span><span class="p">)</span>

<span class="o">****************************************************************</span>

    <span class="n">chooseLocalButton</span> <span class="o">=</span> <span class="n">select_time_zone_Button</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="mi">115</span><span class="p">)</span>
    <span class="n">chooseLocalButton</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                  <span class="n">action</span><span class="p">:</span> <span class="ss">:&#39;present_local_zone_picker:&#39;</span><span class="p">,</span>
                                  <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>

    <span class="vi">@zonePicker</span> <span class="o">=</span> <span class="n">zone_picker</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">244</span><span class="p">)</span>
    <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

<span class="o">****************************************************************</span>

    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@defaultTimeZoneLabel</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@defaultTimeLabel</span><span class="p">)</span>

<span class="o">****************************************************************</span>

    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">chooseLocalButton</span><span class="p">)</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@zonePicker</span><span class="p">)</span>

<span class="o">****************************************************************</span>
    <span class="n">set_default_time_zone</span>
    <span class="n">set_default_time</span>
    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next compile your application; you should see a white big button, don’t hesitate and try it.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image4.png" alt="UIPicker Added" />
</div>
<div class="title">Figure 4. UIPicker Added</div>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image5.png" alt="UIPicker Selected" />
</div>
<div class="title">Figure 5. UIPicker Added</div>
</div>
<div class="paragraph"><p>Go ahead and look for a region that you may like to be and see the local time on this area.</p></div>
<div class="paragraph"><p>You ‘ll never wonder again what time is it on other side of the planet, but you may think that its not good enough to know the time in one region, two its always better than one. Lets add a second set of controls.</p></div>
<div class="paragraph"><p>First at all open your <strong>root_view_uitilities.rb</strong> file and add the following code in the loadView method.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>
<span class="o">****************************************************************</span>

  <span class="n">chooseLocalButton</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">action</span><span class="o">::</span><span class="s1">&#39;present_local_zone_picker:&#39;</span><span class="p">,</span>
                                  <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="vi">@converTimeZoneLabel</span> <span class="o">=</span>  <span class="n">location_label</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">290</span><span class="p">)</span>
  <span class="vi">@convertTimeLabel</span> <span class="o">=</span> <span class="n">time_label</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">320</span><span class="p">)</span>
  <span class="n">chooseconvertButton</span> <span class="o">=</span> <span class="n">select_time_zone_Button</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span><span class="mi">300</span><span class="p">)</span>

  <span class="n">chooseconvertButton</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="ss">:&#39;present_convert_zone_picker:&#39;</span><span class="p">,</span>
                                                                <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@converTimeZoneLabel</span><span class="p">)</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@convertTimeLabel</span><span class="p">)</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">chooseconvertButton</span><span class="p">)</span>

<span class="o">****************************************************************</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Don’t forget to add the following method in the same file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">present_convert_zone_picker</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="n">button</span> <span class="o">=</span> <span class="n">sender</span>
  <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">216</span><span class="p">)</span>
  <span class="vi">@currentZoneLabel</span> <span class="o">=</span> <span class="vi">@converTimeZoneLabel</span>

  <span class="k">if</span> <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">isHidden</span>

    <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Choose&quot;</span><span class="p">,</span><span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>

  <span class="k">else</span>

    <span class="vi">@zonePicker</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Select&quot;</span><span class="p">,</span><span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
    <span class="n">set_Convert_Time</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_styling_the_app">Styling the App</h3>
<div class="paragraph"><p>I think that the style of our application does not reflect the adventure spirit that should be; maybe with some little improvements we can change that.</p></div>
<div class="paragraph"><p>Run the application with the rake command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>Now you should see REPL in your console:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>Create ./build/iPhoneSimulator-6.0-Development/TimeZoneConverter.dSYM
Simulate ./build/iPhoneSimulator-6.0-Development/TimeZoneConverter.app
<span class="o">(</span>main<span class="o">)</span>&gt;
</pre></div></div></div>
<div class="paragraph"><p>Now hold ‘command’ key and hover mouse on simulator screen. You can see a red-bordered box appears among the application elements, select the first Time Zone area, the interactive console should display the instance corresponding to that label</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>Build ./build/iPhoneSimulator-6.0-Development
Simulate ./build/iPhoneSimulator-6.0-Development/TimeZoneConverter.app
<span class="o">(</span><span class="c">#&lt;UILabel:0x956a650&gt;)&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Now its time to add something fresh to our application as we see it running, yes you read right type the following scrip in you REPL:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;Noteworthy-Bold&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image6.png" alt="UIPicker Added" />
</div>
<div class="title">Figure 6. UIPicker Added</div>
</div>
<div class="paragraph"><p>and hit enter, and Voila !! the font has changed, but you may not liked, so try with different fonts and sizes here there are some of them:</p></div>
<div class="ulist"><ul>
<li>
<p>
Georgia-Italic
</p>
</li>
<li>
<p>
MarkerFelt-Thin
</p>
</li>
<li>
<p>
HelveticaNeue-Medium
</p>
</li>
</ul></div>
<div class="paragraph"><p>Since the creation of the apple store the are many app to choose from, the app store it’s not the wild wild west that used to be, so we are going to give some personality to our app</p></div>
<div class="paragraph"><p>First, copy the assets from the chapter one directory, and put them into the Resources directory, and the in your <strong>root_view_controller.rb</strong> change the following line in your <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">scrollViewTexturedBackgroundColor</span>
</pre></div></div></div>
<div class="paragraph"><p>for this one:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithPatternImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgApp.png&quot;</span><span class="p">))</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch02-FirstApplication/image7.png" alt="Stylish App" />
</div>
<div class="title">Figure 7. Stylish App</div>
</div>
<div class="paragraph"><p>We should add some personality to our buttons, open your file <strong>root_view_uitilities.rb</strong> and replace the following method <strong>select_time_zone_Button</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">select_time_zone_Button</span> <span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">)</span>

  <span class="n">button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeCustom</span><span class="p">)</span>
  <span class="n">button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="n">xPosition</span><span class="p">,</span><span class="n">yPosition</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">73</span><span class="p">)</span>
  <span class="n">button</span><span class="o">.</span><span class="n">setBackgroundImage</span> <span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnSelect.png&quot;</span><span class="p">),</span><span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Select&quot;</span><span class="p">,</span><span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">button</span>
<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_challenge_adding_a_title">Challenge - Adding a title</h3>
<div class="paragraph"><p>Adding title to the application, try adding a new method in your file <strong>select_time_zone_Button</strong> that return an UILabel and put it as title for the application.</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_hours_between_zones">Challenge - Hours Between Zones</h3>
<div class="paragraph"><p>Add a new label between time zones that indicates the diference between time zones</p></div>
</div>
</div>
</div>
<h1 id="_chapter_03_objective_c">Chapter 03 - Objective C</h1>
<div class="sect1">
<h2 id="_estimator_app">Estimator App</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this exercise we will create an iOS app that exemplify the way many companies in the world estimate their projects, the "Estimator"</p></div>
<div class="sect2">
<h3 id="_create_project">Create Project</h3>
<div class="paragraph"><p>As a first step we will need to create a project, open your terminal application and run the following command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create estimator
</pre></div></div></div>
<div class="paragraph"><p>If we look at the new folder "Estimator", we will find a couple of new folders: "app", "resources", "spec".</p></div>
<div class="paragraph"><p>Next, lets copy our application images from <strong>(define deploy route)</strong> into the resources folder</p></div>
</div>
<div class="sect2">
<h3 id="_first_run">First Run</h3>
<div class="paragraph"><p>Just to make sure that everything is fine, we can test our new created project by executing the following line</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>estimator

<span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>This command will compile the project and run it on the simulator, like the following image:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/FirstRun.png" alt="First Run" />
</div>
<div class="title">Figure 8. First Run</div>
</div>
</div>
<div class="sect2">
<h3 id="_project_view_controller">Project View Controller</h3>
<div class="paragraph"><p>Let&#8217;s start coding our project, first we need to create a new file that will contain our Project View Controller Class</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch project_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Let&#8217;s open it, and add the following lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open project_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ProjectViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">redColor</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next we need to open the "AppDelegate" of the app, and load our controller into the UIWindow. This is done by inserting the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

  <span class="c1">#Create an instance of Project View Controller</span>
  <span class="n">project_view_controller</span> <span class="o">=</span> <span class="no">ProjectViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1">#Every window has a root view controller from which it will present its view</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">project_view_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>

  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>This part will load a new instance of our Project View Controller and insert its view into the UIWindow. Please note that the UIWindow receives a controller as rootViewController, instead of a view.</p></div>
<div class="paragraph"><p>If we run the project it should look like the following image:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/ProjectViewController.png" alt="Project View Controller" />
</div>
<div class="title">Figure 9. Project View Controller</div>
</div>
</div>
<div class="sect2">
<h3 id="_project_view">Project View</h3>
<div class="paragraph"><p>Next we need to add some controls for the user to select the number of screens of the project, complexity, methodology, etc. For this is required to add the following method to the project_view_controller.rb file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layout_view</span>

  <span class="c1"># Initialize a new view for the controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">902</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">902</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">902</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

  <span class="c1"># The following is an initialization and add of controls into the view</span>


  <span class="c1"># First create an instance of UIImageView, this control will present an Image into the view</span>
  <span class="c1"># for this case a black header</span>
  <span class="vi">@header_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
  <span class="vi">@header_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgHeader.png&quot;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@header_image_view</span><span class="p">)</span>


  <span class="c1"># Next we create an instance of UILabel, tellling it the position on the screen that</span>
  <span class="c1"># we want it to be drawn. For this we use a c struct called CGFrame</span>
  <span class="vi">@title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Project Estimator&quot;</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="c1"># To specify a custom Font we need to tell the proper name of it and the size that we want</span>
  <span class="vi">@title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">25</span><span class="p">)</span>

  <span class="c1"># Then we add it to the view like this way</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@title_label</span><span class="p">)</span>


  <span class="vi">@number_of_screens_text_field</span> <span class="o">=</span> <span class="no">UITextField</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="no">UITextBorderStyleRoundedRect</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">keyboardType</span> <span class="o">=</span> <span class="no">UIKeyboardTypeNumbersAndPunctuation</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTextField.png&quot;</span><span class="p">)</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="no">UITextBorderStyleNone</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s2">&quot;Number of Screens&quot;</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">451</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">451</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">451</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-DemiBold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">25</span><span class="p">)</span>
  <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">contentVerticalAlignment</span> <span class="o">=</span> <span class="no">UIControlContentVerticalAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@number_of_screens_text_field</span><span class="p">)</span>


  <span class="vi">@complexity_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Complexity&quot;</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-DemiBold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
  <span class="vi">@complexity_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@complexity_label</span><span class="p">)</span>


  <span class="c1"># For the UISegmentedControl to work, we need to pass him the possible values</span>
  <span class="c1"># in this case a NSArray do the trick</span>
  <span class="vi">@complexity_values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@complexity_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Low&quot;</span><span class="p">)</span>
  <span class="vi">@complexity_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;High&quot;</span><span class="p">)</span>

  <span class="c1"># We create an instance of a UISegmentedControl, setting the allowed values for it</span>
  <span class="vi">@complexity_segmented_control</span> <span class="o">=</span> <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithItems</span><span class="p">(</span><span class="vi">@complexity_values</span><span class="p">)</span>
  <span class="vi">@complexity_segmented_control</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>


  <span class="c1"># Its not required to set a selected index, but for this example we select the first segment</span>
  <span class="vi">@complexity_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@complexity_segmented_control</span><span class="p">)</span>


  <span class="vi">@outsourced_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Outsourced&quot;</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-DemiBold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
  <span class="vi">@outsourced_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@outsourced_label</span><span class="p">)</span>


  <span class="vi">@outsourced_values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@outsourced_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;No&quot;</span><span class="p">)</span>
  <span class="vi">@outsourced_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span><span class="p">)</span>

  <span class="vi">@outsourced_segmented_control</span> <span class="o">=</span> <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithItems</span><span class="p">(</span><span class="vi">@outsourced_values</span><span class="p">)</span>
  <span class="vi">@outsourced_segmented_control</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
  <span class="vi">@outsourced_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@outsourced_segmented_control</span><span class="p">)</span>


  <span class="vi">@methodology_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Methodology&quot;</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">400</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-DemiBold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">20</span><span class="p">)</span>
  <span class="vi">@methodology_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@methodology_label</span><span class="p">)</span>


  <span class="vi">@methodology_values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@methodology_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Waterfall&quot;</span><span class="p">)</span>
  <span class="vi">@methodology_values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="s2">&quot;Agile&quot;</span><span class="p">)</span>

  <span class="vi">@methodology_segmented_control</span> <span class="o">=</span> <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithItems</span><span class="p">(</span><span class="vi">@methodology_values</span><span class="p">)</span>
  <span class="vi">@methodology_segmented_control</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
  <span class="vi">@methodology_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@methodology_segmented_control</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Also for this to work, we need to change the loadView method to look as the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="n">layout_view</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Let&#8217;s run the application:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/ProjectView.png" alt="Project View" />
</div>
<div class="title">Figure 10. Project View</div>
</div>
<div class="paragraph"><p>The segmented controls does not look that pretty right?, lets customize their apperance adding the following method to the project_view_controller.rb file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method to customize the appearance of the UISegmentedControl</span>
<span class="k">def</span> <span class="nf">customize_segmented_control</span>

  <span class="c1"># Lets load the images from their respective files</span>
  <span class="n">segmented_control_normal_background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgSegmentedControlNormal.png&quot;</span><span class="p">)</span>
  <span class="n">segmented_control_selected_background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgSegmentedControlSelected.png&quot;</span><span class="p">)</span>
  <span class="n">segmented_control_separator</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgSegmentedControlSeparator.png&quot;</span><span class="p">)</span>


  <span class="c1"># Apply the image for the background when the segment is not selected</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="n">segmented_control_normal_background</span><span class="p">,</span>
                                                   <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">,</span>
                                                   <span class="n">barMetrics</span><span class="p">:</span> <span class="no">UIBarMetricsDefault</span><span class="p">)</span>

  <span class="c1"># Apply the image for the background when the segment is selected</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="n">segmented_control_selected_background</span><span class="p">,</span>
                                                   <span class="n">forState</span><span class="ss">:UIControlStateSelected</span><span class="p">,</span>
                                                   <span class="n">barMetrics</span><span class="p">:</span> <span class="no">UIBarMetricsDefault</span><span class="p">)</span>


  <span class="c1"># Apply the image for the divider of the control</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setDividerImage</span><span class="p">(</span><span class="n">segmented_control_separator</span><span class="p">,</span>
                                                <span class="n">forLeftSegmentState</span><span class="p">:</span> <span class="no">UIControlStateNormal</span><span class="p">,</span>
                                                <span class="n">rightSegmentState</span><span class="ss">:UIControlStateSelected</span><span class="p">,</span>
                                                <span class="n">barMetrics</span><span class="ss">:UIBarMetricsDefault</span><span class="p">)</span>



  <span class="c1"># Also we need to change the font of the titles, the first step is to load the font into the memory</span>
  <span class="n">segmented_control_title_font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>


  <span class="c1"># To apply certain visual attributes to Apple&#39;s default controls, we need to use a iOS 5 technology</span>
  <span class="c1"># called Skins. To work with screens we must create a dictionary with the key of the property we want</span>
  <span class="c1"># to change and the proper value</span>
  <span class="n">normal_title_text_attributes</span> <span class="o">=</span> <span class="no">NSMutableDictionary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">normal_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">segmented_control_title_font</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:UITextAttributeFont</span><span class="p">)</span>

  <span class="n">normal_title_text_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">545</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">749</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">349</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">normal_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">normal_title_text_color</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="no">UITextAttributeTextColor</span><span class="p">)</span>

  <span class="n">normal_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="no">UITextAttributeTextShadowColor</span><span class="p">)</span>

  <span class="c1"># Using Skins you can change the visual properties of all the same kind of controls at the same time,</span>
  <span class="c1"># no matter if they were created on another class or in another excecution time. To archive this</span>
  <span class="c1"># only send the messages to the class</span>
  <span class="c1">#</span>
  <span class="c1"># On the other side if you want only to modify one particular control, the following like will work</span>
  <span class="c1"># on the instance instead of the class</span>
  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setTitleTextAttributes</span><span class="p">(</span><span class="n">normal_title_text_attributes</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>



  <span class="n">selected_title_text_attributes</span> <span class="o">=</span> <span class="no">NSMutableDictionary</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">selected_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">segmented_control_title_font</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:UITextAttributeFont</span><span class="p">)</span>

  <span class="n">selected_title_text_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">200</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">200</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">200</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">selected_title_text_attributes</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">selected_title_text_color</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:UITextAttributeTextColor</span><span class="p">)</span>

  <span class="no">UISegmentedControl</span><span class="o">.</span><span class="n">appearance</span><span class="o">.</span><span class="n">setTitleTextAttributes</span><span class="p">(</span><span class="n">selected_title_text_attributes</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateSelected</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And also we will need to change our loadView method again, lo look like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="n">customize_segmented_control</span>
  <span class="n">layout_view</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>This time, if we run the application you should see the following in your simulator:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/ProjectViewWithCustomSegmentedControls.png" alt="Project View with Custom Segmented Controls" />
</div>
<div class="title">Figure 11. Project View with Custom Segmented Controls</div>
</div>
</div>
<div class="sect2">
<h3 id="_project_model">Project Model</h3>
<div class="paragraph"><p>First create a JSON file to contain all the estimated historical data (Fake one ;):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>cd..

<span class="nv">$ </span><span class="nb">cd </span>resources

<span class="nv">$ </span>touch historical_data.json
</pre></div></div></div>
<div class="paragraph"><p>Then add the following line to the file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open historical_data.json
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;Complexity&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;Low&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>

    <span class="nt">&quot;High&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">20</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nt">&quot;Outsourced&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;No&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">},</span>

    <span class="nt">&quot;Yes&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">7</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nt">&quot;Methodology&quot;</span><span class="p">:</span>
  <span class="p">{</span>
    <span class="nt">&quot;Waterfall&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">15</span>
    <span class="p">},</span>

    <span class="nt">&quot;Agile&quot;</span><span class="p">:</span>
    <span class="p">{</span>
      <span class="nt">&quot;TotalEffort&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
      <span class="nt">&quot;Variation&quot;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we need a object that make the estimation calculus, this object will be called "Project", let&#8217;s create the file that will contain it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>mkdir models

<span class="nv">$ </span><span class="nb">cd </span>models

<span class="nv">$ </span>touch project.rb
</pre></div></div></div>
<div class="paragraph"><p>Add the next lines to it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project</span>

  <span class="c1">#Constants representing Keys in the JSON</span>
  <span class="no">COMPLEXITY_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Complexity&#39;</span>
  <span class="no">OUTSOURCED_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Outsourced&#39;</span>
  <span class="no">METHODOLOGY_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Methodology&#39;</span>
  <span class="no">TOTAL_EFFORT_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;TotalEffort&#39;</span>
  <span class="no">VARIATION_DATA_KEY</span> <span class="o">=</span> <span class="s1">&#39;Variation&#39;</span>

  <span class="kp">attr_accessor</span> <span class="ss">:number_of_screens</span>
  <span class="kp">attr_accessor</span> <span class="ss">:complexity</span>
  <span class="kp">attr_accessor</span> <span class="ss">:outsourced</span>
  <span class="kp">attr_accessor</span> <span class="ss">:methodology</span>

  <span class="kp">attr_reader</span> <span class="ss">:total_effort</span>
  <span class="kp">attr_reader</span> <span class="ss">:variation</span>
  <span class="kp">attr_reader</span> <span class="ss">:delivery_year</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great!, Now we need to add the logic to read our JSON File, insert the following method in the class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_historical_estimates</span>

  <span class="c1"># Get the path of our JSON File inside the bundle</span>
  <span class="n">historical_data_file</span>  <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">pathForResource</span><span class="p">(</span><span class="s1">&#39;historical_data&#39;</span><span class="p">,</span> <span class="n">ofType</span><span class="ss">:&#39;json&#39;</span><span class="p">)</span>

  <span class="c1"># For us to load the file, we need to pass a pointer. So if something goes wrong we can print</span>
  <span class="c1"># the error</span>
  <span class="n">error_pointer</span> <span class="o">=</span> <span class="no">Pointer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:object</span><span class="p">)</span>

  <span class="c1"># Lets load the file into a NSData</span>
  <span class="n">historical_data</span> <span class="o">=</span> <span class="no">NSData</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithContentsOfFile</span><span class="p">(</span><span class="n">historical_data_file</span><span class="p">,</span>                                                                   <span class="n">options</span><span class="ss">:NSDataReadingUncached</span><span class="p">,</span>
                                                <span class="n">error</span><span class="ss">:error_pointer</span><span class="p">)</span>

  <span class="k">unless</span> <span class="n">historical_data</span>

    <span class="k">if</span> <span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">code</span> <span class="o">==</span> <span class="no">NSFileReadNoSuchFileError</span>

      <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Error: Missing File Error&quot;</span>

    <span class="k">else</span>

      <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Error: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">end</span>

    <span class="k">return</span> <span class="kp">nil</span>

  <span class="k">end</span>


  <span class="c1"># Serialize the NSData into something we can work with, in this case a Hash</span>
  <span class="n">historical_estimates</span> <span class="o">=</span> <span class="no">NSJSONSerialization</span><span class="o">.</span><span class="n">JSONObjectWithData</span><span class="p">(</span><span class="n">historical_data</span><span class="p">,</span>
                                                                  <span class="n">options</span><span class="p">:</span> <span class="no">NSDataReadingUncached</span><span class="p">,</span>
                                                                  <span class="n">error</span><span class="p">:</span> <span class="n">error_pointer</span><span class="p">)</span>

  <span class="k">unless</span> <span class="n">historical_estimates</span>

    <span class="vg">$stderr</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;Error: </span><span class="si">#{</span><span class="n">error_pointer</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="kp">nil</span>
  <span class="k">end</span>


  <span class="n">historical_estimates</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we have read our JSON file, the next thing is to extract the historical data into something we can use to make the calculus. This following methods should be added to the class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">obtain_historical_complexity</span>

  <span class="vi">@complexity_total_effort</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@complexity_variation</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">historical_complexity</span> <span class="o">=</span> <span class="vi">@historical_estimates</span><span class="o">[</span><span class="no">COMPLEXITY_DATA_KEY</span><span class="o">]</span>

  <span class="c1"># We use the user selection as a Key</span>
  <span class="k">unless</span> <span class="n">historical_complexity</span><span class="o">[</span><span class="vi">@complexity</span><span class="o">].</span><span class="n">nil?</span>

    <span class="n">selected_historical_complexity</span> <span class="o">=</span> <span class="n">historical_complexity</span><span class="o">[</span><span class="vi">@complexity</span><span class="o">]</span>

    <span class="vi">@complexity_total_effort</span> <span class="o">=</span> <span class="n">selected_historical_complexity</span><span class="o">[</span><span class="no">TOTAL_EFFORT_DATA_KEY</span><span class="o">]</span>
    <span class="vi">@complexity_variation</span> <span class="o">=</span> <span class="n">selected_historical_complexity</span><span class="o">[</span><span class="no">VARIATION_DATA_KEY</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">obtain_historical_outsourced</span>

  <span class="vi">@outsourced_total_effort</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@outsourced_variation</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">historical_outsourced</span> <span class="o">=</span> <span class="vi">@historical_estimates</span><span class="o">[</span><span class="no">OUTSOURCED_DATA_KEY</span><span class="o">]</span>

  <span class="c1"># We use the user selection as a Key</span>
  <span class="k">unless</span> <span class="n">historical_outsourced</span><span class="o">[</span><span class="vi">@outsourced</span><span class="o">].</span><span class="n">nil?</span>

    <span class="n">selected_historical_outsourced</span> <span class="o">=</span> <span class="n">historical_outsourced</span><span class="o">[</span><span class="vi">@outsourced</span><span class="o">]</span>

    <span class="vi">@outsourced_total_effort</span> <span class="o">=</span> <span class="n">selected_historical_outsourced</span><span class="o">[</span><span class="no">TOTAL_EFFORT_DATA_KEY</span><span class="o">]</span>
    <span class="vi">@outsourced_variation</span> <span class="o">=</span> <span class="n">selected_historical_outsourced</span><span class="o">[</span><span class="no">VARIATION_DATA_KEY</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">obtain_historical_methodology</span>

  <span class="vi">@methodology_total_effort</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@methodology_variation</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">historical_methodology</span> <span class="o">=</span> <span class="vi">@historical_estimates</span><span class="o">[</span><span class="no">METHODOLOGY_DATA_KEY</span><span class="o">]</span>

  <span class="c1"># We use the user selection as a Key</span>
  <span class="k">unless</span> <span class="n">historical_methodology</span><span class="o">[</span><span class="vi">@methodology</span><span class="o">].</span><span class="n">nil?</span>

    <span class="n">selected_historical_methodology</span> <span class="o">=</span> <span class="n">historical_methodology</span><span class="o">[</span><span class="vi">@methodology</span><span class="o">]</span>

    <span class="vi">@methodology_total_effort</span> <span class="o">=</span> <span class="n">selected_historical_methodology</span><span class="o">[</span><span class="no">TOTAL_EFFORT_DATA_KEY</span><span class="o">]</span>
    <span class="vi">@methodology_variation</span> <span class="o">=</span> <span class="n">selected_historical_methodology</span><span class="o">[</span><span class="no">VARIATION_DATA_KEY</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Almost there! Lets add the algorithm to make the calculus, inserting the following methods:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">calculate_total_effort</span>

  <span class="c1"># We add all the possible total effort that the user selected</span>
  <span class="n">total_effort_data</span> <span class="o">=</span> <span class="vi">@complexity_total_effort</span> <span class="o">+</span> <span class="vi">@outsourced_total_effort</span> <span class="o">+</span> <span class="vi">@methodology_total_effort</span>

  <span class="c1"># Generate a random with the minimum value of a half of the total effort</span>
  <span class="n">total_effort</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="n">total_effort_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">total_effort_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

  <span class="c1"># Calculate the effort plus the number of screens as percentage</span>
  <span class="n">total_effort</span> <span class="o">*</span> <span class="p">((</span><span class="vi">@number_of_screens</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">calculate_variation</span>

  <span class="c1"># We add all the possible variation that the user selected</span>
  <span class="n">variation_data</span> <span class="o">=</span> <span class="vi">@complexity_variation</span> <span class="o">+</span> <span class="vi">@outsourced_variation</span> <span class="o">+</span> <span class="vi">@methodology_variation</span>

  <span class="nb">rand</span><span class="p">(</span><span class="n">variation_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">variation_data</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">calculate_delivery_year</span>

  <span class="c1"># Calculate the total effort plus the posible variation</span>
  <span class="n">total_effort_with_variation</span> <span class="o">=</span> <span class="vi">@total_effort</span> <span class="o">*</span> <span class="p">(</span><span class="vi">@variation</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

  <span class="c1"># Transform the hours into working weeks</span>
  <span class="n">total_effort_days</span> <span class="o">=</span> <span class="n">total_effort_with_variation</span> <span class="o">/</span> <span class="mi">8</span>
  <span class="n">total_effort_weeks</span> <span class="o">=</span> <span class="n">total_effort_days</span> <span class="o">/</span> <span class="mi">5</span>


  <span class="c1"># In the following part we add the calculated weeks to the current date</span>
  <span class="n">weekComponent</span> <span class="o">=</span> <span class="no">NSDateComponents</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">weekComponent</span><span class="o">.</span><span class="n">week</span> <span class="o">=</span> <span class="n">total_effort_weeks</span>

  <span class="n">calendar</span> <span class="o">=</span> <span class="no">NSCalendar</span><span class="o">.</span><span class="n">currentCalendar</span>

  <span class="n">delivery_date</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">dateByAddingComponents</span><span class="p">(</span><span class="n">weekComponent</span><span class="p">,</span>
                                                     <span class="n">toDate</span><span class="p">:</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                                                     <span class="n">options</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>


  <span class="c1"># Of the resulting date we only need the year, in the following section is extracted</span>
  <span class="n">yearComponent</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">components</span><span class="p">(</span><span class="no">NSYearCalendarUnit</span><span class="p">,</span> <span class="n">fromDate</span><span class="p">:</span> <span class="n">delivery_date</span><span class="p">)</span>

  <span class="n">yearComponent</span><span class="o">.</span><span class="n">year</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Last part! A method that will execute the calculus, this method will be called by the Project View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">estimate</span>

  <span class="vi">@historical_estimates</span> <span class="o">=</span> <span class="n">load_historical_estimates</span>


  <span class="n">obtain_historical_complexity</span>
  <span class="n">obtain_historical_outsourced</span>
  <span class="n">obtain_historical_methodology</span>


  <span class="vi">@total_effort</span> <span class="o">=</span>  <span class="n">calculate_total_effort</span>
  <span class="vi">@variation</span> <span class="o">=</span> <span class="n">calculate_variation</span>
  <span class="vi">@delivery_year</span> <span class="o">=</span> <span class="n">calculate_delivery_year</span>

<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_project_view_controller_and_project_model">Project View Controller and Project Model</h3>
<div class="paragraph"><p>We need to add a button to execute the estimation process, insert this lines on the button of the <em>layout_view</em> method, in the project_view_controller.rb file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>open project_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="c1"># This control initialization is radically different from the other ones, this is because</span>
<span class="c1"># UIButton provides different types and styles of buttons. The default one is Rounded Rect</span>
<span class="vi">@estimate_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
<span class="vi">@estimate_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

<span class="c1"># Sometimes when we work with controls we can change the title or image based on different states of</span>
<span class="c1"># it. (Normal, Selected, Highlighted)</span>
<span class="vi">@estimate_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnEstimate.png&quot;</span><span class="p">),</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
<span class="c1">#@estimate_button.setTitle(&quot;Estimate this project&quot;, forState: UIControlStateNormal)</span>

<span class="c1"># Lets tell the button who is going to call and where, when the user touch it</span>
<span class="vi">@estimate_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                           <span class="n">action</span><span class="p">:</span> <span class="s2">&quot;estimate_project:&quot;</span><span class="p">,</span>
                           <span class="n">forControlEvents</span><span class="p">:</span> <span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>

<span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@estimate_button</span><span class="p">)</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">The method is called estimate_project:, with the two dots</td>
</tr></table>
</div>
<div class="paragraph"><p>Please pay special attention to the <em>addTarget</em> method, this is used to tell the button who and in which method it should call when the user touches it. In this case we are telling it to call the Project View Controller in the method "estimate_project:", lets add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">estimate_project</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

  <span class="c1"># Create a new instance of Project</span>
  <span class="n">project</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">new</span>

  <span class="n">project</span><span class="o">.</span><span class="n">number_of_screens</span> <span class="o">=</span> <span class="vi">@number_of_screens_text_field</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">intValue</span>


  <span class="c1"># We need the selected index to extract the string value from the segmented allowed</span>
  <span class="c1"># values array</span>
  <span class="n">selected_complexity_index</span> <span class="o">=</span> <span class="vi">@complexity_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span>
  <span class="n">project</span><span class="o">.</span><span class="n">complexity</span> <span class="o">=</span> <span class="vi">@complexity_values</span><span class="o">.</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="n">selected_complexity_index</span><span class="p">)</span>


  <span class="n">selected_outsourced_index</span> <span class="o">=</span> <span class="vi">@outsourced_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span>
  <span class="n">project</span><span class="o">.</span><span class="n">outsourced</span> <span class="o">=</span> <span class="vi">@outsourced_values</span><span class="o">.</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="n">selected_outsourced_index</span><span class="p">)</span>


  <span class="n">selected_methodology_index</span> <span class="o">=</span> <span class="vi">@methodology_segmented_control</span><span class="o">.</span><span class="n">selectedSegmentIndex</span>
  <span class="n">project</span><span class="o">.</span><span class="n">methodology</span> <span class="o">=</span> <span class="vi">@methodology_values</span><span class="o">.</span><span class="n">objectAtIndex</span><span class="p">(</span><span class="n">selected_methodology_index</span><span class="p">)</span>


  <span class="n">project</span><span class="o">.</span><span class="n">estimate</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In this method we implement the creation of a new Project instance, setting the user input and finally we ask it to calculate the estimation</p></div>
</div>
<div class="sect2">
<h3 id="_estimation_view_controller">Estimation View Controller</h3>
<div class="paragraph"><p>Now we need to add some place to show our calculated values, for this we need to create a new view controller called "Estimation View Controller":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>touch estimation_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Add the following lines to the "estimation_view_controller.rb":</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EstimationViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="n">layout_view</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">layout_view</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">298</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">298</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">298</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

    <span class="vi">@header_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
    <span class="vi">@header_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgHeader.png&quot;</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@header_image_view</span><span class="p">)</span>


    <span class="vi">@title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Estimation&quot;</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNext-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">25</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@title_label</span><span class="p">)</span>


    <span class="vi">@total_effort_title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Total effort&quot;</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@total_effort_title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-DemiBold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">35</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@total_effort_title_label</span><span class="p">)</span>


    <span class="vi">@total_effort_value_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">180</span><span class="p">))</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">120</span><span class="p">)</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">minimumFontSize</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">adjustsFontSizeToFitWidth</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@total_effort_value_label</span><span class="p">)</span>


    <span class="vi">@total_effort_unit_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;HRS&quot;</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">671</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">353</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@total_effort_unit_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">72</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@total_effort_unit_label</span><span class="p">)</span>


    <span class="vi">@variation_title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Variation&quot;</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@variation_title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@variation_title_label</span><span class="p">)</span>


    <span class="vi">@variation_value_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">85</span><span class="p">))</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;52&quot;</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">80</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@variation_value_label</span><span class="p">)</span>


    <span class="vi">@variation_unit_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">310</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">671</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">353</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@variation_unit_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@variation_unit_label</span><span class="p">)</span>


    <span class="vi">@delivery_year_title_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">370</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">40</span><span class="p">))</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Delivery year&quot;</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">702</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="mo">000</span><span class="p">)</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@delivery_year_title_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">30</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@delivery_year_title_label</span><span class="p">)</span>


    <span class="vi">@delivery_year_value_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">CGRectMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;2040&quot;</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentRight</span>
    <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AvenirNextCondensed-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="mi">50</span><span class="p">)</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@delivery_year_value_label</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We just implement the logic for our new view controller, also we add some labels to draw on the screen the values generated by the Project estimation</p></div>
</div>
<div class="sect2">
<h3 id="_estimation_view_controller_and_project_model">Estimation View Controller and Project Model</h3>
<div class="paragraph"><p>The last part of our implementation is to add a way to bind the values of the Project Model into our labels, the following method does the trick (Insert it on the estimation_view_controller.rb):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method to bind the values in the Project Object into proper UILabels</span>
<span class="k">def</span> <span class="nf">bind_project</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

  <span class="c1">#Using an NSString we set the text into the label, when we are using %@ we tell the object</span>
  <span class="c1">#to print it description as a string</span>
  <span class="vi">@total_effort_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">NSString</span><span class="o">.</span><span class="n">stringWithFormat</span><span class="p">(</span><span class="s2">&quot;%@&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">.</span><span class="n">total_effort</span><span class="p">)</span>

  <span class="vi">@variation_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">NSString</span><span class="o">.</span><span class="n">stringWithFormat</span><span class="p">(</span><span class="s2">&quot;%@&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">.</span><span class="n">variation</span><span class="p">)</span>

  <span class="vi">@delivery_year_value_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">NSString</span><span class="o">.</span><span class="n">stringWithFormat</span><span class="p">(</span><span class="s2">&quot;%@&quot;</span><span class="p">,</span> <span class="n">project</span><span class="o">.</span><span class="n">delivery_year</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take note that in this specific case we are using Objective-C strings (NSStrings) instead of ruby strings</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_project_view_controller_and_estimation_view_controller">Project View Controller and Estimation View Controller</h3>
<div class="paragraph"><p>Final task! We need to show our new controller, the way to do this is to perform a transition from the Project View Controller to the Estimation View Controller</p></div>
<div class="paragraph"><p>Insert the following lines into the estimate_project(sender) method on the class project_view_controller.rb:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Now we need a new instance of the Estimation View Controller for show the</span>
<span class="c1"># results of the Project estimation</span>
<span class="vi">@estimation_view_controller</span> <span class="o">=</span> <span class="no">EstimationViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

<span class="vi">@estimation_view_controller</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span>

<span class="c1"># Lets tell it to bind our project instance</span>
<span class="vi">@estimation_view_controller</span><span class="o">.</span><span class="n">bind_project</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>


<span class="c1"># To show the Estimation View Controller view, we can use a transition.</span>
<span class="c1"># From our current view, to the Estimation View Controller&#39;s view</span>
<span class="no">UIView</span><span class="o">.</span><span class="n">transitionFromView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">,</span>
                          <span class="n">toView</span><span class="p">:</span> <span class="vi">@estimation_view_controller</span><span class="o">.</span><span class="n">view</span><span class="p">,</span>
                          <span class="n">duration</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">options</span><span class="p">:</span> <span class="no">UIViewAnimationOptionTransitionFlipFromLeft</span><span class="p">,</span>
                          <span class="n">completion</span><span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_run_and_enjoy">Run and Enjoy</h3>
<div class="paragraph"><p>Lets run our estimator app!</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/FinishedProjectViewController.png" alt="Finished Project View Controller" />
</div>
<div class="title">Figure 12. Finished Project View Controller</div>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/ch03-ObjectiveC/FinishedEstimationViewController.png" alt="Finished Estimation View Controller" />
</div>
<div class="title">Figure 13. Finished Estimation View Controller</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenges">Challenges</h3>
<div class="paragraph"><p>1.- The UISegmentedControlls in the project_view_controller.rb are bound to a static array, move that logic to the Project Model. So it can provide the allowed values for the estimation.</p></div>
<div class="paragraph"><p>2.- Now that the allowed values are in the Project Model, lets make it dynamic by retrieving them from the JSON File.</p></div>
</div>
</div>
</div>
<h1 id="_chapter_05_cocoa_overview">Chapter 05 - Cocoa Overview</h1>
<div class="sect1">
<h2 id="_the_cocoaheads_app">The Cocoaheads app</h2>
<div class="sectionbody">
<div class="paragraph"><p>Cocoaheads is a community of OSX/iOS programmers. There are many Cocoaheads communities around the world and they meet periodically (normally on a monthly basis) to discuss the latest topics for Apple-related technologies.</p></div>
<div class="paragraph"><p>We want to build an iPhone app for this community. The app should cover the next functionality:</p></div>
<div class="ulist"><ul>
<li>
<p>
Show the complete schedule for the next Cocoaheads meetings.
</p>
</li>
<li>
<p>
Show the information about the next meeting. This information could include the map to the venue, the list of the talks, etc.
</p>
</li>
<li>
<p>
Registration and login of users.
</p>
</li>
<li>
<p>
Allow users to register for the next meeting.
</p>
</li>
</ul></div>
<div class="paragraph"><p>We are going to build this app for several chapters, one step a time. In this chapter we are going to focus in creating the first screen: the Next Event screen that shows the information related to the next meeting:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_01_app.png" alt="Chapter 5 app" />
</span></p></div>
<div class="sect2">
<h3 id="_creating_the_app">Creating the app</h3>
<div class="paragraph"><p>Let&#8217;s start by creating the Cocoaheads rubymotion app. You have already know how to create RubyMotion apps from previous chapters, in the command line type:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create Cocoaheads
</pre></div></div></div>
<div class="paragraph"><p>As we have seen, this command creates an empty application with the following folder structure:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview//ch05_02_folder_structure.png" alt="Folder structure" />
</span></p></div>
<div class="paragraph"><p>We&#8217;ll be using a structure based on Rails for this Course. Thus, you need to create a folrder named "controllers" inside the "app" folder. Inside "controllers". create an empty file called "next_event_view_controller.rb".</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview//ch05_03_folder_controllers.png" alt="Controllers folder" />
</span></p></div>
<div class="paragraph"><p>As we have seen in previous chapters, the vanilla app created by the motion command only creates an empty app. We need to add a Window to it. Thus, open the app_delegate.rb class and inside the method</p></div>
<div class="paragraph"><p>copy this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

  <span class="n">next_event_view_controller</span> <span class="o">=</span> <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">next_event_view_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Remember that this method is called once iOS has finished creating your app. In that moment, the <strong>UIAppDelegate</strong> is notified using this method so you can initiliaze the app.</p></div>
<div class="paragraph"><p>This is what we are doing inside the method:</p></div>
<div class="ulist"><ul>
<li>
<p>
Create a <strong>UIWindow</strong>.
</p>
</li>
<li>
<p>
Assigning a <strong>UIViewController</strong> as the <strong>rootViewController</strong> of the window.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Notice that we are creating the <strong>UIWindow</strong> with the same Frame as <strong>UIScreen.mainScreen</strong>. <strong>UIScreen</strong> is a convenient class to access the size of a screen device. So basically we are setting the size of the app&#8217;s window to be the full screen.</p></div>
</div>
<div class="sect2">
<h3 id="_creating_the_view_controller">Creating the View Controller</h3>
<div class="paragraph"><p>Now, we are going  create our View Controller. Open the <strong>next_event_view_controller.rb</strong> file and create a child of UIViewController:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NextEventViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="nb">p</span> <span class="s1">&#39;Initializing NextEventViewController&#39;</span>
    <span class="k">super</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">p</span> <span class="s1">&#39;loading view&#39;</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In Cocoa, there is no <strong>initialize</strong> metod. There is the <strong>init</strong> method with the responsbility of creating the instance of the class. It is mandatory that you call <strong>super</strong> and then, return <strong>self</strong>.</p></div>
<div class="paragraph"><p>The other method we are creating is <strong>loadView</strong>. The responsibility of this method is to actually create the view of this Controller. So we are basically creating a view that covers all the screen and switching its background color to white. <strong>UIColor</strong> is the  class we use in Cocoa to handle colors, it has some convenient class methods with predefined colors (such as <strong>whiteColor</strong>) but it also allows you to create custom colors.</p></div>
<div class="paragraph"><p>Use the command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>to test the application, you will see a white screen. And in the console you will notice that first the init method was invoked and then the loadView.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_04_console.png" alt="Console output" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_using_uiimageview">Using UIImageView</h3>
<div class="paragraph"><p>Now it&#8217;s time to begin to stylish our app. We are going to add an header and a background image with a nice gradient.</p></div>
<div class="paragraph"><p>Open the zip file called ch05CocoaOverview_resources.zip, inside you&#8217;ll find the Design assets for this workshop. Copy them into the <strong>resources</strong> folder of our app.</p></div>
<div class="paragraph"><p>Now inside our View Controller, add these lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">imageViewWithHeader</span>

  <span class="n">header_imageview</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTitleBar&#39;</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">header_imageview</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">imageViewWithBackground</span>

  <span class="n">background_imageview</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgApp&#39;</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">background_imageview</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">396</span><span class="p">)</span>
  <span class="n">background_imageview</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">imageViewWithTitleBackground</span>

  <span class="n">title_background_imageview</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgEventTitle&#39;</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">title_background_imageview</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">103</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">103</span><span class="o">]]</span>
  <span class="n">title_background_imageview</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The method <strong>viewDidLoad</strong> is called once the view of the Controller is loaded into memory. It&#8217;s safe, then, to initialize the view inside this method.</p></div>
<div class="paragraph"><p>Basically, we are adding two images using the <strong>addSubview</strong> method of <strong>UIView</strong>. In the <strong>imageViewWithHeader</strong> method, we are creating the first image: the header image. In CocoaTouch we have the <strong>UIImageView</strong> class to add images to our apps. We are using its initializer method called <strong>initWithImage</strong> that receives a <strong>UIImage</strong>. <strong>UIImage</strong> is the image itself, and <strong>UIImageView</strong> is only a convenient <strong>UIView</strong> that simplifies the process of painting an image on screen.</p></div>
<div class="paragraph"><p><strong>UIImage</strong> can be created with its class method <strong>imageNamed</strong> that receives an <strong>NSString</strong> with the name of the image file.</p></div>
<div class="paragraph"><p>In the <strong>imageViewWithBackground</strong> method we are creating the <strong>UIImageView</strong> with the background image. Notice that we are changing the frame of this image. The frame is a property of type <strong>CGRect</strong> that the class <strong>UIView</strong> uses to specify the location of the view inside its superview and its size.</p></div>
<div class="paragraph"><p>We are using the <strong>CGRectMake</strong> function to create our frame. The first two arguments define the location coordinates of the object from the top left corner of the superview. For the background we are specifying an X coordinate of 0, thus the object will be at the left-most location of the screen; and a Y coordinate of 64, thus the object will be placed below the header image. The second  and third argument specifies its size.</p></div>
<div class="paragraph"><p>RubyMotion has another way to create a <strong>CGRect</strong>. Try to change the <strong>CGRectMake</strong> line to this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">background_imageview</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">396</span><span class="o">]]</span>
</pre></div></div></div>
<div class="paragraph"><p>RubyMotion allow us to use an array of two arrays to define *CGRect*s. The first array specifies the location of the object and the second its size.</p></div>
<div class="paragraph"><p>When you run the app you will something like this:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_05_uiimage.png" alt="Console output" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_creating_labels">Creating labels</h3>
<div class="paragraph"><p>The next step is to create the labels with the Event information. Add this two methods to your View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">labelWithNextEventName</span>

  <span class="n">next_event_name_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">130</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">275</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span> <span class="p">)</span>

  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;AmericanTypewriter-CondensedBold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">30</span><span class="p">)</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">shadowColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">darkGrayColor</span>
  <span class="n">next_event_name_label</span><span class="o">.</span><span class="n">shadowOffset</span> <span class="o">=</span> <span class="o">[-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
  <span class="n">next_event_name_label</span>

<span class="k">end</span>


<span class="k">def</span> <span class="nf">labelWithDaysLeft</span>

  <span class="n">days_left_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">220</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">275</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span> <span class="p">)</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Light&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">shadowColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">darkGrayColor</span>
  <span class="n">days_left_label</span><span class="o">.</span><span class="n">shadowOffset</span> <span class="o">=</span> <span class="o">[-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
  <span class="n">days_left_label</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The object used in CocoaTouch to disply lines of text is <strong>UILabel</strong>. We are creating two <strong>UILabel</strong> using the initializer method <strong>initWithFrame</strong> to specify their size and location.</p></div>
<div class="paragraph"><p>Then, we are changing its font and size. An <strong>UILabel</strong> has a property named <strong>font</strong> that allow us to do that. To create a Font, we are using the <strong>UIFont</strong> class and its method <strong>fontWithName:size</strong>. As you can see, you specify the font using a NSString with the Font Family name. If you want to see the available Fonts in CocoaTouch, try to print the array returned by <strong>UIFont.familyNames</strong>.</p></div>
<div class="paragraph"><p>Next, we are changing the color of the label using the <strong>textColor</strong> property and the text alignment. By default a <strong>UILabel</strong> has a white background color, we are changing this to clearColor. This is a special color to specify transparencies. So, basically we are defining that the background of this <strong>UILabel</strong> should be transparent.</p></div>
<div class="paragraph"><p>Finally, we are adding a shadow to the label. With <strong>shadowColor</strong> you specify its color and with <strong>shadowOffset</strong> its location. This offset is the number of points that the shadow will be offset from the label. It is a <strong>CGSize</strong> object so you can specify it with the <strong>CGSizeMake</strong> function, but we prefer to use the more convenient RubyMotion way of using an array of two elements, one for width and the other one for weight. With <strong>[-1, -1]</strong> we are defining that the shadow will be 1 point offset to the left and 1 point offset up from the label.</p></div>
<div class="paragraph"><p>We have the methods to create our labels, is time to add them to our view. Inside the viewDidLoad method add this lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>

  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="n">labelWithNextEventName</span>
  <span class="vi">@days_left_label</span> <span class="o">=</span> <span class="n">labelWithDaysLeft</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@next_event_name_label</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@days_left_label</span> <span class="p">)</span>

  <span class="vi">@days_left_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">DAYS_LEFT_TEXT</span>
  <span class="vi">@next_event_name_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">EVENT_NAME_TEXT</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And create this other method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidUnload</span>

  <span class="k">super</span>
  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@days_left_label</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are adding the labels to instance variables. This is recommended if you need to access them later to change its properties. In this case we are changing the text of the labels to some constants. Finally add this two constants to your View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NextEventViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="no">DAYS_LEFT_TEXT</span> <span class="o">=</span> <span class="s2">&quot;(20 Days Left)&quot;</span>
  <span class="no">EVENT_NAME_TEXT</span> <span class="o">=</span> <span class="s2">&quot;November meeting.&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>When you keep <strong>UIView*s in instance variables, it is recommended to set this variables to *nil</strong> inside the <strong>viewDidUnload</strong> method. Prior to iOS 6, this method was invoked when the device was running out of memory. Then, we are freeing the memory allocated for the UILabels for low memory scenarios.</p></div>
<div class="paragraph"><p>Run your app and you should see that the labels appeared with the data for the next Cocoaheads event:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_06_uilabel.png" alt="Labels" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_adding_buttons">Adding buttons</h3>
<div class="paragraph"><p>Finally, we are going to add two buttons to our app: for sign-up and for sign-in.</p></div>
<div class="paragraph"><p>Add these methods to the View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">buttonForSignIn</span>

  <span class="n">sign_in_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">280</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">295</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;I have an account, sign-in to book&quot;</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;is Highlighted&quot;</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateHighlighted</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Light&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">sign_in_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">action</span><span class="ss">:&#39;sign_in:&#39;</span><span class="p">,</span> <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>

  <span class="n">sign_in_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">buttonForSignUp</span>

  <span class="n">sign_up_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">350</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">295</span><span class="p">,</span> <span class="mi">40</span><span class="o">]]</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Don&#39;t have an account, sign-up&quot;</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Light&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">18</span><span class="p">)</span>
  <span class="n">sign_up_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">action</span><span class="ss">:&#39;sign_up&#39;</span><span class="p">,</span> <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">sign_up_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span> <span class="n">button</span> <span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;sign in button pressed </span><span class="si">#{</span><span class="n">button</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">sign_up</span>

  <span class="nb">p</span> <span class="s2">&quot;sign-up button pressed&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>And don&#8217;t forget to add the buttons to the view in the "viewDidLoad" method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>

  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="n">labelWithNextEventName</span>
  <span class="vi">@days_left_label</span> <span class="o">=</span> <span class="n">labelWithDaysLeft</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@next_event_name_label</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@days_left_label</span> <span class="p">)</span>

  <span class="vi">@days_left_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">DAYS_LEFT_TEXT</span>
  <span class="vi">@next_event_name_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">EVENT_NAME_TEXT</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignIn</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignUp</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Let&#8217;s review what&#8217;s going on in those methods. First, we are creating a <strong>UIButton</strong> with the line.</p></div>
<div class="paragraph"><p><strong>UIButton.buttonWithType(UIButtonTypeRoundedRect)</strong></p></div>
<div class="paragraph"><p>As you may expect, there are other types of UIButtons that you can specify, such as:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>UIButtonTypeRoundedRect</strong>. Standard white button with rounded corners.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeCustom</strong>. Defines a button with no style, very useful when you have your own set of images to use as a button.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeDetailDisclosure</strong>. The standard button that appear in tables: a small blue circle with an arrow on it.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeInfoLight</strong>. A small gray circle with an "i" on it.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeInfoDark</strong>. A small dark gray circle with an "i" on it.
</p>
</li>
<li>
<p>
<strong>UIButtonTypeContactAdd</strong>. A small blue circle with the plus sign on it.
</p>
</li>
</ul></div>
<div class="paragraph"><p>You can try these types in the app.</p></div>
<div class="paragraph"><p>The second thing you have to notice is how to add text to the button (this only works if the type is Round Rect or Custom):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">sign_in_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;I have an account, sign-in to book&quot;</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>We do that with the method <strong>setTitle:forState</strong>. The first argument is a <strong>NSString</strong> with the text, the second one specifies in which state should the text appear. A <strong>UIButton</strong> has the following states:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>UIControlStateNormal</strong>. The default state of the button.
</p>
</li>
<li>
<p>
<strong>UIControlStateHighlighted</strong>. When the button is pressed.
</p>
</li>
<li>
<p>
<strong>UIControlStateDisabled</strong>. When the button is disabled (its enabled property is set to false).
</p>
</li>
</ul></div>
<div class="paragraph"><p>As you can see, for the Sign-In button we are specifying a title for the highlight state, when you run the app and press that button you will se that the title changes to the one for the highlighted state.</p></div>
<div class="paragraph"><p>We are also changing the default font of the button:</p></div>
<div class="paragraph"><p><strong>sign_in_button.titleLabel.font = UIFont.fontWithName("HelveticaNeue-Light", size:18)</strong></p></div>
<div class="paragraph"><p>Finally we are connecting the UIButton to our View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">sign_in_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                         <span class="n">action</span><span class="ss">:&#39;sign_in:&#39;</span><span class="p">,</span>
                         <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>The method <strong>addTarget:action:forControlEvents</strong> is the standard way to communicate a <strong>UIControl</strong> with a <strong>UIViewController</strong>. This method specifies which object and which method inside that object should be notified when an specific Event happens in such <strong>UIControl</strong>.</p></div>
<div class="paragraph"><p>In this case we are saying that <strong>self</strong> (the current <strong>UIViewController</strong> instance) should be notified through the <strong>sign_in:</strong> method when the <strong>UIButton</strong> is pressed and released (<strong>UIControlEventTouchUpInside</strong>). The action is actually a <strong>selector</strong> in CocoaTouch: a <strong>NSString</strong> with the name of the method. This name will be resolved into a concrete method in Runtime. In this example, this method will be called:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span> <span class="n">button</span> <span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;sign in button pressed </span><span class="si">#{</span><span class="n">button</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, the name of the method has a ":", because it has one argument. Using this target-selector approach to communicate, the UIControl that triggers the communication can be passed as an argument. In this example, it is the UIButton.</p></div>
<div class="paragraph"><p>In the other button, the sign-up one, we are not passing any argument:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">sign_up_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                         <span class="n">action</span><span class="ss">:&#39;sign_up&#39;</span><span class="p">,</span>
                         <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Then, the selector method must be declared with no arguments:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_up</span>

  <span class="nb">p</span> <span class="s2">&quot;sign-up button pressed&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and try the buttons. If both of them are appearing and invoke the specified methods, you have finished this workshop.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_07_uibuttons.png" alt="UIButtons" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_challenge">Challenge</h3>
<div class="paragraph"><p>We included two standard buttons in our app, but our designer have made a really cool button. You can see it in the resources dir, is the image named <strong>btnBrown.png</strong>.</p></div>
<div class="paragraph"><p>Change the sign-up button to show this image. Tips: you will need to change the type of the button to a Custom one and need to use the <strong>setBackgroundImage:forState</strong> method.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch05-CocoaOverview/ch05_08_challenge.png" alt="Challenge" />
</span></p></div>
</div>
</div>
</div>
<h1 id="_day_2">Day 2</h1>
<h1 id="_chapter_07_mapkit">Chapter 07 - MapKit</h1>
<div class="paragraph"><p>In this chapter we are going to review some concepts about delegation in CocoaTouch and how to use maps.</p></div>
<div class="sect1">
<h2 id="_preparing_the_app">Preparing the app</h2>
<div class="sectionbody">
<div class="paragraph"><p>Open the file <strong>ch07_mapkit_resources.zip</strong> and unzip it. Inside there is our Cocoaheads app. Run it with the <strong>rake</strong> command. You will see the main screen with the details of an event:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_01_app.png" alt="Chapter 7 app" />
</span></p></div>
<div class="paragraph"><p>When you tap on the <strong>View Map</strong> button a view that will contain the map appears:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_02_map.png" alt="Chapter 7 empty map view" />
</span></p></div>
<div class="paragraph"><p>Now open the Rakefile and examine the configuration. In this lab we are going to use the Location functionalities of CocoaTouch and the Maps. In order to do this we have to import some frameworks:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">frameworks</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;CoreLocation&#39;</span><span class="p">,</span> <span class="s1">&#39;MapKit&#39;</span><span class="o">]</span>
</pre></div></div></div>
<div class="paragraph"><p>CoreLocation is the framework that allows you to access the geo location and heading of the device. MapKit, in the other hand, provides an interface to embed maps into your applications as well as other advance functionality such as adding custom annotations, reverse-geocoding lookups, etc.</p></div>
<div class="sect2">
<h3 id="_adding_a_location_manager">Adding A Location Manager</h3>
<div class="paragraph"><p>The first thing we are going to add to our View Controller is a <strong>CLLocationManager</strong> to determine the device location and show how the delegation pattern works in CocoaTouch.</p></div>
<div class="paragraph"><p>In order to do this, open the <strong>event_detail_view_controller.rb</strong> file and locate the method named <strong>requestUserCurrenLocation</strong> Add the following lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="no">CLLocationManager</span><span class="o">.</span><span class="n">locationServicesEnabled</span><span class="p">)</span>

 <span class="vi">@location_manager</span> <span class="o">=</span> <span class="no">CLLocationManager</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1">#Play with other possible values: KCLLocationAccuracyBest, KCLLocationAccuracyHundredMeters, etc.</span>
  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">desiredAccuracy</span> <span class="o">=</span> <span class="no">KCLLocationAccuracyKilometer</span>

  <span class="c1">#Set the current view controller as the delegate of the Location Manager, the location manager will notify of any changes in the location.</span>
  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">purpose</span> <span class="o">=</span> <span class="s2">&quot;To provide functionality based on user&#39;s current location&quot;</span>
  <span class="vi">@location_manager</span><span class="o">.</span><span class="n">startUpdatingLocation</span>

<span class="k">else</span>

  <span class="n">showAlertWithTitle</span><span class="p">(</span><span class="s1">&#39;Location Error&#39;</span><span class="p">,</span> <span class="s1">&#39;Please enable the Location Services for this app in Settings.&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>First, we are checking if the user allow the device to use the location services. If not, we are showing an UIAlertView. Review the showAlertWithTitle method to learn how to present alerts in CocoaTouch.</p></div>
<div class="paragraph"><p>Then, we create our CLLocationManager. The first thing we set, is the <strong>desiredAccuracy</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@location_manager</span><span class="o">.</span><span class="n">desiredAccuracy</span> <span class="o">=</span> <span class="no">KCLLocationAccuracyKilometer</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>CLLocationManager</strong> supports a wide range of accuracies. This property specifies which method will be used to determine the current device location. By instance, an accuracy set to <strong>KCLLocationAccuracyBest</strong> will prompt iOS to use the GPS to determine the location and thus will spent more battery. Wheter an accuracy set to KCLLocationAccuracyKilometer will be more conservative in the use of the device&#8217;s resourcers.</p></div>
<div class="paragraph"><p>Remember that an iOS device can use up to 3 ways to determine its location:</p></div>
<div class="ulist"><ul>
<li>
<p>
GPS. For devices with that functionality such and iPhones or iPads with GSM/LTE.
</p>
</li>
<li>
<p>
Cell towers triangulation. For devices with GSM/LTE.
</p>
</li>
<li>
<p>
WiFi hotspots.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The accuracy goes from best to worse in that order. You should choose carefully the desired accuracy according to your app functionality. An <strong>KCLLocationAccuracyBest</strong> accuracy is best suited to navigation apps or running apps where you need the best possible value for the current location. In the other hand, an app such as the Cocoaheads apps can work with an accuracy of <strong>KCLLocationAccuracyKilometer</strong>. We only need to know if the user is close to the meeting venue.</p></div>
<div class="paragraph"><p>Next, we set the View Controller as a delegate to the location manager:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@location_manager</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
</pre></div></div></div>
<div class="paragraph"><p>Thus, the <strong>CLLocationManager</strong> instance will notifiy us when a change in the device&#8217;s location occurs.</p></div>
<div class="paragraph"><p>With the line</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@location_manager</span><span class="o">.</span><span class="n">purpose</span> <span class="o">=</span> <span class="s2">&quot;To provide functionality based on user&#39;s current location&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>We define the message that the device will show to the user when it ask permission to access the location data.</p></div>
<div class="paragraph"><p>And, finally with <strong>@location_manager.startUpdatingLocation</strong> we start the tracking for the device&#8217;s location.</p></div>
<div class="paragraph"><p>But, how are we going to be notified when the CLLocationManager determines the device&#8217;s current location? We need to implement some methods from the <strong>CLLocationManagerDelegate</strong> protocol. Write this methods in the View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">#CLLocationManagerDelegate methods</span>

<span class="k">def</span> <span class="nf">locationManager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">didUpdateToLocation</span><span class="ss">:newLocation</span><span class="p">,</span> <span class="n">fromLocation</span><span class="ss">:oldLocation</span><span class="p">)</span>

  <span class="vi">@location_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Latitude:</span><span class="si">#{</span><span class="n">newLocation</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">latitude</span><span class="si">}</span><span class="s2"> Longitude:</span><span class="si">#{</span><span class="n">newLocation</span><span class="o">.</span><span class="n">coordinate</span><span class="o">.</span><span class="n">longitude</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">locationManager</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">didFailWithError</span><span class="ss">:error</span><span class="p">)</span>

  <span class="n">showAlertWithTitle</span><span class="p">(</span> <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">andMessage</span><span class="ss">:error</span><span class="o">.</span><span class="n">description</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>CLLocationManager will invoke the method <strong>locationManager:didUpdateToLocation:fromLocation</strong> of its delegate when it can determine a change in the device&#8217;s location. In this case we are updating in a UILabel the coordinates of the device. The object for both newLocation and oldLocation arguments is <strong>CLLocation</strong>. This class gives you access to values such as latitude, longitude and some other variables like altitude and speed.</p></div>
<div class="paragraph"><p>If an error occurs, the second method <strong>locationManager:didFailWithError</strong> will be called.</p></div>
<div class="paragraph"><p>Run the example, and try changing the simulator location in the Debug menu using the Location option. There are some predifined locations and you can specify a custom one by entering its latitude and longitude:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_03_location.png" alt="Chapter 7 location" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_creating_a_small_map">Creating a small Map</h3>
<div class="paragraph"><p>The next step is to add a small map just below the label where our location is being drawn. In CocoaTouch we use the <strong>MKMapView</strong> class to render maps. Locate the method named <strong>mapViewForEvent</strong> in the <strong>event_detail_view_controller.rb</strong> file. Copy this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mapViewForEvent</span>

  <span class="n">map_view_for_event</span> <span class="o">=</span> <span class="no">MKMapView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">25</span><span class="p">,</span><span class="mi">210</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">270</span><span class="p">,</span> <span class="mi">80</span><span class="o">]]</span> <span class="p">)</span>
  <span class="n">map_view_for_event</span><span class="o">.</span><span class="n">mapType</span> <span class="o">=</span> <span class="no">MKMapTypeStandard</span>
  <span class="n">map_view_for_event</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, there is nothing special about creating a <strong>MKMapView</strong> You just used the old <strong>initWithFrame</strong>. The second line, though, is more interesting. In that we specify the type of map we want to render. <strong>MKMapView</strong> supports three types of maps:</p></div>
<div class="ulist"><ul>
<li>
<p>
MKMapTypeStandard. Displays a street map that shows the position of all roads and some road names.
</p>
</li>
<li>
<p>
MKMapTypeSatellite. Displays satellite imagery of the area.
</p>
</li>
<li>
<p>
MKMapTypeHybrid. Displays a satellite image of the area with road and road name information layered on top.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Finally, add the map view to the main view in the <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">mapViewForEvent</span> <span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app, you should see a small map view in the middle</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_04_smallmap.png" alt="Chapter 7 small map" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_creating_a_map_with_annotations">Creating a map with annotations</h3>
<div class="paragraph"><p>When you tap on the <strong>View Map</strong> button, currently is showing an empty view. We are going to fix this. Open the <strong>event_map_view_controller.rb</strong> file and locate the method called <strong>mapViewWithEventLocation</strong> That method should return a mapview with its type set to MKMapTypeStandard, just as the <strong>mapViewForEvent</strong> we implemented in the previous controller.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mapViewWithEventLocation</span>

  <span class="n">map_view_for_event</span> <span class="o">=</span> <span class="no">MKMapView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span> <span class="p">)</span>
  <span class="n">map_view_for_event</span><span class="o">.</span><span class="n">mapType</span> <span class="o">=</span> <span class="no">MKMapTypeStandard</span>
  <span class="n">map_view_for_event</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Once you have done that, add the view to the main view in the <strong>viewDidLoad</strong> adding the following line before inserting any other view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span>
  <span class="vi">@map_view_for_event</span> <span class="o">=</span> <span class="n">mapViewWithEventLocation</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@map_view_for_event</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">segmentedControlWithMapOptions</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonToCloseScreen</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example, you should see something like this:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_05_bigmap.png" alt="Chapter 7 big map" />
</span></p></div>
<div class="paragraph"><p>The next step is to show a Pin in the location of the next meeting and to center the map near that spot. First, we are going to center the map around the event location. You can see that this View Controller has an instance variable named <strong>event</strong> of type <strong>Event</strong>. This class has a location attribute, with the latitude and longitude of the venue. We are going to use that property to extract the location around the map will be centered.</p></div>
<div class="paragraph"><p><strong>MapKit</strong> uses a special structure called <strong>MKCoordinateRegion</strong> that has a <strong>CLLocationCoordinate2D</strong> - a structure which latitude and longitude values - and a <strong>MKCoordinateSpan</strong>, that represents the amount of map to display in the vertical and horizontal space. You can see this Span as the zoom that the map will have.</p></div>
<div class="paragraph"><p>Let&#8217;s create a method that returns our <strong>MKCoordinateRegion</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">regionForEventLocation</span>

  <span class="n">region</span> <span class="o">=</span> <span class="no">MKCoordinateRegionMake</span><span class="p">(</span><span class="vi">@event</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="no">MKCoordinateSpanMake</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">7</span><span class="p">))</span>
  <span class="n">region</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are using the function MKCoordinateRegionMake, that takes 2 arguments: the <strong>CLLocationCoordinate2D</strong> that we retrieve from the <strong>@event</strong> variable and a <strong>MKCoordinateSpan</strong> that we are creating using another function: <strong>MKCoordinateSpanMake</strong> with the vertical and horizontal values.</p></div>
<div class="paragraph"><p>Now, add this region to the <strong>@map_view_for_event</strong> in the <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@map_view_for_event</span><span class="o">.</span><span class="n">setRegion</span><span class="p">(</span><span class="n">regionForEventLocation</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and you should see that the maps is centered and zoomed in around San José, California (the event has as its location the Apple HQ in Cupertino.):</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_06_mapregion.png" alt="Chapter 7 map region" />
</span></p></div>
<div class="paragraph"><p>Finally, we are going to add a Pin -Annotations in MapKit terms. in the venue location. To add an Annotation in Objective-C you must create a class that explicitly implements the MKAnnotation protocol. In RubyMotion you only need to create a class with the same methods defined in the protocol. These methods are:</p></div>
<div class="ulist"><ul>
<li>
<p>
coordinate. Returns a CLLocationCoordinate
</p>
</li>
<li>
<p>
title. NSString with the main title of the Annotation.
</p>
</li>
<li>
<p>
subtitle. Optional, returns an NSString with the subtitle of the annotation.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Create a new file inside the <strong>models</strong> folder named <strong>event_annotation.rb</strong>. Copy this code inside:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EventAnnotation</span>

  <span class="k">def</span> <span class="nf">initWithCoordinate</span><span class="p">(</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">title</span><span class="ss">:title</span><span class="p">,</span> <span class="n">andSubTitle</span><span class="ss">:subtitle</span><span class="p">)</span>

    <span class="vi">@coordinate</span> <span class="o">=</span> <span class="n">coordinate</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
    <span class="vi">@subtitle</span> <span class="o">=</span> <span class="n">subtitle</span>

    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">coordinate</span>

    <span class="vi">@coordinate</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">title</span>

    <span class="vi">@title</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">subtitle</span>

    <span class="vi">@subtitle</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are only defining an initializer method that receives the coordinate, the title and the subtitle and the methods defined in the <strong>MKAnnotation</strong> protocol. Now we are ready to add our annotation to the Map.</p></div>
<div class="paragraph"><p>Add this method that creates an instance of our custom annotation:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">annotationForEvent</span>

  <span class="no">EventAnnotation</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCoordinate</span><span class="p">(</span><span class="vi">@event</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">title</span><span class="ss">:event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">andSubTitle</span><span class="ss">:event</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the <strong>viewDidLoad</strong> method, add the annotation to the map:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@map_view_for_event</span><span class="o">.</span><span class="n">addAnnotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the example and you should see a red pin in the event&#8217;s location, if you tap on it you will see the title and subtitle displayed inside a callout:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_07_annotation.png" alt="Chapter 7 map annotation" />
</span></p></div>
<div class="paragraph"><p>If you see the annotation displayed correctly, you have finished this lab.</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_2">Challenge</h3>
<div class="paragraph"><p>As you can see in the app, we are displaying a toggle buttons to change the type of the map. If you are curious about how do you create such controls, review the <strong>segmentedControlWithMapOptions</strong> method. This control is called <strong>UISegmentedControl</strong> and you only need to specify the options that will have in order to create it. We are also defining a target-selector that will be notified when the user taps in a button. The selector is the method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">switch_map_type</span><span class="p">(</span><span class="n">segmented_control</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Your challenge is to implement the logic to change the map type. A tip that will help you: with <strong>segmented_control.selectedSegmentIndex</strong> you can access the current button selected index. Using this you&#8217;ll be able to determine which map type you should set to the <strong>@map_view_for_event.type</strong> variable.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch07-MapKit/ch07_08_challenge.png" alt="Chapter 7 map challenge" />
</span></p></div>
</div>
</div>
</div>
<h1 id="_chapter_08_uiviews">Chapter 08 - UIViews</h1>
<div class="paragraph"><p>Our designer has came up with a better design for our first screen, the one we develop during Chapter 5. He thought that we could present the days left until the next meeting with a custom view representing a flip calendar rather than using a simple text label:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_01_app.png" alt="Chapter 8 final app" />
</span></p></div>
<div class="paragraph"><p>So we have deleted the old label with the days left, open the file <strong>ch08-uiviews.zip</strong> and unzip the RubyMotion project. Run it, you should see our old view without the days left information:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_02_starting_app.png" alt="Chapter 8 starting app" />
</span></p></div>
<div class="sect1">
<h2 id="_creating_a_custom_uiview">Creating a custom UIView</h2>
<div class="sectionbody">
<div class="paragraph"><p>When you face the challenge of creating a custom component such as this flip calendar, is often required to create a custom UIView. Custom UIViews gives you complete control over the look and logic of a UIView.</p></div>
<div class="paragraph"><p>To implement them, you must begin creating a class that inherits from UIView. Create a new file named <strong>flipcount_view.rb</strong> . Inside this file, declare a new class:+</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FlipCountView</span> <span class="o">&lt;</span> <span class="no">UIView</span>

  <span class="kp">attr_accessor</span> <span class="ss">:days_left</span>

  <span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span> <span class="n">frame</span> <span class="p">)</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Until now, we have only declared the class and one public attribute called <strong>days_left</strong>. We are also overwriting the <strong>initWithFrame:</strong> initializer. Remember that this method is used to create UIViews. We are just setting the background color of the UIView to white. Let&#8217;s test it. In the <strong>next_event_view_controller.rb</strong> file create this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewWithDaysLeft</span>
  <span class="n">days_left_view</span> <span class="o">=</span> <span class="no">FlipCountView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span> <span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">120</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">68</span><span class="p">,</span> <span class="mi">74</span><span class="o">]]</span> <span class="p">)</span>
  <span class="n">days_left_view</span><span class="o">.</span><span class="n">days_left</span> <span class="o">=</span> <span class="vi">@days_left</span>
  <span class="n">days_left_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are creating a FlipCountView with a frame that places it to the left of the event&#8217;s name label. Now add it to your view in the <strong>viewDidLoad</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre> <span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="k">super</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithHeader</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithBackground</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">imageViewWithTitleBackground</span> <span class="p">)</span>
  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="n">labelWithNextEventName</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@next_event_name_label</span> <span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignIn</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonForSignUp</span> <span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="n">buttonToChangeDaysLeft</span> <span class="p">)</span>

  <span class="vi">@days_left_view</span> <span class="o">=</span> <span class="n">viewWithDaysLeft</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span> <span class="vi">@days_left_view</span> <span class="p">)</span>


  <span class="vi">@next_event_name_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="no">EVENT_NAME_TEXT</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Remember that always that you add a UIView to an instance variable, you must set it to <strong>nil</strong> in the <strong>viewDidUnload</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidUnload</span>

  <span class="k">super</span>
  <span class="vi">@next_event_name_label</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="vi">@days_left_view</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now test the application. You will see a white rectangle:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_03_rectangle.png" alt="Chapter 8 rectangle" />
</span></p></div>
<div class="sect2">
<h3 id="_drawing_text">Drawing text</h3>
<div class="paragraph"><p>Now, we have to add the text for the <strong>@days_left</strong> attribute. We have seen that we can use a <strong>UILabel</strong> to render text on the screen. However, we are going to see a different low-level approach: to draw the text inside the view.</p></div>
<div class="paragraph"><p>Every <strong>UIView</strong> knows how to draw itself in the screen. If you want to implement your custom drawing logic, you should override the method <strong>drawRect:</strong> It is very important that you handle this method very carefully. This method is called directly by iOS every time that the screen needs to be rendered: the first time it is displayed or when part of the view is invalidated. So it is not recommended to do some heavy computations inside the method, that will reduce the performance of your app.</p></div>
<div class="paragraph"><p>Lets implement the <strong>drawRect:</strong> method that draws the days left:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">drawDaysLeftInRect</span> <span class="n">rect</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">drawDaysLeftInRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">big_font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue-Bold&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">48</span><span class="p">)</span>
  <span class="vi">@days_left</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">drawAtPoint</span><span class="p">(</span><span class="o">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span> <span class="o">]</span><span class="p">,</span> <span class="n">withFont</span><span class="ss">:big_font</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Inside the <strong>drawDaysLeftInRect:</strong> method we are creating a UIFont and then we are rendering directly the days_left. This attribute is an <strong>Integer</strong>, thus we need to converting to <strong>String</strong> with <strong>to_s</strong>. In RubyMotion traditional <strong>String</strong> class of Ruby inherits from <strong>NSMutableString</strong> that is why we could use the method <strong>drawAtPoint</strong>. This method is actually rendering the String inside the view at the given point using the font passed as an argument.</p></div>
<div class="paragraph"><p>Run the example and you should see the "0" rendered inside the custom view:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_04_zero.png" alt="Chapter 8 drawn label" />
</span></p></div>
<div class="paragraph"><p>Now we are going to render the legend  "days left" at the bottom. In order to this we are going to calculate the Y coordinate using the <strong>rect</strong> of the view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawDaysLeftLegendInRect</span><span class="p">(</span> <span class="n">rect</span> <span class="p">)</span>

  <span class="n">small_font</span> <span class="o">=</span> <span class="no">UIFont</span><span class="o">.</span><span class="n">fontWithName</span><span class="p">(</span><span class="s2">&quot;HelveticaNeue&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="mi">12</span><span class="p">)</span>
  <span class="s2">&quot;days left&quot;</span><span class="o">.</span><span class="n">drawAtPoint</span><span class="p">(</span><span class="o">[</span><span class="mi">11</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">]</span><span class="p">,</span> <span class="n">withFont</span><span class="ss">:small_font</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Remember to call this method from the <strong>drawRect:</strong> one:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">drawDaysLeftInRect</span> <span class="n">rect</span>
  <span class="n">drawDaysLeftLegendInRect</span> <span class="n">rect</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the example and you sould see the legend rendered at the bottom:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_05_legend.png" alt="Chapter 8 drawn legend" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_drawing_images">Drawing images</h3>
<div class="paragraph"><p>Our designer has created a background image to use in our view. The image is called <strong>flipDateImage.png</strong> We have seen that we could insert a UIImageView into our view to render images. But, this time we are going to use a low-level approach: we are going to render the image directly in our <strong>drawRect:</strong> method.</p></div>
<div class="paragraph"><p>Create this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawBackgroundImageInRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">backgroundImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span> <span class="s2">&quot;flipDateImage&quot;</span> <span class="p">)</span>
  <span class="n">backgroundImage</span><span class="o">.</span><span class="n">drawInRect</span><span class="p">(</span> <span class="n">rect</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, a UIImage also knows how to render itself using the <strong>drawInRect:</strong> method. In this case, we want the image to be drawn in the full view, that is why we are passing the whole <strong>rect</strong> as a parameter.</p></div>
<div class="paragraph"><p>Now, invoke this method from inside the <strong>drawRect:</strong> method. You should render the image before drawing the texts, otherwise the image will be drawn covering the texts:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">drawBackgroundImageInRect</span> <span class="n">rect</span>
  <span class="n">drawDaysLeftLegendInRect</span> <span class="n">rect</span>
  <span class="n">drawDaysLeftInRect</span> <span class="n">rect</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally, let&#8217;s change the view color to <strong>clearColor</strong> so the image will be the only thing acting as a background.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>
  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app and you should see the image rendered in the background of the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_06_image.png" alt="Chapter 8 drawn image" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_invalidating_a_view">Invalidating a view</h3>
<div class="paragraph"><p>As you can see, we have a <strong>UIButton</strong> with the title "Increase days left". We want to use it to test our custom view by changing the days left attribute. Locate the method named <strong>change_days_left</strong> and implement the logic to increase the <strong>@days_left</strong> property and update it in our custom view instance:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">change_days_left</span>

  <span class="vi">@days_left</span> <span class="o">=</span> <span class="vi">@days_left</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="vi">@days_left_view</span><span class="o">.</span><span class="n">days_left</span> <span class="o">=</span> <span class="vi">@days_left</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are increasing the value of the variable by 1, and then we are updating that value in our custom view instance. It seem right, isn&#8217;t it? Run the example and tap the "Increase days left" button.</p></div>
<div class="paragraph"><p>Nothing happens. Why? because our custom <strong>UIView</strong> only renders the days left in its <strong>drawRect:</strong> method. This method is called by CocoaTouch when the view is first rendered (in this case is when we add it to our main view) and when the view is invalidated so it has to be rendered again. In this case, neither of those scenarios is presented. So the view is never updated with the new value. You may feel tempted to just call the <strong>drawRect:</strong> method directly, but that is something you should never do. CocoaTouch is responsible of calling that method in the appropiate moment. Instead of that, we need to invalidate the view and CocoaTouch will call the <strong>drawRect:</strong> method in the next drawing cycle. So just add this line at the end of the method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@days_left_view</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>setNeedsDisplay</strong> is the method of <strong>UIView</strong> to mark that it needs to be redrawn. CocoaTouch will call the <strong>drawRect:</strong> and that method will draw the days left with the updated value:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch08-UIViews/ch08_07_needdisplay.png" alt="Chapter 8 need display" />
</span></p></div>
<div class="paragraph"><p>If you see the view being updated when you tap on the button, you have finish this lab.</p></div>
</div>
</div>
</div>
<h1 id="_chapter_09_testing">Chapter 09 - Testing</h1>
<div class="paragraph"><p>Testing is a fundamental part of any application, and it is also a hard task for developers. However, RubyMotion provides us with one tool that will ease the task of testing our apps: <strong>MacBacon</strong>, a special flavour of <strong>Bacon</strong> prepared to test iOS apps.</p></div>
<div class="sect1">
<h2 id="_app_setup">App Setup</h2>
<div class="sectionbody">
<div class="paragraph"><p>Before we being testing our app, we actually need an app. Open the <strong>ch09_testing_resources.zip</strong> and unzip it. Run the app with the command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>As you can see, is the same app that we did during Chapter 7:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_01_app.png" alt="Chapter 7 app" />
</div>
<div class="title">Figure 14. Chapter 7 app</div>
</div>
<div class="paragraph"><p>We have added an extra functionality to the app, if you tap the <strong>Book Event</strong> button the title of the button changes to <strong>Event Booked</strong> and is disabled:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_02_book_event.png" alt="Book Event" />
</div>
<div class="title">Figure 15. Book Event</div>
</div>
<div class="paragraph"><p>Besides that, we have added a method to the <strong>event.rb</strong> model class. Open that file and locate the method called <strong>days_left_until:</strong> that gives you the number of dates until a future date. If the date is not a future date but is in the past, is will return a 0. This method will be used to paint the correct days left in our Custom View we did in the previous workshop.</p></div>
<div class="paragraph"><p>You can check how we are calculating the number of days between two dates in the <strong>days_between:and:</strong> method. We are using the <strong>NSDateComponents</strong> class. That class, is the one we used in CocoaTouch to make <strong>NSDate</strong> operations. Remember that the traditional Ruby class <strong>Time</strong> inherits from NSDate so we can use it in its place.</p></div>
<div class="sect2">
<h3 id="_functional_testing">Functional Testing</h3>
<div class="paragraph"><p>The first we are going to test is this <strong>days_left_until:</strong> method. We want to be sure that it works in these three cases:</p></div>
<div class="ulist"><ul>
<li>
<p>
When given a future date, it calculates accurately the number of days until that date.
</p>
</li>
<li>
<p>
When given the current date, it returns a 0.
</p>
</li>
<li>
<p>
When given a past date, it returns a 0 (we don&#8217;t want negative number in our view).
</p>
</li>
</ul></div>
<div class="paragraph"><p>The first step is to create a <strong>Spec</strong> for our <strong>Event</strong> class. In the <strong>spec</strong> folder, create a folder named <strong>models</strong> and inside a file named <strong>event_spec.rb</strong></p></div>
<div class="paragraph"><p>To define the Spec, write this lines:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Event&quot;</span> <span class="k">do</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>"Event"</strong> is the class that you want to test. Next, we&#8217;ll create some constants of the values we are going to use for our tests, and to initialize our <strong>Event</strong> instance:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">DAYS_LEFT</span> <span class="o">=</span> <span class="mi">10</span>

<span class="no">NEGATIVE_PAST_DAYS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>

<span class="n">before</span> <span class="k">do</span>

  <span class="vi">@event</span> <span class="o">=</span> <span class="no">Event</span><span class="o">.</span><span class="n">mock_event</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are creating a mock <strong>Event</strong> using a class method. This <strong>before</strong> block, is executed before any test, and is helpful to initialize values required by your tests.</p></div>
<div class="paragraph"><p>Let&#8217;s write our first test:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should count days left until future date&quot;</span> <span class="k">do</span>

  <span class="n">future_date</span> <span class="o">=</span> <span class="n">date_adding_days</span><span class="p">(</span> <span class="no">DAYS_LEFT</span> <span class="p">)</span>
  <span class="n">days_left_until_future_date</span> <span class="o">=</span> <span class="vi">@event</span><span class="o">.</span><span class="n">days_left_until</span><span class="p">(</span> <span class="n">future_date</span> <span class="p">)</span>
  <span class="n">days_left_until_future_date</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="no">DAYS_LEFT</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">date_adding_days</span><span class="p">(</span> <span class="n">days_to_add</span> <span class="p">)</span>

  <span class="n">components</span> <span class="o">=</span> <span class="no">NSDateComponents</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">components</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">days_to_add</span>
  <span class="n">gregorian</span> <span class="o">=</span> <span class="no">NSCalendar</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithCalendarIdentifier</span><span class="p">(</span> <span class="no">NSGregorianCalendar</span> <span class="p">)</span>
  <span class="n">gregorian</span><span class="o">.</span><span class="n">dateByAddingComponents</span><span class="p">(</span> <span class="n">components</span><span class="p">,</span> <span class="n">toDate</span><span class="ss">:Time</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span><span class="mi">0</span> <span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>With the <strong>it</strong> block, we define specs that our classes should comply with. The string should represent in a written and descriptive form the spec. In the spec, we are creating a date 10 days in the future using our helper method <strong>date_adding_days:</strong>.</p></div>
<div class="paragraph"><p>We pass that date to our model class and evaluate the returned result with <strong>should.equal</strong> MacBacon adds <strong>should</strong> and <strong>equals</strong> methods. You have several more that you can use to evaluate results inside your specs. If the evaluation is not satisfactory, the test will fail.</p></div>
<div class="paragraph"><p>Now run the spec with the command</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake spec
</pre></div></div></div>
<div class="paragraph"><p>You should see the output with the specifications passed:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_03_first_spec.png" alt="First Spec Passed" />
</div>
<div class="title">Figure 16. First Spec Passed</div>
</div>
<div class="paragraph"><p>Try to change the expected value in the <strong>should.equal</strong> evaluation to see how MacBacon displays an error message when the spec is broken.</p></div>
<div class="paragraph"><p>Let&#8217;s cover another functional requirement, when the date passed as an argument to the method <strong>days_left_until:</strong> is in the past, we don&#8217;t want to display a negative number but a zero instead:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should count days left as 0 for past date&quot;</span> <span class="k">do</span>

  <span class="n">past_date</span> <span class="o">=</span> <span class="n">date_adding_days</span><span class="p">(</span> <span class="no">NEGATIVE_PAST_DAYS</span> <span class="p">)</span>
  <span class="n">days_left_until_past_date</span> <span class="o">=</span> <span class="vi">@event</span><span class="o">.</span><span class="n">days_left_until</span><span class="p">(</span> <span class="n">past_date</span> <span class="p">)</span>
  <span class="n">days_left_until_past_date</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example.</p></div>
</div>
<div class="sect2">
<h3 id="_testing_our_ui">Testing our UI</h3>
<div class="paragraph"><p>One of the main problems while developing apps, is to test its UI. It&#8217;s hard to test the UI of an iOS application programmatically, even when some tools exists, they are difficult to use. RubyMotion has added support to MacBacon to write specs for visual elements with the same simplicity of our functional tests. Let&#8217;s try this feature.</p></div>
<div class="paragraph"><p>Create a file in the folder <strong>specs/controllers</strong> named <strong>event_detail_view_controller_spec.rb</strong> and add this code to create our spec:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;The Event Details view controller&quot;</span> <span class="k">do</span>

  <span class="n">tests</span> <span class="no">EventDetailViewController</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are specifiyng the class we are going to test:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">tests</span> <span class="no">EventDetailViewController</span>
</pre></div></div></div>
<div class="paragraph"><p>MacBacon will instantiate our <strong>EventDetailViewController</strong> and will add it to a <strong>UIWindow</strong>, to display it. MacBacon will take care of initializing our app and creating the appropiate objects needed it to display the View of our View Controller. Thus, we need to let MacBacon to handle this for us. If you remember, we normally create our <strong>UIWindow</strong> and its <strong>rootView</strong> in the <strong>AppDelegate</strong>. Open it and add this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

    <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="no">RUBYMOTION_ENV</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span>
    <span class="n">event_detail_view_controller</span> <span class="o">=</span> <span class="no">EventDetailViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">event_detail_view_controller</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are creating our own <strong>UIWindow</strong> only if we are not testing the app, in that case MacBacon will handle that.</p></div>
<div class="paragraph"><p>So, what do we want to test? Our <strong>Book Event</strong> button. Our first step is to actually verify that the button exists, our <strong>event_detail_view_controller_spec.rb</strong> file write the following spec:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;has book button&quot;</span> <span class="k">do</span>

  <span class="n">view</span><span class="p">(</span><span class="s1">&#39;Book Event&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">not</span><span class="o">.</span><span class="n">equal</span> <span class="kp">nil</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The <strong>view</strong> method allows us to select views with a given title. In this case we are selecting the <strong>UIButton</strong> with the "Book Event" title, and testing that is not nil. Run the example, verifiy that the <strong>EventDetailsViewController</strong> is briefly shown in the simulator and that the spec is succesfully satisfied:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_04_ui_spec.png" alt="UI Spec Passed" />
</div>
<div class="title">Figure 17. UI Spec Passed</div>
</div>
<div class="paragraph"><p>The next step is to test if when you tap on the button, its state changes to disabled and its title to "Event Booked". You will see that the idiom of MacBacon allows us to write such a test very easilly:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;book event&quot;</span> <span class="k">do</span>

  <span class="n">button_to_evaluate</span> <span class="o">=</span> <span class="n">view</span><span class="p">(</span><span class="s1">&#39;Book Event&#39;</span><span class="p">)</span>
  <span class="n">tap</span> <span class="s1">&#39;Book Event&#39;</span>
  <span class="c1">#wait for 2 seconds</span>
  <span class="n">proper_wait</span> <span class="mi">2</span>
  <span class="n">button_to_evaluate</span><span class="o">.</span><span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="s2">&quot;Event Booked&quot;</span>
  <span class="n">button_to_evaluate</span><span class="o">.</span><span class="n">isEnabled</span><span class="o">.</span><span class="n">should</span><span class="o">.</span><span class="n">equal</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are using the method <strong>tap</strong> to tap our button. MacBacon has methods to apply all the standard CocoaTouch gestures to UIViews, such as pinch, zoom, drag, etc. You can review how to use each of them in the <a href="http://www.rubymotion.com/developer-center/articles/testing/#_view_events">online documentation.</a> Then we evaluate the title and the <strong>isEnabled</strong> property to check if the state of the <strong>UIButton</strong> changed.</p></div>
<div class="paragraph"><p>Run your example and this time, because of the 2 seconds wait, you should see how the title changed in the button:</p></div>
<div class="imageblock">
<div class="content">
<img src="Resources/ch09-Testing/ch09_05_ui_running.png" alt="UI spec passed" />
</div>
<div class="title">Figure 18. UI Spec Passed</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenge_3">Challenge</h3>
<div class="ulist"><ul>
<li>
<p>
We have created specs for the <strong>days_left_until</strong> method of the class <strong>Event</strong>. But we are currently missing one test, write the spec to test that when you pass the current date to that method, it should return a "0".
</p>
</li>
</ul></div>
</div>
</div>
</div>
<h1 id="_chapter_10_interface_builder">Chapter 10 - Interface Builder</h1>
<div class="paragraph"><p>In this workshop, we are going to learn to use the Interface Builder, the tool to build User Interfaces without coding them.</p></div>
<div class="paragraph"><p>In previous chapter we have been programmatically creating our views, suchs as buttons or even maps. The Interface Builder will allow us to separate the task of building visual components to specialized files called <strong>nib</strong> files.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_app">Setting up the app</h2>
<div class="sectionbody">
<div class="paragraph"><p>Unzip the file <strong>10-interfacebuilder_resources.zip</strong> run the app using the <strong>rake</strong> command. You will notice that displays our old Next Event
View:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_01_app.png" alt="Chapter 10 app" />
</span></p></div>
<div class="paragraph"><p>We want to implement the Sign in and the Sign up views, but this time will use the Interface Builder to help us.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_our_xcode_project">Setting up our Xcode project</h2>
<div class="sectionbody">
<div class="paragraph"><p>The Interface Builder is integrated into Xcode, the IDE for building iOS projects using Objective-C. Although is technically possible to just create a <strong>Nib</strong> file without a project, is easier to create it inside a project. And having your Nib files integrated into one project is helpful to keep them organized.</p></div>
<div class="paragraph"><p>If you don&#8217;t have Xcode installed, download it from the App Store in your Mac. Open it and you&#8217;ll be prompted to create a new project. Choose in the side menu iOS &gt; Application and the Single View Application template:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_02_xcode_project.png" alt="Chapter 10 xcode project" />
</span></p></div>
<div class="paragraph"><p>Next, enter this data in the project creation wizard. Notice that we are unselecting the "Use Storyboards" option.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_03_xcode_options.png" alt="Chapter 10 xcode options" />
</span></p></div>
<div class="paragraph"><p>Save the project in the same folder where the Cocoaheads Rubymotion project is located.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_sign_in_view">Creating the Sign In View</h2>
<div class="sectionbody">
<div class="paragraph"><p>You will see that Xcode have created an <strong>Xib</strong> file called <strong>RBMViewController.xib</strong></p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_04_project_files.png" alt="Chapter 10 xcode files" />
</span></p></div>
<div class="paragraph"><p>Open it, Xcode opens this kind of files in the Interface Builder Editor.</p></div>
<div class="paragraph"><p>In the right side panel we have two main sections:</p></div>
<div class="ulist"><ul>
<li>
<p>
Placeholders
</p>
</li>
<li>
<p>
Objects
</p>
</li>
</ul></div>
<div class="paragraph"><p>In the center panel, we have our view. In the left side panel we have on the top section the <strong>Inspectors</strong></p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Inspectors</strong> We use them to modify the attributes of the view selected in the left panel&#8217;s sections.
</p>
</li>
<li>
<p>
The Libraries. We use them to select CocoaTouch components, Objects, etc and drag them into our view.
</p>
</li>
</ul></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_05_xcode.png" alt="Chapter 10 xcode" />
</span></p></div>
<div class="paragraph"><p>The Interface Builder can link the objects that we create in the <strong>Xib</strong> file to other objects in our app. In the Placeholder section, select the <strong>File&#8217;s Owner</strong> object. and in the Inspectors select the <strong>Identity</strong> inspector (the third tab):</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_06_identity.png" alt="Chapter 10 identity" />
</span></p></div>
<div class="paragraph"><p>You will notice that this object is a <strong>RBMViewController</strong> a UIViewController subclass that Xcode has created for us. You already know that a UIViewController needs to create its own view, we&#8217;ve been doing this task in the <strong>loadView</strong> method. When you use InterfaceBuilder the view is created inside the Xib file and you link it to the <strong>File&#8217;s owner</strong> that should be a UIViewController.</p></div>
<div class="paragraph"><p>Because this <strong>Xib</strong> was created by the Xcode template, it already has this links defined. Ctrl + click in the File&#8217;s Owner object and you will see the its list of <strong>Outlets</strong></p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_07_outlets.png" alt="Chapter 10 outlets" />
</span></p></div>
<div class="paragraph"><p>The outlets are the variables of an object that an be bound to a component created in the Interface Builder. Select the one named <strong>view</strong> and you will see that the UIView is highligthed. The UIViewController has bound its <strong>view</strong> variable to the UIView created in the Editor.</p></div>
<div class="paragraph"><p>Let&#8217;s start creating our Sign-in view. First, we are going to modify the size of the UIView. Select the View in the <strong>Objects</strong> panel. Now in the <strong>Inspectors</strong> panel select the <strong>Attributes</strong> inspector: the fourth tab. You will notice that Xcode set the size for the iPhone 5&#8217;s 4" screen. Change it to a standard 3.5":</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_08_view_size.png" alt="Chapter 10 view size" />
</span></p></div>
<div class="paragraph"><p>Now choose the first tab, the <strong>Identity</strong> tab and unselect the <strong>Use AutoLayout</strong> option. AutoLayouts is a new feature in iOS6 that helps you to build Interfaces that adapt themselves to different screen sizes. We&#8217;ll cover that topic in the Chapter 16.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_09_autolayout.png" alt="Chapter 10 autolayout" />
</span></p></div>
<div class="paragraph"><p>Lets start creating our view. As you may recall, the views of our Cocoaheads app has an header image with this Cocoa-like texture and below a red gradient background image. We are going to start by creating this objects.</p></div>
<div class="paragraph"><p>In the right panel, go to the bottom panel and select the <strong>Objects</strong> tab, the third one:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_10_objects_panel.png" alt="Chapter 10 objects panel" />
</span></p></div>
<div class="paragraph"><p>In the search field type type UIImageView, the objects will be filtered according to that criteria and only a UIImageView object will appear:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_11_imageview.png" alt="Chapter 10 image view filter" />
</span></p></div>
<div class="paragraph"><p>Drag the object to your view. The next step is to resize the background, this is going to be our header image. You can adjust the size with your mouse or you can use the <strong>Size</strong> Inspector. Select your UIImageView and in the right panel, in the top panel (<strong>Inspectors</strong>) panel, select the <strong>Size</strong> tab (the fifth one). You will see that you can enter the Frame data in this tab. Enter this values: x:0, y:0, width:320, height:64:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_12_imageview_frame.png" alt="Chapter 10 image view frame" />
</span></p></div>
<div class="paragraph"><p>The next step is to create below this header image our background image. Drag another UIImageView. Set its frame to: x:0, y:64, width:320, height:396.</p></div>
<div class="paragraph"><p>Now, we are going to create our UIControls. Let&#8217;s start with the TextFields. Drag a UITextField from the <strong>Objects</strong> panel into your view.</p></div>
<div class="paragraph"><p>Select the <strong>Attributes</strong> inspector (the fourth tab in the Inspectors panel) and enter <strong>email</strong> in the placeholder attribute. In the Border Style select the first option (No border) and in the Keyboard attribute select <strong>Email</strong>. This option will show a keyboard customized for entering email addresses:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_13_textfield_attributes.png" alt="Chapter 10 text field attributes" />
</span></p></div>
<div class="paragraph"><p>Next, adjust the size and location of the textfield using your mouse. Another option is to select the  Text Field and in the <strong>Inspector</strong> section, in the Fifth tab (<strong>Size</strong>) you can type the absolut values for its Frame. For this field we&#8217;ll enter x: 20, y: 130, width 289 and height 44. Don&#8217;t worry if the Textfield is almost invisible, we&#8217;ll add a background image programatically later.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_14_textfield_frame.png" alt="Chapter 10 text field attributes" />
</span></p></div>
<div class="paragraph"><p>Add another Textfield In the <strong>Attributes</strong> tab enter <strong>password</strong> as its placeholder, with no border  and in the bottom select the <strong>Secure</strong> option.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_15_password_attributes.png" alt="Chapter 10 password field attributes" />
</span></p></div>
<div class="paragraph"><p>In the <strong>Size</strong> inspector set its frame to x:20, y:190, width:289 and height:44.</p></div>
<div class="paragraph"><p>Now, we are going to add two buttons: one to close the Sign in view and other to sign in. In the <strong>Objects</strong> section type Round Rect Button and drag a UIButton to the View.</p></div>
<div class="paragraph"><p>In the <strong>Attributes</strong> inspector:</p></div>
<div class="ulist"><ul>
<li>
<p>
Change its type to <strong>Custom</strong>
</p>
</li>
<li>
<p>
In the title delete <strong>Button</strong> and leave it blank.
</p>
</li>
</ul></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_16_button_attributes.png" alt="Chapter 10 button attributes" />
</span></p></div>
<div class="paragraph"><p>Now, set the frame of the object in the <strong>Size</strong> inspector to x:14, y:10, width:56, height:41.</p></div>
<div class="paragraph"><p>The next step is to add our Sign In button. Drag another Round Rect Button into the View. In the <strong>Attributes</strong> Inspector set its properties to:</p></div>
<div class="ulist"><ul>
<li>
<p>
Type: Custom
</p>
</li>
<li>
<p>
Title: SignIn
</p>
</li>
<li>
<p>
Font: Helvetica Neue Medium 18
</p>
</li>
<li>
<p>
TextColor: White
</p>
</li>
</ul></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_17_button_font.png" alt="Chapter 10 button font" />
</span></p></div>
<div class="paragraph"><p>The frame of the button should be x:25, y:396 and the size should have width:270, height:44. Your UIView should look like</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_18_view_design.png" alt="Chapter 10 view design" />
</span></p></div>
<div class="sect2">
<h3 id="_wiring_our_uiview_to_a_view_controller">Wiring our UIView to a View Controller</h3>
<div class="paragraph"><p>Once we have created our view, we should wire it to our View Controller. The easiest way to do this is to use its <strong>Tag</strong> attribute. <strong>Tag</strong> is an integer property of <strong>UIView</strong> that you can use to identify your views. Basically, you have to set a unique integer for each UIView you need to access from your UIViewController. We are going to start with the Header Image View.</p></div>
<div class="paragraph"><p>Select the UIImageView in the <strong>Objects</strong> section and in the Inspectors select the <strong>Attributes</strong> inspector (the 4th tab). Set its Tag property to 1:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_19_tag.png" alt="Chapter 10 tag attribute" />
</span></p></div>
<div class="paragraph"><p>Do the same for all objects with using these numbers as its tags:</p></div>
<div class="ulist"><ul>
<li>
<p>
Background Image View: 2
</p>
</li>
<li>
<p>
Close button: 3
</p>
</li>
<li>
<p>
Email textfield: 4
</p>
</li>
<li>
<p>
Password textfield: 5
</p>
</li>
<li>
<p>
SignIn button: 6
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now we are ready to import our Xib file into our RubyMotion project.</p></div>
<div class="paragraph"><p>Open in <strong>Finder</strong> the folder of the Xcode Project and locate the <strong>RBMViewController.xib</strong> (hint: it&#8217;s inside a folder named en.lproj) copy it into the <strong>resources</strong> folder of your RubyMotion project.</p></div>
<div class="paragraph"><p>Run</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>rake
</pre></div></div></div>
<div class="paragraph"><p>and you should notice that it compiles the <strong>Xib</strong> file into a <strong>Nib</strong> file.</p></div>
<div class="paragraph"><p>Now let&#8217;s create our Sign In View Controller. Create a file called <strong>sign_in_viewcontroller.rb</strong> in the app/controllers folder. Copy this code</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SignInViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="no">HEADER_IMAGE_VIEW_TAG</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="no">BACKGROUND_IMAGE_VIEW_TAG</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="no">CLOSE_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="no">EMAIL_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="no">PASSWORD_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="no">SIGN_IN_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">6</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are declaring our UIViewController subclass and initializing some constants with the tags that we assigned in Interface Builder, we&#8217;ll use them to wire our variables to those components.</p></div>
<div class="paragraph"><p>Now we are going to add the code to setup our views:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="n">setupHeaderImageView</span>
  <span class="n">setupBackgroundImageView</span>
  <span class="n">setupEmailTextField</span>
  <span class="n">setupPasswordTextField</span>
  <span class="n">setupCloseButton</span>
  <span class="n">setupSignInButton</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupHeaderImageView</span>

  <span class="n">header_image_view</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">HEADER_IMAGE_VIEW_TAG</span><span class="p">)</span>
  <span class="n">header_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTitleBar&#39;</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupBackgroundImageView</span>

  <span class="n">background_image_view</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">BACKGROUND_IMAGE_VIEW_TAG</span><span class="p">)</span>
  <span class="n">background_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgApp&#39;</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupEmailTextField</span>

  <span class="vi">@email_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">EMAIL_TEXTFIELD_TAG</span><span class="p">)</span>
  <span class="vi">@email_textfield</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTextField&#39;</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupPasswordTextField</span>

  <span class="vi">@password_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">PASSWORD_TEXTFIELD_TAG</span><span class="p">)</span>
  <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">background</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgTextField&#39;</span><span class="p">)</span>
  <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupCloseButton</span>

  <span class="vi">@close_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CLOSE_BUTTON_TAG</span><span class="p">)</span>
  <span class="vi">@close_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnCancel&quot;</span><span class="p">),</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="vi">@close_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="n">action</span><span class="ss">:&#39;close&#39;</span><span class="p">,</span> <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">setupSignInButton</span>

  <span class="vi">@sign_in_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">SIGN_IN_BUTTON_TAG</span><span class="p">)</span>
  <span class="vi">@sign_in_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="n">action</span><span class="ss">:&#39;sign_in&#39;</span><span class="p">,</span> <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="vi">@sign_in_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnBrown&quot;</span><span class="p">),</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The first thing you should notice is that we are using the method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">EMAIL_TEXTFIELD_TAG</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>To retrieve a subview of self.view based on its tag. Next, we are doing some additional setup. For instance, we are setting the background image to our image view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">background_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgApp&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>And assigning the Target-Selector to our Buttons:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@close_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="n">action</span><span class="ss">:&#39;close&#39;</span><span class="p">,</span> <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Practically, we have removed all the code related to creating the views and setting their frames.</p></div>
<div class="paragraph"><p>Let&#8217;s try it. Before we could run the example we have to create our new view controller in the <strong>next_event_view_controller.rb</strong>. Open it and locate the method <strong>sign_in</strong> , add this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">button</span><span class="p">)</span>

    <span class="n">signin_controller</span> <span class="o">=</span> <span class="no">SignInViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithNibName</span><span class="p">(</span><span class="s2">&quot;RBMViewController&quot;</span><span class="p">,</span> <span class="n">bundle</span><span class="ss">:nil</span><span class="p">)</span>
    <span class="n">presentModalViewController</span><span class="p">(</span><span class="n">signin_controller</span><span class="p">,</span> <span class="n">animated</span><span class="ss">:true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are creating the View Controller with an initializer called <strong>initWithNibName:bundle</strong> that receives as a parameter the new of the Nib file with the view of the View Controller. This initializer has the responsibility of instantiate the Nib file, and wire the View declared in there to the view property of the View Controller. Exactly what we used to do by hand in the <strong>loadView</strong> method.</p></div>
<div class="paragraph"><p>The <strong>presentModalViewController</strong> method shows the view of the controller passed as an arguments, as a modal view with an animation from the bottom of the screen.</p></div>
<div class="paragraph"><p>Run the app and tap in the <strong>Sign in</strong> button.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_20_signin.png" alt="Chapter 10 tag sign in screen" />
</span></p></div>
<div class="paragraph"><p>Now let&#8217;s implement the logic for the close and sign in methods in the <strong>sign_in_view_controller.rb</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign_in</span>

  <span class="k">if</span> <span class="n">isFormValid</span>

    <span class="n">close</span>
  <span class="k">else</span>

    <span class="n">showAlert</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">title</span><span class="ss">:&quot;Please, fill all the fields.&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">close</span>

  <span class="n">dismissModalViewControllerAnimated</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">isFormValid</span>

  <span class="ow">not</span> <span class="vi">@email_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span> <span class="ow">and</span> <span class="ow">not</span> <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">showAlert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">title</span><span class="ss">:title</span><span class="p">)</span>

  <span class="n">alert</span> <span class="o">=</span> <span class="no">UIAlertView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span>
                      <span class="n">message</span><span class="ss">:message</span><span class="p">,</span>
                      <span class="n">delegate</span><span class="ss">:self</span><span class="p">,</span>
                      <span class="n">cancelButtonTitle</span><span class="ss">:&#39;OK&#39;</span><span class="p">,</span>
                      <span class="n">otherButtonTitles</span><span class="ss">:nil</span><span class="p">)</span>
  <span class="n">alert</span><span class="o">.</span><span class="n">show</span>
<span class="k">end</span>


<span class="c1">#uitextfield delegate methods</span>
<span class="k">def</span> <span class="nf">textFieldShouldReturn</span><span class="p">(</span><span class="n">textField</span><span class="p">)</span>

  <span class="n">textField</span><span class="o">.</span><span class="n">resignFirstResponder</span>
  <span class="kp">false</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the close method we are calling the method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">dismissModalViewControllerAnimated</span><span class="p">:</span>
</pre></div></div></div>
<div class="paragraph"><p>This method is used to close modal views, such as this sign in view.</p></div>
<div class="paragraph"><p>For the sign in, we are validating that the user input some data in both text fields.</p></div>
<div class="paragraph"><p>Another interesting method is <strong>textFieldShouldReturn:</strong> Before we explain what it does, run the example. Type an email and a password. As you can see, the keyboard is hiding the "Sign In" Button:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_21_keyboard.png" alt="Chapter 10 keyboard" />
</span></p></div>
<div class="paragraph"><p>When you press the <strong>Return</strong> button in the keyboard, the keyboard is hidden. That&#8217;s the work of the <strong>textFieldShouldReturn</strong> method. This method is called by the TextField when the user taps on the <strong>Return</strong> button. Inside we are sending the message <strong>resignFirstResponder</strong> to the text field. That message is the one that quits the focus from the text field hidding the keyboard. Without this method, the <strong>Sign in</strong> button could never be tapped.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_sign_up_view">Creating the Sign Up View</h2>
<div class="sectionbody">
<div class="paragraph"><p>Now let&#8217;s create our SignUp View. Back to the Xcode project select in the Main Menu: File &#8594; New &#8594; File. In the Template Dialog, choose iOS User Interface in the left panel and View in the Main Panel:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_22_new_file_dialog.png" alt="Chapter 10 new file dialog" />
</span></p></div>
<div class="paragraph"><p>Type <strong>SignUpView.xib</strong> as the file name. In the Interface Builder, change the Size of the View in the <strong>Attributes</strong> Inspector tap to be
<strong>Retina 3.5 Full Screen</strong> and in the <strong>File</strong> Inspector unselect the <strong>Use AutoLayout</strong> option.</p></div>
<div class="ulist"><ul>
<li>
<p>
Add an UIImageView for the header with a <strong>tag</strong> of 1 and a frame of x:0, y:0, width:320, height:64
</p>
</li>
<li>
<p>
Add an UIImageView to the view that cover the full screen with a <strong>tag</strong> of 2 and a frame of x:0, y:64, width:320, height:396
</p>
</li>
<li>
<p>
Add a Round Rect Button. Set its type to Custom and its title to blank. Set its frame to x:14, y:10, width:56, height:41. Set its <strong>tag</strong> to 3.
</p>
</li>
<li>
<p>
Add a uitextfield with the placeholder set to <strong>email</strong>, its border set to No border. Its frame should be of x:20, y:94, width:289, height:44. Set its <strong>tag</strong> to 4 and its keyboard to <strong>email adreess</strong>.
</p>
</li>
<li>
<p>
Add a uitextfield with the placeholder set to <strong>name</strong>, its border set to No border. Its frame set to x:20, y:159, width:289, height:44. Set its <strong>tag</strong> to 5.
</p>
</li>
<li>
<p>
Add a uitextfield with the placeholder set to <strong>password</strong>, its border set to No border. Set its frame to x:20, y:224, width:289, height:44. Set its <strong>Secure</strong> attribute to true in the <strong>Attributes</strong> inspector. Set its <strong>tag</strong> to 6.
</p>
</li>
<li>
<p>
Add a Round Rect Button. Set its type to Custom, its title to <strong>Register</strong>, its font to Helvetica Neue Medium 18 and its text color to white. Its frame should be x:25, y:396, width:270 and height:44.Set its <strong>tag</strong> to 7.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Because we created this <strong>Xib</strong> file from the scratch, we have to set its <strong>File&#8217;s Owner</strong>. Select the File&#8217;s Owner in the left panel, then select the <strong>Identity</strong> tab in the Inspectors panel. In the Class field type <strong>UIViewController</strong></p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_23_change_identity.png" alt="Chapter 10 change identity" />
</span></p></div>
<div class="paragraph"><p>Now Ctrl+click on the file owner to show its outlets. Drag the <strong>view</strong> outlet to the view in the <strong>Objects</strong> panel. The outlet should appear as linked to a view:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_23_set_outlet.png" alt="Chapter 10 set outlet" />
</span></p></div>
<div class="paragraph"><p>Ok now we have our UIView created in our Xib file. But before we added to our RubyMotion project we&#8217;ll do something extra. In the Sign In view, we added the images programmatically in the View Controller, now we are going to do it using Xcode.</p></div>
<div class="paragraph"><p>Go to your RubyMotion project and copy the following images that are located in the <strong>resources</strong> folder:</p></div>
<div class="ulist"><ul>
<li>
<p>
bgApp.png
</p>
</li>
<li>
<p>
btnBrown.png
</p>
</li>
<li>
<p>
bgTitleBar.png
</p>
</li>
<li>
<p>
btnCancel.png
</p>
</li>
<li>
<p>
bgTextField.png
</p>
</li>
</ul></div>
<div class="paragraph"><p>Copy them to the folder of your Xcode project:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_24_files_copied.png" alt="Chapter 10 files copied" />
</span></p></div>
<div class="paragraph"><p>Now we need to import them to our project. In Xcode, the left panel - the one that shows the files of the project- is the <strong>Project Navigator</strong> If you can not see it, go to the Menu View &#8594; Navigators &#8594; Show project navigator. Ctrl + click on the Folder named <strong>CocoaheadsViews</strong> and choose the <strong>Add files</strong> option. Select the images in the dialog and leave all the options with their default value:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_25_add_files_dialog.png" alt="Chapter 10 add files dialog" />
</span></p></div>
<div class="paragraph"><p>Now back to your View, select the Background UIImageView in the <strong>Objects</strong> panel and in the <strong>Attributes</strong> inspector in the <strong>Image</strong> property, select the bgApp.png image:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_26_set_image.png" alt="Chapter 10 set image" />
</span></p></div>
<div class="paragraph"><p>Select the header image view and set its <strong>Image</strong> attribute to <strong>bgTitleBar</strong>
For the textfields, select each one of them and set its <strong>Background</strong> attribute to <strong>bgTextField.png</strong>
Next, select the cancel Button and set its <strong>Background</strong> attribute to <strong>btnCancel.png</strong>
Finally, select the <strong>Register</strong> button and set its <strong>Background</strong> attribute to the <strong>btnBrown.png</strong> image.</p></div>
<div class="paragraph"><p>Now you have a more accurate design view of your screen in Interface Builder:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_27_design_view.png" alt="Chapter 10 design view" />
</span></p></div>
<div class="paragraph"><p>It&#8217;s important to notice that the images are not inserted into the Xib file, we are only setting references to some image files. As long as you include images with the same name in your RubyMotion Project, this approach will work.</p></div>
<div class="sect2">
<h3 id="_creating_the_sign_up_view_controller">Creating the Sign Up View Controller</h3>
<div class="paragraph"><p>Copy the <strong>SignUpView.xib</strong> into the resources folder of your RubyMotion project. Then create a new file in the controllers folder named <strong>sign_up_view_controller.rb</strong>. The code is very similar to the one we did for the <strong>SignInViewController</strong> :</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SignUpViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="no">CLOSE_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="no">EMAIL_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="no">NAME_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="no">PASSWORD_TEXTFIELD_TAG</span> <span class="o">=</span> <span class="mi">6</span>
  <span class="no">SIGN_UP_BUTTON_TAG</span> <span class="o">=</span> <span class="mi">7</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="vi">@email_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">EMAIL_TEXTFIELD_TAG</span><span class="p">)</span>
    <span class="vi">@name_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">NAME_TEXTFIELD_TAG</span><span class="p">)</span>
    <span class="vi">@password_textfield</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">PASSWORD_TEXTFIELD_TAG</span><span class="p">)</span>
    <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>

    <span class="n">setupCloseButton</span>
    <span class="n">setupSignUpButton</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupCloseButton</span>

    <span class="vi">@close_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">CLOSE_BUTTON_TAG</span><span class="p">)</span>
    <span class="vi">@close_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="n">action</span><span class="ss">:&#39;close&#39;</span><span class="p">,</span> <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupSignUpButton</span>
    <span class="vi">@sign_up_button</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">viewWithTag</span><span class="p">(</span><span class="no">SIGN_UP_BUTTON_TAG</span><span class="p">)</span>
    <span class="vi">@sign_up_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
      <span class="n">action</span><span class="ss">:&#39;sign_up&#39;</span><span class="p">,</span> <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">sign_up</span>

    <span class="k">if</span> <span class="n">isFormValid</span>

      <span class="n">close</span>
    <span class="k">else</span>

      <span class="n">showAlert</span><span class="p">(</span><span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="n">title</span><span class="ss">:&quot;Please, fill all the fields.&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">close</span>

    <span class="n">dismissModalViewControllerAnimated</span> <span class="kp">true</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">isFormValid</span>

    <span class="ow">not</span> <span class="vi">@email_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span> <span class="ow">and</span> <span class="ow">not</span> <span class="vi">@password_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span> <span class="ow">and</span> <span class="ow">not</span> <span class="vi">@name_textfield</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">empty?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">showAlert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">title</span><span class="ss">:title</span><span class="p">)</span>
    <span class="n">alert</span> <span class="o">=</span> <span class="no">UIAlertView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span>
                        <span class="n">message</span><span class="ss">:message</span><span class="p">,</span>
                        <span class="n">delegate</span><span class="ss">:self</span><span class="p">,</span>
                        <span class="n">cancelButtonTitle</span><span class="ss">:&#39;OK&#39;</span><span class="p">,</span>
                        <span class="n">otherButtonTitles</span><span class="ss">:nil</span><span class="p">)</span>
    <span class="n">alert</span><span class="o">.</span><span class="n">show</span>
  <span class="k">end</span>


  <span class="c1">#uitextfield delegate methods</span>
  <span class="k">def</span> <span class="nf">textFieldShouldReturn</span><span class="p">(</span><span class="n">textField</span><span class="p">)</span>

    <span class="n">textField</span><span class="o">.</span><span class="n">resignFirstResponder</span>
    <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The main difference is that we no longer need to access the background view, because is already fully initialized in the Xib file and the same with the Sign Up button, we are only setting its target-selector because it already has its background image defined.</p></div>
</div>
<div class="sect2">
<h3 id="_challenge_4">Challenge</h3>
<div class="paragraph"><p>In the <strong>next_view_controller.rb</strong> modify the <strong>sign_up</strong> method to show our SignUpViewController as a modal view, remember that should pass the name of the Xib file to use as the view.</p></div>
<div class="paragraph"><p>Test it, you should see the SignUp screen:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch10-InterfaceBuilder/ch10_28_sign_up_screen.png" alt="Chapter 10 sign up screen" />
</span></p></div>
<div class="paragraph"><p>Modify the <strong>isFormValid</strong> method in the SignUpViewController to validate that the name has at least 10 characters.</p></div>
</div>
</div>
</div>
<h1 id="_day_3">Day 3</h1>
<h1 id="_chapter_11_view_controllers">Chapter 11 - View Controllers</h1>
<div class="paragraph"><p>In this chapter we are goint to review some basic concepts abouts the lifecycle of UIViewControllers and we will introduce to <strong>UITabBarController</strong> a special UIViewController that helps you to build Tab-based interfaces.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project">Setting up the project</h2>
<div class="sectionbody">
<div class="paragraph"><p>Unzip the <strong>ch11_viewcontrollers_resources.zip</strong> file. It contains our Cocoaheads app that we will use a base for this exercise:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_01_app.png" alt="Chapter 11 app" />
</span></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_our_tabbarcontroller">Creating our TabBarController</h2>
<div class="sectionbody">
<div class="paragraph"><p>Our first task is to create a <strong>UITabBarController</strong> This component creates a tabbar in the bottom of the application and is used to implement a Tab-based navigation in your apps. You can see it in action in the AppStore app or in the Twitter app.</p></div>
<div class="paragraph"><p>Tab-based navigation is very useful, it allows your users to have the main sections of your app always at a glance (at the bottom of the screen). But it has a constraint: it can only have up to 5 tabs. So if your app has more than 5 main sections, you should consider other alternatives.</p></div>
<div class="sect2">
<h3 id="_creating_our_missing_sections">Creating our missing sections</h3>
<div class="paragraph"><p>Our Cocoahead apps will have 3 main sections:</p></div>
<div class="ulist"><ul>
<li>
<p>
Calendar
</p>
</li>
<li>
<p>
Next Event
</p>
</li>
<li>
<p>
News
</p>
</li>
</ul></div>
<div class="paragraph"><p>Until now, we have only created our Next Event screen. So, we are going to start creating the two other sections.</p></div>
<div class="paragraph"><p>Inside the <strong>controller</strong> folder, create two files:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>news_view_controller.rb</strong>
</p>
</li>
<li>
<p>
<strong>calendar_view_controller.rb</strong>
</p>
</li>
</ul></div>
<div class="paragraph"><p>For the first one type this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewsViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;News&quot;</span>
    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>For the Calendar View Controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CalendarViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Calendar&quot;</span>
    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_creating_a_basic_tab_bar_controller">Creating a basic Tab Bar Controller</h3>
<div class="paragraph"><p>Now we can create our Tab Bar Controller. Open the <strong>app_delegate.rb</strong>, as you can see we are creating our NextEventViewController as assigning it to the <strong>window</strong> as its root controller:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">next_event_view_controller</span> <span class="o">=</span> <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
<span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">next_event_view_controller</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
</pre></div></div></div>
<div class="paragraph"><p>We need to change that and pass, instead, a Tab Bar Controller. Change that code to this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">appTabBarController</span>
<span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
</pre></div></div></div>
<div class="paragraph"><p>Now, implement the method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">appTabBarController</span>

  <span class="n">tab_bar_controller</span> <span class="o">=</span> <span class="no">UITabBarController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">viewControllers</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">CalendarViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NewsViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="o">]</span>
  <span class="n">tab_bar_controller</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>A <strong>UITabBarController</strong> needs an array of UIViewControllers. Each one of them will became a Tab in the <strong>UITabBar</strong>. This Controller will render a <strong>UITabBar</strong> in the bottom of the screen of 44 pixels in heigth. For each UIViewController will put a tab, that is actually a <strong>UITabBarItem</strong>. The Tab Bar Controller will use the <strong>title</strong> property of the UIViewController as the name of the tab.</p></div>
<div class="paragraph"><p>Run the app, you will see 3 tabs each one labeled with the title of its UIViewController:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_02_basic_tabbar.png" alt="Chapter 11 basic tab bar" />
</span></p></div>
<div class="paragraph"><p>This the most basic tab bar that you can build. But we will customize it to make it look better.</p></div>
</div>
<div class="sect2">
<h3 id="_customizing_the_uitabbar">Customizing the UITabBar</h3>
<div class="paragraph"><p>Our designer has made a custom tab bar background, you can see it in the resources folder with the name <strong>bgTabBar</strong>. We are going to add it as a custom background for our TabBar:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">appTabBarController</span>

  <span class="n">tab_bar_controller</span> <span class="o">=</span> <span class="no">UITabBarController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">viewControllers</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">CalendarViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NewsViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="o">]</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">tabBar</span><span class="o">.</span><span class="n">backgroundImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span> <span class="s2">&quot;bgTabBar&quot;</span>
  <span class="n">tab_bar_controller</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_03_tabbar_background.png" alt="Chapter 11 custom tabbar" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_customizing_the_uitabbaritems">Customizing the UITabBarItems</h3>
<div class="paragraph"><p>The designer has also made some cool icons for our tabs, we are going to add them to the tab bar.</p></div>
<div class="paragraph"><p>As we have said, the <strong>tabs</strong> are instance of <strong>UITabBarItem</strong>. Each UIViewController has a property called <strong>tabBarItem</strong>. We can easilly create our own. Let&#8217;s try it with the Calendar View Controller.</p></div>
<div class="paragraph"><p>Open the <strong>calendar_view_controller.rb</strong> file and add this code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CalendarViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Calendar&quot;</span>
    <span class="n">setupTabBarItem</span>
    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupTabBarItem</span>

    <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="n">image</span><span class="ss">:UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCalendar&quot;</span><span class="p">),</span> <span class="n">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the <strong>setupTabBarItem</strong> we are creating a UITabVarItem and passing and empty title and a UIImage with our icon. Run the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_04_gray_tabitem.png" alt="Chapter 11 gray tab bar item" />
</span></p></div>
<div class="paragraph"><p>What happened? The icon is blueish. The UITabBarItem, by default, will put all the images that you passed with a blue gradient, discarding the color information of the image and using the alpha channel (transparency) information to know where to apply the gradient. This is enough for basic apps but we want our shinny custom icons with its full color.</p></div>
<div class="paragraph"><p>To do this, we should use a new method added in iOS5, type:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setupTabBarItem</span>

  <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">image</span><span class="ss">:nil</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCalendar&quot;</span><span class="p">),</span> <span class="n">withFinishedUnselectedImage</span><span class="ss">:UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCalendar&quot;</span><span class="p">))</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>As you can see, we are passing a nill image in the Initializer, but then we are setting the <strong>FinishedSelectedImage</strong> and the <strong>FinishedUnselectedImage</strong>. Run the app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_05_calendar_icon.png" alt="Chapter 11 calendar icon" />
</span></p></div>
<div class="paragraph"><p>Now our icon is in full color. Lets add their icons to each View Controller. Open the <strong>next_event_view_controller.rb</strong> and add this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setupTabBarItem</span>

  <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">image</span><span class="ss">:nil</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCurrent&quot;</span><span class="p">),</span> <span class="n">withFinishedUnselectedImage</span><span class="ss">:UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnCurrent&quot;</span><span class="p">))</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Call it from the init:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">super</span>
  <span class="vi">@days_left</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Next Event&quot;</span>
  <span class="n">setupTabBarItem</span>
  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next, open the <strong>news_view_controller.rb</strong> and add this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewsViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;News&quot;</span>
    <span class="n">setupTabBarITem</span>
    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupTabBarITem</span>

    <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="n">image</span><span class="ss">:nil</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">),</span> <span class="n">withFinishedUnselectedImage</span><span class="ss">:UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and you should see the three tabs with color icons:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_06_all_icons.png" alt="Chapter 11 all icons" />
</span></p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_uiviewcontroller_lifecycle">The UIViewController lifecycle</h2>
<div class="sectionbody">
<div class="paragraph"><p>We have reviewed the lifecycle of view controllers, but now lets watch it in action. We are going to use our CalendarViewController as a playground for this.</p></div>
<div class="paragraph"><p>First, lets add a <strong>UITextView</strong>. This component allows to have multiline texts on your screen, moreover, it adds a Scroll to the text if the text goes beyond the bounds of the component.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="vi">@text_view</span> <span class="o">=</span> <span class="n">text_view_for_messages</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@text_view</span><span class="p">)</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> viewDidLoad</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">text_view_for_messages</span>

  <span class="n">text_view</span> <span class="o">=</span> <span class="no">UITextView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="o">[[</span><span class="mi">20</span><span class="p">,</span><span class="mi">40</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="o">]]</span><span class="p">)</span>
  <span class="n">text_view</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">redColor</span>
  <span class="n">text_view</span><span class="o">.</span><span class="n">editable</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">text_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are setting the <strong>editable</strong> property to false, because by default this control allows to the user to type text inside. In this case we only want to put some log messages on it.</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_07_text_view.png" alt="Chapter 11 text view" />
</span></p></div>
<div class="paragraph"><p>Now let&#8217;s add some other methods:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view did appear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewDidDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view did disappear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view will appear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">viewWillDisappear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>

  <span class="k">super</span>
  <span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@text_view</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2"> view will disappear</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and try changing between tabs and watching the messages in our log text view.</p></div>
<div class="paragraph"><p>When the app is first opened, this log appears:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_08_initial_log.png" alt="Chapter 11 initial log" />
</span></p></div>
<div class="paragraph"><p>As you can see, first the <strong>viewDidLoad</strong> is called, then the <strong>viewWillAppear</strong> and finally the <strong>viewDidAppear</strong>. As their name implies, the viewWillAppear method is called before the view is rendered and the viewDidAppear once the views has been rendered.</p></div>
<div class="paragraph"><p>Now if you change the tab and then come back to the Calendar section, you should see this message:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_09_after_tab_log.png" alt="Chapter 11 initial log" />
</span></p></div>
<div class="paragraph"><p>As you can see the methods <strong>viewWillDissapear</strong> and <strong>viewDidDissapear</strong> were called when you change tge tab. When you return, the <strong>viewWillAppear</strong> and <strong>viewDidAppear</strong> methods were called again, but the <strong>viewDidLoad</strong> method was never called.</p></div>
<div class="paragraph"><p>What can we learn from this?</p></div>
<div class="ulist"><ul>
<li>
<p>
The viewDidLoad method is only called once, after the view is loaded into memory. You can use this method to intialize elements that depend of the <strong>view</strong>, such as subviews.
</p>
</li>
<li>
<p>
the viewWillAppear method is called before the UIView is rendered, you can use this method to initialize values that need to be refreshed every time the view will be rendered, such as our "days left until next meeting" view that we have in the next event view controller.
</p>
</li>
<li>
<p>
the viewDidAppear method is called once the UIView was rendered. You can use this method to setup logic that required that the user is actually viewing the view, such as starting animations in that view.
</p>
</li>
<li>
<p>
the viewWillDissapear method is called just before the view dissapears from the screen. You can use it to do logic that require that view is rendered and make no sense to leave it running, such as stoping animations.
</p>
</li>
<li>
<p>
the viewDidDissapear method is called after the view dissapeared from the screen.
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_challenge_5">Challenge</h2>
<div class="sectionbody">
<div class="paragraph"><p>Create the viewWillAppear and viewDidAppear methods in the NextEventViewController. Remember that these methods should call <strong>super</strong>. In the viewWillAppear method, initialize the variable <strong>@days_left</strong> with the value returned from the method <strong>@event.days_left_until(@event.date)</strong>.</p></div>
<div class="paragraph"><p>Now in the <strong>viewDidAppear</strong> update our @days_left_view with that value, remember to call the <strong>setNeedsDisplay</strong>.</p></div>
<div class="paragraph"><p>You should see the screen updated with the days left until the meeting:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch11-ViewControllers/ch11_10_challenge.png" alt="Chapter 11 challenge" />
</span></p></div>
</div>
</div>
<h1 id="_chapter_12_table_views">Chapter 12 - Table Views</h1>
<div class="paragraph"><p>During this workshop, we are going to work with table views and table views controllers. Tables are a common way to organize information in iOS apps, they provide a nice scroll and a vertical layout that makes them very easy to navigate through for looking information on small screens.</p></div>
<div class="sect1">
<h2 id="_setting_up_the_project_2">Setting up the project</h2>
<div class="sectionbody">
<div class="paragraph"><p>Unzip the file <strong>ch12_tableviews_resources.zip</strong>, inside you will find our App from the previous chapter plus a new <strong>News</strong> model class that we will review later:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_01_app.png" alt="Chapter 12 app" />
</span></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_the_news_screen">Implementing the News Screen</h2>
<div class="sectionbody">
<div class="paragraph"><p>During this exercise, we are going to create our News Screen. This screen will present the lates news of Cocoaheads in a list. This kind of interfaces are well suited for using a <strong>UITableView</strong>.</p></div>
<div class="paragraph"><p>The easiest way to use a <strong>UITableView</strong> is to use a <strong>UITableViewController</strong>, thus, we are going to do exactly that.</p></div>
<div class="paragraph"><p>Open the <strong>news_view_controller.rb</strong> file and the first thing we are going to do is to change the Parent class of the file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NewsViewController</span> <span class="o">&lt;</span> <span class="no">UITableViewController</span>

  <span class="k">def</span> <span class="nf">initWithStyle</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>

    <span class="k">super</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;News&quot;</span>
    <span class="n">setupTabBarItem</span>
    <span class="nb">self</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">setupTabBarItem</span>

    <span class="n">tab_bar_item</span> <span class="o">=</span> <span class="no">UITabBarItem</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTitle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="n">image</span><span class="ss">:nil</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tab_bar_item</span><span class="o">.</span><span class="n">setFinishedSelectedImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">),</span> <span class="n">withFinishedUnselectedImage</span><span class="ss">:UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;icnNews&quot;</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tabBarItem</span> <span class="o">=</span> <span class="n">tab_bar_item</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We also removed the <strong>loadView</strong> method. A UITableViewController creates its own view as a UITableView so we don&#8217;t need to create it anymore. Finally, we change our code to use the initializer named <strong>initWithStyle:</strong> This is the initializer method used to create instances of UITableViewController.</p></div>
<div class="paragraph"><p>Now let&#8217;s call this initializer from the <strong>app_delegate.rb</strong> :</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">appTabBarController</span>

  <span class="n">tab_bar_controller</span> <span class="o">=</span> <span class="no">UITabBarController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">viewControllers</span> <span class="o">=</span> <span class="o">[</span>
    <span class="no">CalendarViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NextEventViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span><span class="p">,</span>
    <span class="no">NewsViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewStylePlain</span><span class="p">)</span>
  <span class="o">]</span>
  <span class="n">tab_bar_controller</span><span class="o">.</span><span class="n">tabBar</span><span class="o">.</span><span class="n">backgroundImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span> <span class="s2">&quot;bgTabBar&quot;</span>
  <span class="n">tab_bar_controller</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>UITableViews support two styles:</p></div>
<div class="ulist"><ul>
<li>
<p>
UITableViewStylePlain. A plain table view.
</p>
</li>
<li>
<p>
UITableViewStyleGrouped. A Table with sections in distinct group of rows. Like the ones you can find in the <strong>Settings</strong> app of an iPhone.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Run your app:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_02_empty_table.png" alt="Chapter 12 empty table view" />
</span></p></div>
<div class="paragraph"><p>Right now our table is empty, we need to fill it with the latest news.</p></div>
<div class="paragraph"><p>We have seen that is wise to update data in the <strong>viewWillAppear</strong> method, because that method will be called every time the view is shown. Thus, the user will see the updated news. We have implemented a model class named <strong>News</strong> with a class method called "news_mock". With these in mind we can implement our method to retrieve the news as:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewWillAppear</span>

  <span class="n">load_latest_news</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">load_latest_news</span>

  <span class="vi">@news</span> <span class="o">=</span> <span class="no">News</span><span class="o">.</span><span class="n">news_mock</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">reloadData</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="sect2">
<h3 id="_the_plist_files">The plist files</h3>
<div class="paragraph"><p>From where is the News class taking its data? If you open the class you will see this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">news_mock</span>

  <span class="n">mock_data</span> <span class="o">=</span> <span class="n">news_mock_data</span>
  <span class="n">news_mock</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
  <span class="n">mock_data</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span>
    <span class="n">news</span> <span class="o">=</span> <span class="no">News</span><span class="o">.</span><span class="n">new</span>
    <span class="n">news</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">brief</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;brief&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">item</span><span class="o">[</span><span class="s2">&quot;index&quot;</span><span class="o">]</span>
    <span class="n">news</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="no">NSDate</span><span class="o">.</span><span class="n">date</span>
    <span class="n">news_mock</span> <span class="o">&lt;&lt;</span> <span class="n">news</span>
  <span class="p">}</span>
  <span class="n">news_mock</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">news_mock_data</span>

  <span class="n">mock_data_path</span> <span class="o">=</span> <span class="no">NSBundle</span><span class="o">.</span><span class="n">mainBundle</span><span class="o">.</span><span class="n">pathForResource</span><span class="p">(</span><span class="s2">&quot;news_mock&quot;</span><span class="p">,</span> <span class="n">ofType</span><span class="ss">:&quot;plist&quot;</span><span class="p">)</span>
  <span class="n">news_mock_data</span> <span class="o">=</span> <span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithContentsOfFile</span> <span class="n">mock_data_path</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>In the method <strong>self.news_mock_data</strong> we are loading a file called <strong>news_mock.plist</strong>. <strong>plist</strong> files, or Property list files, are are files that store serialized objects. Objective-C supports these files natively. Locate in the resources folder the news_mock.plist file, if you double click it to open it, you will see that the file is opened in Xcode. Xcode provides a UI to edit this kind of files:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_03_plist_editor.png" alt="Chapter 12 plist editor" />
</span></p></div>
<div class="paragraph"><p>But if you open the file in a text editor, you will notice that is a simple XML file with a custom format. So it&#8217;s very easy to create this kind of files and to store constants into them.</p></div>
<div class="paragraph"><p>Another advantage is that plist files are very easy to load from RubyMotion, because the Foundation classes of Objective-C support them. In this case we can load it to an Array with a single line:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithContentsOfFile</span> <span class="n">mock_data_path</span>
</pre></div></div></div>
<div class="paragraph"><p>This is useful in tests. We can add or delete items to our table by just modifying that file.</p></div>
</div>
<div class="sect2">
<h3 id="_implementing_a_table_view_datasource">Implementing a Table View DataSource</h3>
<div class="paragraph"><p>How do we pass data to our empty table view? As we have seen in the slides, by implementing the methods of UITableViewDataSource. The first step is to tell how many rows should be in the Table View:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span><span class="ss">:section</span><span class="p">)</span>

    <span class="vi">@news</span><span class="o">.</span><span class="n">length</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The content of the rows of a UITableView are called cells and should be subclasses of <strong>UITableViewCell</strong>. So what basically occurs is that the UITableView ask to its DataSource (our NewsViewController) how many rows we want in the table using the <strong>tableView:numberOfRowsInSection:</strong> method. Once we answer that questions, starts to ask us for the cell for each one of the row using this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">NEWS_CELL_REUSE_ID</span> <span class="o">=</span> <span class="s2">&quot;NewsCellId&quot;</span>

<span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">cellForRowAtIndexPath</span><span class="ss">:indexPath</span><span class="p">)</span>

  <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span> <span class="o">||</span> <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleSubtitle</span><span class="p">,</span> <span class="n">reuseIdentifier</span><span class="p">:</span> <span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span>
  <span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">]</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">title</span>
  <span class="n">cell</span><span class="o">.</span><span class="n">detailTextLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">brief</span>
  <span class="n">cell</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>This method is called for each one of the rows in a Table View. Inside you should build your UITableViewCell and return it. There is a catch, the Table View can reuse the same instance to improve the performance of the table. Remember that this component is used to show many rows, literally you can show thousands of them. That is the reason why we are first trying to retrieve a cached cell:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Only if the table view can find a cached cell with that identifier, we build it:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleSubtitle</span><span class="p">,</span> <span class="n">reuseIdentifier</span><span class="p">:</span> <span class="no">NEWS_CELL_REUSE_ID</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>After that, we simple set the textLabel and the detailLabel of the cell with the title and the brief of the news item:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">]</span>
<span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">title</span>
<span class="n">cell</span><span class="o">.</span><span class="n">detailTextLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">news_item</span><span class="o">.</span><span class="n">brief</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example and you should see the list of news item:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_04_news_in_table.png" alt="Chapter 12 news in table" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_implementing_a_table_view_delegate">Implementing a Table View Delegate</h3>
<div class="paragraph"><p>The DataSource tells a UITableView which data to display, but a UITableView is more powerful than a simple List. The UITableViewDelegate protocol defines some other methods that you can implement to manage more functionality of the Table View.</p></div>
<div class="paragraph"><p>We are going to start by handle taps on the rows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">didSelectRowAtIndexPath</span><span class="ss">:indexPath</span><span class="p">)</span>

  <span class="nb">p</span> <span class="s2">&quot;row </span><span class="si">#{</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="si">}</span><span class="s2"> selected&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run the app and tap on a row, you will see the message appearing on the console.</p></div>
<div class="paragraph"><p>Our next step is to add a header to our table. Remember that we have been using a header image in our other views. To do that implement this method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">viewForHeaderInSection</span><span class="ss">:section</span><span class="p">)</span>

  <span class="n">header_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTitleBar&quot;</span><span class="p">))</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">44</span><span class="o">]]</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">setUserInteractionEnabled</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">header_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Using this <strong>tableView:viewForHeaderInSection:</strong> method, you can add any view as header. In this case we are adding an UIImageView with our header image, we are also setting the <strong>userInteractionEnabled</strong> to true because we will need that to add some buttons to that header later.</p></div>
<div class="paragraph"><p>To add a header is not enough we need to change the heigth of the header using this other method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">heightForHeaderInSection</span><span class="ss">:section</span><span class="p">)</span>

  <span class="mi">64</span><span class="o">.</span><span class="mi">0</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your app, you should see the header:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_05_header.png" alt="Chapter 12 header" />
</span></p></div>
</div>
<div class="sect2">
<h3 id="_adding_and_removing_rows">Adding and removing rows</h3>
<div class="paragraph"><p>One interesting thing about Table Views, is that you can program a lot of interactions with them. It even have animation support to provide a smoother interaction with the user. In this case we are going to implement the logic to delete selected rows and to add new rows.</p></div>
<div class="paragraph"><p>The first step is to add two buttons to our header:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">deleteButton</span>
  <span class="n">delete_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeCustom</span><span class="p">)</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">41</span><span class="o">]]</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnBarRed&quot;</span><span class="p">),</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">delete_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="n">action</span><span class="ss">:&quot;delete_selected_cell&quot;</span><span class="p">,</span>
    <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">delete_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">addButton</span>
  <span class="n">add_button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeCustom</span><span class="p">)</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">12</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">41</span><span class="o">]]</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">setBackgroundImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;btnBarRed&quot;</span><span class="p">),</span> <span class="n">forState</span><span class="ss">:UIControlStateNormal</span><span class="p">)</span>
  <span class="n">add_button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
    <span class="n">action</span><span class="ss">:&quot;add_cell&quot;</span><span class="p">,</span>
    <span class="n">forControlEvents</span><span class="ss">:UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="n">add_button</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">delete_selected_cell</span>

<span class="k">end</span>


<span class="k">def</span> <span class="nf">add_cell</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>With this code we are creating our Delete and our Add buttons. Now lets add them to our header:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">viewForHeaderInSection</span><span class="ss">:section</span><span class="p">)</span>

  <span class="n">header_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgTitleBar&quot;</span><span class="p">))</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">320</span><span class="p">,</span> <span class="mi">44</span><span class="o">]]</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">setUserInteractionEnabled</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">deleteButton</span><span class="p">)</span>
  <span class="n">header_view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">addButton</span><span class="p">)</span>
  <span class="n">header_view</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your example and you should see the buttons:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_05_buttons_header.png" alt="Chapter 12 buttons header" />
</span></p></div>
<div class="paragraph"><p>Now let&#8217;s implement the delete functionality:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">delete_selected_cell</span>

  <span class="n">selected_cell_index_path</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">indexPathForSelectedRow</span>

  <span class="k">if</span> <span class="n">selected_cell_index_path</span>

    <span class="n">news_item</span> <span class="o">=</span> <span class="vi">@news</span><span class="o">[</span><span class="n">selected_cell_index_path</span><span class="o">.</span><span class="n">row</span><span class="o">]</span>
    <span class="vi">@news</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">news_item</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">deleteRowsAtIndexPaths</span><span class="p">(</span><span class="o">[</span><span class="n">selected_cell_index_path</span><span class="o">]</span><span class="p">,</span>
      <span class="n">withRowAnimation</span><span class="ss">:UITableViewRowAnimationMiddle</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>First, we are retrieving the indexPath of the current selected cell. If there is actually a selected cell, we are removing the associated news_item from the array. You should be very careful doing this, when you remove cell from a Table View, the Table will ask again for the <strong>tableView:numberOfRowsInSection:</strong> method and it should reflect that are a less number of rows than before the deletion.</p></div>
<div class="paragraph"><p>Then we are deleting the cell with <strong>deleteRowsAtIndexPaths:withRowAnimation</strong>. This is to have a smoother effect. After we remove the element from the <strong>@news</strong> array we could simple refresh the Table View with</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="vi">@tableView</span><span class="o">.</span><span class="n">reloadData</span>
</pre></div></div></div>
<div class="paragraph"><p>And see the row gone, but we wouldn&#8217;t have a nice animation. We are defining the animation to use with the constant <strong>UITableViewRowAnimationMiddle</strong> You can check the UITableView documentation to view more animations that you can use.</p></div>
<div class="paragraph"><p>Now run your app, select a cell and tap the <strong>Delete</strong> button to watch it dissapear.</p></div>
<div class="paragraph"><p>Finally, let&#8217;s implement the add functionality:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_cell</span>

  <span class="n">random_item</span> <span class="o">=</span> <span class="no">News</span><span class="o">.</span><span class="n">self</span><span class="o">.</span><span class="n">news_mock</span><span class="o">[</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span><span class="o">.</span><span class="n">sample</span><span class="o">]</span>
  <span class="n">index_path</span> <span class="o">=</span> <span class="no">NSIndexPath</span><span class="o">.</span><span class="n">indexPathForRow</span><span class="p">(</span><span class="vi">@news</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">inSection</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
  <span class="vi">@news</span> <span class="o">&lt;&lt;</span> <span class="n">random_item</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="n">insertRowsAtIndexPaths</span><span class="p">(</span><span class="o">[</span><span class="n">index_path</span><span class="o">]</span><span class="p">,</span>
    <span class="n">withRowAnimation</span><span class="ss">:UITableViewRowAnimationRight</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>First we are retrieving a randon news item from the original list. Then we are creating a NSIndexPath with the correct row of the new cell (we are adding it at the end of the table). We need to add the news item to our @news array. Remember that is importat to keep the consistency of our DataSource, the Table View will ask it again for the number of rows and for the cell.</p></div>
<div class="paragraph"><p>Finally, we insert the row with an animation.</p></div>
<div class="paragraph"><p>Run your app and tap the <strong>Add</strong> button, you should see rows added with an animation to the bottom of the table:</p></div>
<div class="paragraph"><p><span class="image">
<img src="Resources/ch12-TableViews/ch12_06_add_row.png" alt="Chapter 12 add row" />
</span></p></div>
</div>
</div>
</div>
<h1 id="_chapter_15_notification_center">Chapter 15 - Notification Center</h1>
<div class="sect1">
<h2 id="_digital_photo_frame">Digital Photo Frame</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this chapter we are going to build our own photo frame, but in a more fashion way of course on an iDevice.</p></div>
<div class="paragraph"><p>First at all we have to remember that objects are always sending messages one each other, but some times all objects may be interested in what just one object hast to say, but keep all the objects connected may be not a good strategy, for this reason we have a very handful tool, the notification center.</p></div>
<div class="paragraph"><p>Now its time to create our ViewController that will hold our photo, run the rake command and give "PhotoFrame" as name of the application</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create PhotoFrame
</pre></div></div></div>
<div class="paragraph"><p>Now create a new file named <strong>photo_frame_view_controller.rb</strong> in app folder and add the following code. Don&#8217;t forget to add the image that comes in your chapter folder named frame.png and copy it to the resources folder.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and run the rake command:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>Don&#8217;t forget to set it as rootViewController in your <strong>app_delegate.rb</strong> file because this ViewController will be useful for present our photo and also use the photo that comes in chapter 15 directory and paste it in your resources folder.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="no">PhotoFrameViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>The next step is add an UIImage to our PhotoFrameViewController feel free to create a file for the uielemtens like <strong>photo_view_utilities.rb</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">photoUIImageView</span>

  <span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;me.png&quot;</span><span class="p">)</span>
  <span class="n">photoView</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span>  <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>
  <span class="n">photoView</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Don&#8217;t forget to add the image to the view in the PhotoFrameViewController</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotoFrameViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">viewDidLoad</span>

    <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
    <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">photoUIImageView</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save your file and compile the project to see if everything goes well, You will be able to see a wild cat:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_PictureFrame.png" alt="Picture Frame" />
</div>
<div class="title">Figure 19. Picture Frame</div>
</div>
<div class="paragraph"><p>Now Rotate the simulator or the device.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_LandscapeFrame.png" alt="Landscape Frame" />
</div>
<div class="title">Figure 20. Landscape Frame</div>
</div>
<div class="paragraph"><p>What just happened here? Everything indicates that the image did not adjust accordingly to the orientation.
It may be useful if the device can tell us when it rotates so we can act in response; guess what actually it tell us, we just have to listen carefully or in this case subscribe our view controller to this notification.</p></div>
<div class="sect2">
<h3 id="_uidevice_notification">UIDevice Notification</h3>
<div class="paragraph"><p>Let&#8217;s add register our photocontroller to receive notifications when the orientation of the device changes, add the following methods in your <strong>photo_frame_view_controller.rb</strong> file</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">orientationChanged</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

  <span class="nb">puts</span> <span class="n">notification</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">orientation</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">registerDeviceNotification</span>

    <span class="c1"># Get the device object</span>
    <span class="n">device</span> <span class="o">=</span> <span class="no">UIDevice</span><span class="o">.</span><span class="n">currentDevice</span>
    <span class="c1"># Tell it to start monitoring the accelerometer for orientation</span>
    <span class="n">device</span><span class="o">.</span><span class="n">beginGeneratingDeviceOrientationNotifications</span>
    <span class="c1"># Get the notification center for the app</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="no">NSNotificationCenter</span><span class="o">.</span><span class="n">defaultCenter</span>
    <span class="c1"># Add yourself as an observer</span>
    <span class="n">nc</span><span class="o">.</span><span class="n">addObserver</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span> <span class="ss">:&#39;orientationChanged:&#39;</span><span class="p">,</span><span class="nb">name</span><span class="ss">:UIDeviceOrientationDidChangeNotification</span> <span class="p">,</span><span class="n">object</span><span class="ss">:device</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>You can rotate tour simulator by holding the <em>command</em> key and use the directions arrows, you will notice a series of number form 1 to 4 printed on your console, but that number means? In fact there are an enumeration:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
   <span class="n">UIDeviceOrientationUnknown</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationPortrait</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationPortraitUpsideDown</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationLandscapeLeft</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationLandscapeRight</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationFaceUp</span><span class="p">,</span>
   <span class="n">UIDeviceOrientationFaceDown</span>
<span class="p">}</span> <span class="n">UIDeviceOrientation</span><span class="p">;</span>
</pre></div></div></div>
<div class="paragraph"><p>After know that, we can make a little improvements to our method  <strong><strong>orientationChanged</strong></strong> in our <strong>photo_frame_view_controller.rb</strong> file.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">orientationChanged</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

  <span class="n">deviceOrientation</span> <span class="o">=</span> <span class="n">notification</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">orientation</span>
    <span class="k">if</span> <span class="n">deviceOrientation</span> <span class="o">==</span> <span class="no">UIDeviceOrientationLandscapeLeft</span> <span class="o">||</span> <span class="n">deviceOrientation</span> <span class="o">==</span> <span class="no">UIDeviceOrientationLandscapeRight</span>

      <span class="vi">@imageView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>

    <span class="k">else</span>
      <span class="vi">@imageView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Run your application and rotate the device, and watch carefully the landscape mode</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_LandscapePicture.png" alt="Landscape Picture" />
</div>
<div class="title">Figure 21. Landscape Picture</div>
</div>
</div>
<div class="sect2">
<h3 id="_autorotation">Autorotation</h3>
<div class="paragraph"><p>Rotation it’s a very common task between iOS applications, you can use UIDevice Notification, but this may be a lot of work, instead we can use autorotation for this purpose.</p></div>
<div class="paragraph"><p>We can achieve this if the view is controlled by an UIViewController, we ask to a view controller if its okay to rotate the view, if the view controller agrees, the view it&#8217;s rotated and resized also it&#8217;s subviews.</p></div>
<div class="paragraph"><p>For this purpose we need to add the following method to our <strong>photo_frame_view_controller.rb</strong>, and don&#8217;t subscribe to the UIDevice Notifications in the viewDidLoad Method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
  <span class="vi">@imageView</span> <span class="o">=</span> <span class="n">photoUIImageView</span><span class="p">;</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@imageView</span><span class="p">)</span>
  <span class="c1">#registerDeviceNotification</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">shouldAutorotateToInterfaceOrientation</span><span class="p">(</span><span class="n">interfaceOrientation</span><span class="p">)</span>

  <span class="c1"># Return YES if incoming orientation is Portrait</span>
  <span class="c1">#  or either of the Landscapes, otherwise, return NO</span>
  <span class="n">shouldRotate</span> <span class="o">=</span> <span class="no">NO</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">interfaceOrientation</span> <span class="o">==</span> <span class="no">UIInterfaceOrientationPortrait</span><span class="p">)</span> <span class="o">||</span> <span class="no">UIInterfaceOrientationIsLandscape</span><span class="p">(</span><span class="n">interfaceOrientation</span><span class="p">)</span>
    <span class="n">shouldRotate</span> <span class="o">=</span> <span class="no">YES</span>
  <span class="k">end</span>

  <span class="n">shouldRotate</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>At this point it seems that our previous work has disappeared, and its because we did not tell how the UIImage should be resized, let&#8217;s modified the methods that return the UIImageView whit the following autoresizing mask:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">photoUIImageView</span>

  <span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;me.png&quot;</span><span class="p">)</span>
  <span class="n">photoView</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span>  <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">420</span><span class="p">)</span>
  <span class="c1">#The view resizes by expanding or shrinking its width.</span>
  <span class="c1">#The view resizes by expanding or shrinking its height.</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">setAutoresizingMask</span><span class="p">(</span><span class="no">UIViewAutoresizingFlexibleWidth</span> <span class="o">|</span> <span class="no">UIViewAutoresizingFlexibleHeight</span><span class="p">)</span>
  <span class="n">photoView</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Save and then run your application, now all the previous work has returned
,as you can see the view  adjusts it&#8217;s size automatically when devices rotates, fortunately we have additional resize masks</p></div>
<div class="ulist"><ul>
<li>
<p>
UIViewAutoresizingFlexibleLeftMargin
</p>
</li>
<li>
<p>
UIViewAutoresizingFlexibleRightMargin
</p>
</li>
<li>
<p>
UIViewAutoresizingFlexibleTopMargin
</p>
</li>
<li>
<p>
UIViewAutoresizingFlexibleBottomMargin
</p>
</li>
</ul></div>
<div class="paragraph"><p>The only thing left its add a more fancy frame so we can get rid off that ugly gray background, open your <strong>photo_view_utilities.rb</strong> file and add the following method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">frameUIImageView</span>

  <span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;frame.png&quot;</span><span class="p">)</span>
  <span class="n">photoView</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span>  <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">460</span><span class="p">)</span>
  <span class="n">photoView</span><span class="o">.</span><span class="n">setAutoresizingMask</span><span class="p">(</span><span class="no">UIViewAutoresizingFlexibleWidth</span> <span class="o">|</span> <span class="no">UIViewAutoresizingFlexibleHeight</span><span class="p">)</span>
  <span class="n">photoView</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now in your <strong>photo_frame_view_controller.rb</strong> add the frame image just before adding the picture image</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">viewDidLoad</span>

  <span class="vi">@imageView</span> <span class="o">=</span> <span class="n">photoUIImageView</span><span class="p">;</span>
  <span class="n">frameView</span> <span class="o">=</span> <span class="n">frameUIImageView</span><span class="p">;</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">frameView</span><span class="p">)</span>
  <span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@imageView</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch15-Notifications/ch15_PhotoFrameApp.png" alt="Photo Frame App" />
</div>
<div class="title">Figure 22. Photo Frame App</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenge_status_bar">Challenge - Status Bar</h3>
<div class="paragraph"><p>It seems that the only element that not fits right on this picture, its the status bar, try to remove it so we can appreciate in all the screen, add the following line at the beginning of your viewDidLoad method</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">UIApplication</span><span class="o">.</span><span class="n">sharedApplication</span><span class="o">.</span><span class="n">setStatusBarHidden</span><span class="p">(</span><span class="kp">true</span> <span class="p">,</span><span class="n">animated</span><span class="ss">:false</span><span class="p">)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_challenges_2">Challenges</h3>
<div class="paragraph"><p>*It will be nice if our digital photo frame could tell us the battery level, subscribe to UIDeviceBatteryLevelDidChangeNotification and enable batteryMonitoringEnabled.
Add a label that indicates the level of the battery, green when its above 10% and red when get lower or equal than 10%</p></div>
<div class="paragraph"><p>*Allow only portrait mode for the app, because in land scape we can looks like a little bit stretch</p></div>
</div>
</div>
</div>
<h1 id="_day_4">Day 4</h1>
<h1 id="_chapter_19_multitouch">Chapter 19 - Multitouch</h1>
<div class="paragraph"><p>One of the best features of the iPhone or iPad is the touch screen, in this chapter we will use it to make a app for drawing on the screen</p></div>
<div class="sect1">
<h2 id="_kanji_master">Kanji Master</h2>
<div class="sectionbody">
<div class="paragraph"><p>One of the most difficult languages to learn is Japanese because they use one symbol (Kanji) to express full concepts. This is different than most of the languages, because they use words (Multiple symbols: letters) for the same purpose.</p></div>
<div class="paragraph"><p>In this exercise we will create a app that will teach the user how to draw a Kanji, allowing him to paint the shape with his fingers on the screen.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_Kanji.png" alt="Kanji" />
</div>
<div class="title">Figure 23. Kanji</div>
</div>
<div class="sect2">
<h3 id="_preparing_the_canvas">Preparing the Canvas</h3>
<div class="paragraph"><p>Lets start creating a new project called <strong>KanjiMaster</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create KanjiMaster
</pre></div></div></div>
<div class="paragraph"><p>Please copy the resources from <strong>DEFINE DEPLOYMENT PATH</strong> into the project resources folder, after that create the following file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>KanjiMaster/app

<span class="nv">$ </span>mkdir views

<span class="nv">$ </span>touch kanji_view.rb

<span class="nv">$ </span>open kanji_view.rb
</pre></div></div></div>
<div class="paragraph"><p>Now add the following to our <strong>kanji_view.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">KanjiView</span> <span class="o">&lt;</span> <span class="no">UIView</span>

  <span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="c1"># In order to does not hide the background image on</span>
      <span class="c1"># the controllers view, we need to set the background color on</span>
      <span class="c1"># this view as transparent</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>

      <span class="c1"># We need to set multipleTouchEnabled to true if we want to handle</span>
      <span class="c1"># more than one finger touching the screen</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">multipleTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>

      <span class="c1"># Instance an Array for storing the user touches</span>
      <span class="vi">@touch_points</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="k">end</span>

    <span class="nb">self</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Lets create a controller for our new view with the name <strong>KanjiViewController</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch kanji_view_controller.rb

<span class="nv">$ </span>open kanji_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Insert the following into the <strong>kanji_view_controller.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">KanjiViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Create a new UIImageView to draw our background image</span>
    <span class="n">background_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Set our background image into the UIImageView</span>
    <span class="n">background_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgKanji.jpg&quot;</span><span class="p">)</span>

    <span class="c1"># Add the UIImageView instance into the view</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">background_image_view</span><span class="p">)</span>

    <span class="c1"># Load our custom UIView (KanjiView)</span>
    <span class="n">kanjiView</span> <span class="o">=</span> <span class="no">KanjiView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Add it to our view controller&#39;s view</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">kanjiView</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Finally lets open our <strong>app_delegate.rb</strong> and add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

    <span class="c1">#Create an instance of Kanji View Controller</span>
    <span class="n">kanji_view_controller</span> <span class="o">=</span> <span class="no">KanjiViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1">#Every window has a root view controller from which it will present its view</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">kanji_view_controller</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>

    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run the app, you should see the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_InitialApplication.png" alt="Initial Application" />
</div>
<div class="title">Figure 24. Initial Application</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_responder_chain">The Responder Chain</h3>
<div class="paragraph"><p>If you look closely on the project that we just create, we have to implement a custom view called <strong>KanjiView</strong>. The purpose of this is that we can catch the touch events on it. But why on a UIView?</p></div>
<div class="paragraph"><p>When the user touch the screen a new event is created and send as a message to the first responder (The most foremost view in the hierarchy), if it cannot handle the message, is forwarded to the "next responder" and so on. This linked series is called <strong>Responder Chain</strong></p></div>
<div class="paragraph"><p>In iOS (not as same as Mac) both UIViews and UIViewControllers are part of the <strong>Responder Chain</strong>, but typically just the Views can handle the touch events, this happens because by default the UIViewControllers can not become fist responders</p></div>
<div class="paragraph"><p>According to the above we need a object that can become first responder and be in the responder chain so it can handle the touch events, this object generally is a UIView</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you need by any reason to handle the touch events on your controller, you can override the method <strong>canBecomeFirstResponder</strong> to allow it to become first responder</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_handling_the_touches">Handling the Touches</h3>
<div class="paragraph"><p>Now that we understand the Responder Chain, How to handle the touches? The response is implementing the following methods on our view:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers) touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

<span class="c1"># This method is called when the finger (or fingers) are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

<span class="c1"># This method is called when the finger (or fingers) leave the screen</span>
<span class="k">def</span> <span class="nf">touchesEnded</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="ss">:event</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>For testing proposes lets implement it on our <strong>KanjiView</strong> the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="no">NSLog</span><span class="p">(</span><span class="s2">&quot;Touch %@ starting on %@&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="no">NSStringFromCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

<span class="k">end</span>

<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="no">NSLog</span><span class="p">(</span><span class="s2">&quot;Touch %@ moving to %@&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="no">NSStringFromCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

<span class="k">end</span>

<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># leave the screen</span>
<span class="k">def</span> <span class="nf">touchesEnded</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="ss">:event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="no">NSLog</span><span class="p">(</span><span class="s2">&quot;Touch %@ ended at %@&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="no">NSStringFromCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run the application we should see the following when we touch the screen:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>&gt; Touch 1 starting on <span class="o">{</span>147, 305<span class="o">}</span>
&gt; Touch 2 starting on <span class="o">{</span>117, 205<span class="o">}</span>
&gt; Touch 1 moving to <span class="o">{</span>151, 297<span class="o">}</span>
&gt; Touch 2 moving to <span class="o">{</span>179, 327<span class="o">}</span>
&gt; Touch 1 moving to <span class="o">{</span>153, 294<span class="o">}</span>
&gt; Touch 2 moving to <span class="o">{</span>178, 323<span class="o">}</span>
&gt; Touch 1 moving to <span class="o">{</span>155, 289<span class="o">}</span>
&gt; Touch 2 moving to <span class="o">{</span>179, 326<span class="o">}</span>
&gt; Touch 1 ended at <span class="o">{</span>178, 319<span class="o">}</span>
&gt; Touch 2 ended at <span class="o">{</span>198, 119<span class="o">}</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Are you using the iOS Simulator? No problem! You can also simulate multiple touches pressing <strong>alt</strong> and if you need to move the multiple touches together press <strong>alt + shift</strong></td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_painting_the_touches">Painting the Touches</h3>
<div class="paragraph"><p>Now that we have detected the touches, its time to paint them on the screen. For that we will use a technology called CoreGraphics, but before we use it we need to understand some key concepts:</p></div>
<div class="ulist"><ul>
<li>
<p>
If we want to draw on a UIView using CoreGraphics we need to do it in a method called <strong>drawRect</strong>, its a override and you shouldn&#8217;t implemented unless your will draw something (It affects performance when its not drawing)
</p>
</li>
<li>
<p>
The drawing on a UIView using Core Graphics its not additive, what this means is that I can&#8217;t draw a line and then later when the user touches the screen draw another (I can&#8217;t  call <strong>drawRect</strong> manually). For that purpose we need to store which lines will be painted and then call <strong>setNeedsDisplay</strong>, this method will clear the entire view and then call <strong>drawRect</strong> again, forcing repainting everything again.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Using the above information lets implement the user touches on the screen:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method where we need to do the Core Graphics drawing</span>
<span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="c1"># Get the Core Graphics current context</span>
  <span class="n">context</span> <span class="o">=</span> <span class="no">UIGraphicsGetCurrentContext</span><span class="p">()</span>

  <span class="c1"># Set a color for drawing the touch points</span>
  <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set</span>

  <span class="c1"># Iterate the touch points</span>
  <span class="vi">@touch_points</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch_point</span> <span class="o">|</span>

    <span class="c1"># Move the context to the touch point</span>
    <span class="no">CGContextMoveToPoint</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># Create a rect in which want to the ellipse be drawn</span>
    <span class="n">point_rect</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="n">point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="n">point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="mi">20</span><span class="p">,</span>
                            <span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Add the ellipse using the rect into the context</span>
    <span class="no">CGContextAddEllipseInRect</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">point_rect</span><span class="p">)</span>

    <span class="c1"># Draw the context into the view</span>
    <span class="no">CGContextFillPath</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="c1"># Add the point to our array, but because is a structure (CGPoint)</span>
    <span class="c1"># we need to store it on a NSValue</span>
    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="c1"># Ask the view to redraw again</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_InitialTouches.png" alt="Initial Touches" />
</div>
<div class="title">Figure 25. Initial Touches</div>
</div>
<div class="paragraph"><p>Great! Now we are really seeing where the user touches began, lets continue adding the touch movements:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">If you are using a simulator probably you will notice that the dot is painted down right of the cursor. This is normal because iOS handle the mouse click as the top left corner of a finger</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1">#  Touches is an set of UITouch, each of them</span>
  <span class="c1">#  represent a diferent finger on the screen</span>
  <span class="n">touches</span><span class="o">.</span><span class="n">allObjects</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch</span><span class="p">,</span> <span class="n">index</span> <span class="o">|</span>

    <span class="c1"># We need to ask the touch for his location according</span>
    <span class="c1"># to the current view</span>
    <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touch</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>

    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_InitialLines.png" alt="Initial Lines" />
</div>
<div class="title">Figure 26. Initial Lines</div>
</div>
<div class="paragraph"><p>Now we are drawing the initial touches and the movement in the screen, it looks like a line but if we move the finger faster will become more like a dotted line right? No problem we will fix that later</p></div>
</div>
<div class="sect2">
<h3 id="_kanji_drawing">Kanji Drawing</h3>
<div class="paragraph"><p>We just play a bit with the touches and drawing for us to feel comfortable about how it works, lets do something more challenging:</p></div>
<div class="paragraph"><p>If we look on our background picture, we have a Kanji with traces marked with numbers. The objective is create a little game for the user to draw the Kanji, so our first task is to determinate if the user is following the traces or not</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_StartingPoints.png" alt="Starting Points" />
</div>
<div class="title">Figure 27. Starting Points</div>
</div>
<div class="paragraph"><p>The first thing we can do is to have an array of the trace starting coordinates, that will enable us to evaluate if the touch was on the beginning. Lets do a little experiment to test this part:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># In order to does not hide the background image on</span>
    <span class="c1"># the controllers view, we need to set the background color on</span>
    <span class="c1"># this view as transparent</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>

    <span class="c1"># Instance an Array for storing the user touches</span>
    <span class="vi">@touch_points</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="n">load_kanji_traces</span>
  <span class="k">end</span>

  <span class="nb">self</span>

<span class="k">end</span>

<span class="k">def</span> <span class="nf">load_kanji_traces</span>

  <span class="c1"># Create an array to store our Kanji Paths</span>
  <span class="vi">@kanji_traces</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># As a experiment lets add only the starting point of</span>
  <span class="c1"># the trace number three</span>
  <span class="n">kanji_starting_trace_three</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>


  <span class="c1"># Add the point to the Kanji Paths array</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">kanji_starting_trace_three</span><span class="p">))</span>
<span class="k">end</span>



<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1"># We need to ask the touch for his location according</span>
  <span class="c1"># to the current view</span>
  <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>


  <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Iterate through all the Kanji Paths available</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">kanji_trace</span> <span class="o">|</span>

    <span class="c1"># If the touched point is equal to any Kanji Trace starting</span>
    <span class="c1"># point</span>
    <span class="k">if</span> <span class="no">CGPointEqualToPoint</span><span class="p">(</span><span class="n">kanji_trace</span><span class="o">.</span><span class="n">CGPointValue</span><span class="p">,</span> <span class="n">pointInView</span><span class="p">)</span>

      <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="p">}</span>


  <span class="c1"># If the touch was at the beginning of any Kanji Trace</span>
  <span class="k">unless</span> <span class="n">touch_at_beginning</span>

    <span class="c1"># Add the point to our array, but because is a structure (CGPoint)</span>
    <span class="c1"># we need to store it on a NSValue</span>
    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>

    <span class="c1"># Ask the view to redraw again</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Impossible do it with the first touch (Without moving the touch), right? This is because we are comparing a small point in the screen with a wide of a finger, making it difficult to touch with precision. The solution to this is creating a rectangle surrounding the starting trace point, so it will be more easy to hit it with the finger.</p></div>
<div class="paragraph"><p>Actually also we need to evaluate if the user is following the trace, and if it the trace ended where it should, for this we will use rectangles as well. In the light of this is better to create a object for all this variables.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Remember it does not matter if it is a point, rectangle or a button, it needs to be bigger enough for the user to touch</td>
</tr></table>
</div>
<div class="paragraph"><p>Lets create our new class <strong>KanjiTrace</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>mkdir models

<span class="nv">$ </span><span class="nb">cd </span>models

<span class="nv">$ </span>touch kanji_trace.rb

<span class="nv">$ </span>open kanji_trace.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">KanjiTrace</span>

  <span class="no">SURROUND_SIZE</span> <span class="o">=</span> <span class="mi">40</span>

  <span class="kp">attr_accessor</span> <span class="ss">:starting_point</span>
  <span class="kp">attr_accessor</span> <span class="ss">:end_point</span>


  <span class="k">def</span> <span class="nf">initial_rectangle</span>

    <span class="no">GPointMake</span><span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="n">starting_point</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">end</span>


  <span class="k">def</span> <span class="nf">final_rectangle</span>

    <span class="no">GPointMake</span><span class="p">(</span><span class="n">end_point</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="n">end_point</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
               <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great! Now we have a object containing the trace start and end points and it return the surrounding rectangles. Lets implement the <strong>KanjiTrace</strong> class into our <strong>kanji_view.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>open kanji_view.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_kanji_traces</span>

  <span class="c1"># Create an array to store our Kanji Paths</span>
  <span class="vi">@kanji_traces</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>


  <span class="c1"># Continuing the experiment create only a Kanji Trace</span>
  <span class="c1"># for the trace number three</span>
  <span class="n">trace_three</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>

  <span class="n">trace_three</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>

  <span class="c1"># Add the point to the Kanji Paths array</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_three</span><span class="p">)</span>
<span class="k">end</span>



<span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># touch the screen for the first time</span>
<span class="k">def</span> <span class="nf">touchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1"># We need to ask the touch for his location according</span>
  <span class="c1"># to the current view</span>
  <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>


  <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># Iterate through all the Kanji Paths available</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">kanji_trace</span> <span class="o">|</span>

    <span class="c1"># If the touched point is equal to any Kanji Trace starting</span>
    <span class="c1"># point</span>
    <span class="k">if</span> <span class="no">CGRectContainsPoint</span><span class="p">(</span><span class="n">kanji_trace</span><span class="o">.</span><span class="n">initial_rectangle</span><span class="p">,</span> <span class="n">pointInView</span><span class="p">)</span>

      <span class="c1"># Assign the trace that the user is currently</span>
      <span class="c1"># drawing</span>
      <span class="vi">@current_trace</span> <span class="o">=</span> <span class="n">kanji_trace</span>
      <span class="n">touch_at_beginning</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="p">}</span>


  <span class="c1"># If the touch was at the beginning of any Kanji Trace</span>
  <span class="k">if</span> <span class="n">touch_at_beginning</span>

    <span class="c1"># Add the point to our array, but because is a structure (CGPoint)</span>
    <span class="c1"># we need to store it on a NSValue</span>
    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>

    <span class="c1"># Ask the view to redraw again</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>

  <span class="k">else</span>

    <span class="c1"># If there is no touch at the beginning means</span>
    <span class="c1"># that the user is not drawing a new trace</span>
    <span class="vi">@current_trace</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_StartTrace3.png" alt="Start Trace #3" />
</div>
<div class="title">Figure 28. Start Trace #3</div>
</div>
<div class="paragraph"><p>Is working now! Is more easy for the user to touch the start of the trace, so lets continue adding the all the Kanji Traces:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_kanji_traces</span>

  <span class="c1"># Create an array to store our Kanji Paths</span>
  <span class="vi">@kanji_traces</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>


  <span class="n">trace_one</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_one</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
  <span class="n">trace_one</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">273</span><span class="p">,</span> <span class="mi">282</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_one</span><span class="p">)</span>


  <span class="n">trace_two</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_two</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">155</span><span class="p">,</span> <span class="mi">285</span><span class="p">)</span>
  <span class="n">trace_two</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">289</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_two</span><span class="p">)</span>


  <span class="c1"># Continuing the experiment create only a Kanji Trace</span>
  <span class="c1"># for the trace number three</span>
  <span class="n">trace_three</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_three</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">260</span><span class="p">)</span>
  <span class="n">trace_three</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">152</span><span class="p">,</span> <span class="mi">367</span><span class="p">)</span>

  <span class="c1"># Add the point to the Kanji Paths array</span>
  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_three</span><span class="p">)</span>


  <span class="n">trace_four</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_four</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>
  <span class="n">trace_four</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">294</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_four</span><span class="p">)</span>


  <span class="n">trace_five</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_five</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">225</span><span class="p">,</span> <span class="mi">175</span><span class="p">)</span>
  <span class="n">trace_five</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">140</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_five</span><span class="p">)</span>


  <span class="n">trace_six</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_six</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">219</span><span class="p">,</span> <span class="mi">202</span><span class="p">)</span>
  <span class="n">trace_six</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">277</span><span class="p">,</span> <span class="mi">237</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_six</span><span class="p">)</span>


  <span class="n">trace_seven</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_seven</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">69</span><span class="p">,</span> <span class="mi">191</span><span class="p">)</span>
  <span class="n">trace_seven</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_seven</span><span class="p">)</span>


  <span class="n">trace_eight</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_eight</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">211</span><span class="p">)</span>
  <span class="n">trace_eight</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">247</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_eight</span><span class="p">)</span>


  <span class="n">trace_nine</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_nine</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">109</span><span class="p">,</span> <span class="mi">171</span><span class="p">)</span>
  <span class="n">trace_nine</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">185</span><span class="p">,</span> <span class="mi">159</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_nine</span><span class="p">)</span>


  <span class="n">trace_ten</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_ten</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">171</span><span class="p">)</span>
  <span class="n">trace_ten</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">186</span><span class="p">,</span> <span class="mi">241</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_ten</span><span class="p">)</span>


  <span class="n">trace_eleven</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_eleven</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">175</span><span class="p">,</span> <span class="mi">227</span><span class="p">)</span>
  <span class="n">trace_eleven</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">235</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_eleven</span><span class="p">)</span>


  <span class="n">trace_twelve</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_twelve</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">223</span><span class="p">)</span>
  <span class="n">trace_twelve</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">181</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_twelve</span><span class="p">)</span>


  <span class="n">trace_thirteen</span> <span class="o">=</span> <span class="no">KanjiTrace</span><span class="o">.</span><span class="n">new</span>
  <span class="n">trace_thirteen</span><span class="o">.</span><span class="n">starting_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">161</span><span class="p">)</span>
  <span class="n">trace_thirteen</span><span class="o">.</span><span class="n">end_point</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">129</span><span class="p">)</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">trace_thirteen</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_AllStartingTraces.png" alt="All Starting Traces" />
</div>
<div class="title">Figure 29. All Starting Traces</div>
</div>
<div class="paragraph"><p>Yes! We can start painting on any trace now, so lets continue adding a method to our <strong>KanjiTrace</strong> for evaluate if the user is following the line and assigning a score for the drawing:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>models

<span class="nv">$ </span>open <span class="s2">&quot;kanji_trace.rb&quot;</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kp">attr_reader</span> <span class="ss">:accurate_points</span>

<span class="k">def</span> <span class="nf">evaluate_point</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

  <span class="c1"># Lets create properties to store the accurate touches of</span>
  <span class="c1"># the user and the missing ones</span>
  <span class="vi">@accurate_points</span> <span class="o">||=</span> <span class="mi">0</span>
  <span class="vi">@missing_points</span> <span class="o">||=</span> <span class="mi">0</span>

  <span class="c1"># The next step is creating a surrounding rectangle for the</span>
  <span class="c1"># trace, make it more easy for the user to touch</span>
  <span class="n">trace_rect</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="o">[</span><span class="n">starting_point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end_point</span><span class="o">.</span><span class="n">x</span><span class="o">].</span><span class="n">min</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
                          <span class="o">[</span><span class="n">starting_point</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">end_point</span><span class="o">.</span><span class="n">y</span><span class="o">].</span><span class="n">min</span> <span class="o">-</span> <span class="no">SURROUND_SIZE</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">end_point</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span> <span class="o">+</span> <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="p">(</span><span class="n">starting_point</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">end_point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span> <span class="o">+</span> <span class="no">SURROUND_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>


  <span class="c1"># If the point is in the trace</span>
  <span class="k">if</span> <span class="no">CGRectContainsPoint</span><span class="p">(</span><span class="n">trace_rect</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>

    <span class="c1"># Add one to the accurate points</span>
    <span class="vi">@accurate_points</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">else</span>

    <span class="c1"># Add one to the missing points</span>
    <span class="vi">@missing_points</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Our <strong>KanjiTrace</strong> is now evaluating and recording the score, next step is to used in our <strong>kanji_view.rb</strong> on the touchesMoved method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>views

<span class="nv">$ </span>open kanji_view.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># This method is called when the finger (or fingers)</span>
<span class="c1"># are moving without leaving the screen</span>
<span class="k">def</span> <span class="nf">touchesMoved</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>

  <span class="c1"># We need to ask the touch for his location according</span>
  <span class="c1"># to the current view</span>
  <span class="n">pointInView</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>


  <span class="c1"># If the user is drawing a trace</span>
  <span class="k">unless</span> <span class="vi">@current_trace</span><span class="o">.</span><span class="n">nil?</span>

    <span class="c1"># Add the touch point into the array, so it can be</span>
    <span class="c1"># drawing later</span>
    <span class="vi">@touch_points</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">pointInView</span><span class="p">))</span>

    <span class="c1"># Evaluate how accurate is the touch in relationship</span>
    <span class="c1"># to the trace</span>
    <span class="vi">@current_trace</span><span class="o">.</span><span class="n">evaluate_point</span><span class="p">(</span><span class="n">pointInView</span><span class="p">)</span>

    <span class="c1"># Ask for repainting</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">setNeedsDisplay</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Yeah now we are keeping a score about how accurate is the user drawing, but we are not doing nothing with it! Our next step is just about that!</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_PaintedTrace.png" alt="Painted Trace" />
</div>
<div class="title">Figure 30. Painted Trace</div>
</div>
</div>
<div class="sect2">
<h3 id="_high_score">High Score!</h3>
<div class="paragraph"><p>So as the Kanji description tell us is that is a technique for building cups of tea, so what about adding some disable cups on the top of the app to symbolize the score of the user (3 disable cups mean 0 right?)</p></div>
<div class="paragraph"><p>So the first thing will be copy the images in <strong>DEFINE DEPLOYMENT PATH</strong> into our app resource&#8217;s folder, next add the follow to the <strong>kanji_view.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">initWithFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># In order to does not hide the background image on</span>
    <span class="c1"># the controllers view, we need to set the background color on</span>
    <span class="c1"># this view as transparent</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">clearColor</span>

    <span class="c1"># Instance an Array for storing the user touches</span>
    <span class="vi">@touch_points</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="n">layout_cups</span>
    <span class="n">load_kanji_traces</span>

  <span class="k">end</span>

  <span class="nb">self</span>

<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_cups</span>

  <span class="n">first_cup_frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

  <span class="vi">@first_cup_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="n">first_cup_frame</span><span class="p">)</span>

  <span class="vi">@first_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOff1.png&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@first_cup_image_view</span><span class="p">)</span>


  <span class="n">second_cup_frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

  <span class="vi">@second_cup_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="n">second_cup_frame</span><span class="p">)</span>

  <span class="vi">@second_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOff2.png&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@second_cup_image_view</span><span class="p">)</span>


  <span class="n">thrid_cup_frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">215</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

  <span class="vi">@thrid_cup_image_view</span> <span class="o">=</span> <span class="no">UIImageView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="n">thrid_cup_frame</span><span class="p">)</span>

  <span class="vi">@thrid_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOff3.png&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@thrid_cup_image_view</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_ScoreBoard.png" alt="Score Board" />
</div>
<div class="title">Figure 31. Score Board</div>
</div>
<div class="paragraph"><p>The last part of the exercise consist of analyzing the score of all the traces and according to that change the images of the cups. Making a little scoreboard!</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method where we need to do the Core Graphics drawing</span>
<span class="k">def</span> <span class="nf">drawRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

  <span class="n">update_score_board</span>

  <span class="c1"># Get the Core Graphics current context</span>
  <span class="n">context</span> <span class="o">=</span> <span class="no">UIGraphicsGetCurrentContext</span><span class="p">()</span>

  <span class="c1"># Set a color for drawing the touch points</span>
  <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">set</span>

  <span class="c1"># Iterate the touch points</span>
  <span class="vi">@touch_points</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">touch_point</span> <span class="o">|</span>

    <span class="c1"># Move the context to the touch point</span>
    <span class="no">CGContextMoveToPoint</span><span class="p">(</span><span class="n">context</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                         <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

  <span class="c1"># Create a rect in which want to the ellipse be drawen</span>
  <span class="n">point_rect</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                          <span class="n">touch_point</span><span class="o">.</span><span class="n">CGPointValue</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span>
                          <span class="mi">20</span><span class="p">,</span>
                          <span class="mi">20</span><span class="p">)</span>

  <span class="c1"># Add the ellipse using the rect into the context</span>
  <span class="no">CGContextAddEllipseInRect</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">point_rect</span><span class="p">)</span>

  <span class="c1"># Draw the context into the view</span>
  <span class="no">CGContextFillPath</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
  <span class="p">}</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">update_score_board</span>

  <span class="n">total_accurate_points</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="vi">@kanji_traces</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">kanji_trace</span> <span class="o">|</span>

      <span class="k">unless</span> <span class="n">kanji_trace</span><span class="o">.</span><span class="n">accurate_points</span><span class="o">.</span><span class="n">nil?</span>

        <span class="n">total_accurate_points</span> <span class="o">+=</span> <span class="n">kanji_trace</span><span class="o">.</span><span class="n">accurate_points</span>
      <span class="k">end</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">total_accurate_points</span> <span class="o">&gt;=</span> <span class="mi">100</span>

    <span class="vi">@first_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOn1.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">total_accurate_points</span> <span class="o">&gt;=</span> <span class="mi">300</span>

    <span class="vi">@second_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOn2.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">total_accurate_points</span> <span class="o">&gt;=</span> <span class="mi">500</span>

    <span class="vi">@thrid_cup_image_view</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s1">&#39;bgRakuOn3.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch19-Multitouch/ch19_HighScore.png" alt="High Score" />
</div>
<div class="title">Figure 32. High Score</div>
</div>
<div class="paragraph"><p>Now is finished! It looks like it will need some animations for the cups to look amazing, in the next chapters we will see how to make animations</p></div>
</div>
<div class="sect2">
<h3 id="_challenges_3">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Restart the game when the user double tap the screen (Hint: tapCount)
</p>
</li>
<li>
<p>
Implement a point subtraction of the trace score, when the user draws outside the trace, but without loosing the ability to  get the maximum score
</p>
</li>
<li>
<p>
The current implementation is drawing every point into the view, the challenge is change that into drawing just one line starting in the first touch and ending when the user removes the finger (Hint: CGContextAddLineToPoint)
</p>
</li>
</ol></div>
</div>
</div>
</div>
<h1 id="_chapter_20_calayers">Chapter 20 - CALayers</h1>
<div class="paragraph"><p>In this chapter we will use a Cocoa Touch Framework called Core Animation. This framework is has two main purposes: Composition and Animation, taking this as base we will look into the Composition part first.</p></div>
<div class="sect1">
<h2 id="_composition">Composition</h2>
<div class="sectionbody">
<div class="paragraph"><p>Speaking in terms of Visual Arts, the term <strong>Composition</strong> is the placement or arrangement of visual elements to integrate a work of art. The Visual Artists (Most of them Graphical Designers) execute this technique in Photographs, Paints, or Designs.</p></div>
<div class="paragraph"><p>Until this part of the course we just have seen an object used to draw something in the screen: The <strong>UIView</strong>. Speaking in terms of memory and performance the UIView is a heavyweight champion, what this means is that it takes a lot of resources to animate it or display multiple of them on the screen. (You can try it! Load more than 50 UIViews with different colors on any project).</p></div>
<div class="paragraph"><p>Because of this if we want to create a complex composition we need a more light object, and it is called "CALayer". If the UIViews are a 1 Dollar in terms of memory and performance, the CALayer is 15 Cents.</p></div>
<div class="paragraph"><p>So the next question will be, why we are still using UIViews? The correct answer is that the CALayers have less features like the support for gestures, easy custom drawing using Core Graphics (You can do it on the CALayer but is more complex to implement), auto resizing masks. Besides what you will see in terms of implementation in the following exercises.</p></div>
<div class="paragraph"><p>Said this its a great time to start coding:</p></div>
<div class="sect2">
<h3 id="_initial_project">Initial Project</h3>
<div class="paragraph"><p>As we have seen through the course, the way to create a new Project is the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create Layers
</pre></div></div></div>
<div class="paragraph"><p>For us to use the Core Animation Framework first we need to add it to the app, open the <strong>Rake File</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>Layers

<span class="nv">$ </span>open Rakefile
</pre></div></div></div>
<div class="paragraph"><p>To add a new framework to the app, you need to add the last line in the method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="no">Motion</span><span class="o">::</span><span class="no">Project</span><span class="o">::</span><span class="no">App</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>

  <span class="c1"># Use `rake config&#39; to see complete project settings.</span>
  <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Layers&#39;</span>

  <span class="n">app</span><span class="o">.</span><span class="n">frameworks</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;QuartzCore&quot;</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Next we need to add a View Controller where we will implement a CALayer, lets call it <strong>Layer View Controller</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>mkdir controllers

<span class="nv">$ </span><span class="nb">cd </span>controllers

<span class="nv">$ </span>touch layer_view_controller.rb

<span class="nv">$ </span>open layer_view_controller.rb
</pre></div></div></div>
<div class="paragraph"><p>Add the following code to our new file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">LayerViewController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>

  <span class="k">def</span> <span class="nf">loadView</span>

    <span class="c1"># Lets create a view for our view controller</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">255</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># When we create a new instance of a CALayer, the designated initializer</span>
    <span class="c1"># is the following one</span>
    <span class="n">red_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
    <span class="n">red_layer</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">redColor</span><span class="o">.</span><span class="n">CGColor</span>

    <span class="c1"># A difference from a UIView is that the CALayer uses the frame only</span>
    <span class="c1"># to determine its size, the position is set in the position property</span>
    <span class="c1"># this is required because the Layers has it position in the center of it</span>
    <span class="c1"># instead of top left corner, like the UIView.</span>
    <span class="n">red_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">red_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="c1"># The view has a property called layer, every UIView has a layer inside</span>
    <span class="c1"># it. So we can add our layer as a sublayer of that one.</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">red_layer</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take a moment to understand the changes related to the coordinate system on the CALayer (Hint: Frame &amp; Position)</td>
</tr></table>
</div>
<div class="paragraph"><p>Lets continue opening the Application Delegate and adding the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

  <span class="c1">#Create an instance of Layer View Controller</span>
  <span class="n">layer_view_controller</span> <span class="o">=</span> <span class="no">LayerViewController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1">#Every window has a root view controller from which it will present its view</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">layer_view_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run the App you must see the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL1.png" alt="Initial Run" />
</div>
<div class="title">Figure 33. Initial Run</div>
</div>
</div>
<div class="sect2">
<h3 id="_changing_layers">Changing Layers</h3>
<div class="paragraph"><p>Lets use a little of REPL to illustrate some points, please look at your terminal at the same time with the simulator, and execute the following:</p></div>
<div class="paragraph"><p>First select the blue view using CMD + click on it, later run this on your console:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer = self.layer.sublayers.objectAtIndex(0)</span>
<span class="o">=</span>&gt; <span class="c">#&lt;CALayer:0x000000&gt;</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Take note that you can not select Layers using the CMD + click</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.backgroundColor = UIColor.colorWithRed(0.957, green:0.824, blue:0.184, alpha:1.0).CGColor</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL2.png" alt="Yellow Square" />
</div>
<div class="title">Figure 34. Yellow Square</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.position = CGPointMake(100, 100)</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL3.png" alt="Yellow Square in a Different Position" />
</div>
<div class="title">Figure 35. Yellow Square in a Different Position</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.cornerRadius = 20</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL4.png" alt="Yellow Square with Rounded Corners" />
</div>
<div class="title">Figure 36. Yellow Square with Rounded Corners</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.borderWidth = 10</span>
<span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.borderColor = UIColor.colorWithRed(0.988, green:0.604, blue:0.153, alpha:1.0).CGColor</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL5.png" alt="Yellow Square with Border" />
</div>
<div class="title">Figure 37. Yellow Square with Border</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.shadowRadius = 5.0</span>
<span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.shadowColor = UIColor.blackColor.CGColor</span>
<span class="o">(</span><span class="c">#&lt;UIView:0x000000)&gt; layer.shadowOpacity = 0.65</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_REPL6.png" alt="Yellow Square with Shadow" />
</div>
<div class="title">Figure 38. Yellow Square with Shadow</div>
</div>
<div class="paragraph"><p>They are two things important in this part, the first is that you can manipulate the appearance in more ways using a CALayer than a UIView like the Rounded Corners, Shadows, etc. Also if you look closely you must see that when you change some properties of the layer it animates it self, we will look into more deeply later on.</p></div>
</div>
<div class="sect2">
<h3 id="_putting_the_things_together">Putting the things together</h3>
<div class="paragraph"><p>Now that we have see the CALayers in action, is time to do somethings more complicated. Open your LayerViewController and add the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>open layer_view_controller.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_background_layer</span>

  <span class="c1"># We need a new type of layer used to create Gradients</span>
  <span class="vi">@background_layer</span> <span class="o">=</span> <span class="no">CAGradientLayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>

  <span class="c1"># Initialize the colors of the gradient, it can have any number of colors</span>
  <span class="c1"># in this case we will use only three</span>
  <span class="n">top_background_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">131</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">387</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">618</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>
  <span class="n">middle_background_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">255</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>
  <span class="n">bottom_background_color</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">367</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">692</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>

  <span class="c1"># Set the colors in the layer using an array</span>
  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithObjects</span><span class="p">(</span><span class="n">top_background_color</span><span class="p">,</span>
                                                     <span class="n">middle_background_color</span><span class="p">,</span>
                                                     <span class="n">bottom_background_color</span><span class="p">,</span>
                                                     <span class="kp">nil</span><span class="p">)</span>

  <span class="c1"># Set the colors locations into the array, this means where it will start painting</span>
  <span class="c1"># the color, if you look closely we are telling the layer to paint the top color in</span>
  <span class="c1"># 0.0 which is the top, the middle in 0.5 and 0.0 for the bottom color</span>
  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">locations</span> <span class="o">=</span> <span class="no">NSArray</span><span class="o">.</span><span class="n">arrayWithObjects</span><span class="p">(</span><span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">),</span>
                                                        <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">),</span>
                                                        <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">),</span>
                                                        <span class="kp">nil</span><span class="p">)</span>

  <span class="c1"># We want this layer to be the background of our app</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">insertSublayer</span><span class="p">(</span><span class="vi">@background_layer</span><span class="p">,</span> <span class="n">atIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_GradientBackground.png" alt="Background with Gradient" />
</div>
<div class="title">Figure 39. Background with Gradient</div>
</div>
<div class="paragraph"><p>Easy right? We create a nice background for our app using a gradient. Lets continue adding some grass into the composition:</p></div>
<div class="paragraph"><p>Please copy the <strong>Determine deployment target</strong> into our app resources folder, after that add the following method to our <strong>LayerViewController</strong> class</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_grass_layer</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">layout_grass_layer</span>

  <span class="c1">#Lets instance a new layer for containing our grass image</span>
  <span class="n">grass_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">grass_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span>

  <span class="c1">#Load the image into memory</span>
  <span class="n">grassImage</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgGrass.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">grass_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">grassImage</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">grass_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_GrassLayer.png" alt="Grass Layer" />
</div>
<div class="title">Figure 40. Grass Layer</div>
</div>
<div class="paragraph"><p>Great! Now you see that we are compositing two layers together and learn that you can also include an Image as a content. But how about drawing custom figures? Add the following to the <strong>LayerViewController</strong> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_grass_layer</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_sun_layer</span>

  <span class="c1"># Create a new type of layer, in this case CAShapeLayer</span>
  <span class="vi">@sun_layer</span> <span class="o">=</span> <span class="no">CAShapeLayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

  <span class="c1"># Set some color for the figure fill and the stroke</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">fillColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">957</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">824</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">184</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">strokeColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">604</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">153</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span>

  <span class="c1"># We need to set a line width of 10 for this particular figure</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">lineWidth</span> <span class="o">=</span> <span class="mi">10</span>


  <span class="c1"># The following part is the path that composes the figure</span>
  <span class="c1"># point by point into the layer</span>
  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>

  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">91</span><span class="o">.</span><span class="mi">15</span><span class="p">,</span> <span class="mi">48</span><span class="o">.</span><span class="mi">53</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">91</span><span class="o">.</span><span class="mi">15</span><span class="p">,</span> <span class="mi">48</span><span class="o">.</span><span class="mi">53</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">106</span><span class="o">.</span><span class="mo">00</span><span class="p">,</span> <span class="mi">41</span><span class="o">.</span><span class="mi">88</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">114</span><span class="o">.</span><span class="mi">90</span><span class="p">,</span> <span class="mi">55</span><span class="o">.</span><span class="mi">50</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">130</span><span class="o">.</span><span class="mi">99</span><span class="p">,</span> <span class="mi">57</span><span class="o">.</span><span class="mi">94</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">131</span><span class="o">.</span><span class="mi">11</span><span class="p">,</span> <span class="mi">74</span><span class="o">.</span><span class="mi">21</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">143</span><span class="o">.</span><span class="mi">33</span><span class="p">,</span> <span class="mi">84</span><span class="o">.</span><span class="mi">95</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">134</span><span class="o">.</span><span class="mi">63</span><span class="p">,</span> <span class="mi">98</span><span class="o">.</span><span class="mi">71</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">139</span><span class="o">.</span><span class="mi">10</span><span class="p">,</span> <span class="mi">114</span><span class="o">.</span><span class="mi">35</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">124</span><span class="o">.</span><span class="mi">35</span><span class="p">,</span> <span class="mi">121</span><span class="o">.</span><span class="mi">22</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">119</span><span class="o">.</span><span class="mi">65</span><span class="p">,</span> <span class="mi">136</span><span class="o">.</span><span class="mi">80</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">103</span><span class="o">.</span><span class="mi">53</span><span class="p">,</span> <span class="mi">134</span><span class="o">.</span><span class="mi">60</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">91</span><span class="o">.</span><span class="mi">15</span><span class="p">,</span> <span class="mi">145</span><span class="o">.</span><span class="mi">17</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">78</span><span class="o">.</span><span class="mi">78</span><span class="p">,</span> <span class="mi">134</span><span class="o">.</span><span class="mi">60</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">62</span><span class="o">.</span><span class="mi">66</span><span class="p">,</span> <span class="mi">136</span><span class="o">.</span><span class="mi">80</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">57</span><span class="o">.</span><span class="mi">96</span><span class="p">,</span> <span class="mi">121</span><span class="o">.</span><span class="mi">22</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">43</span><span class="o">.</span><span class="mi">21</span><span class="p">,</span> <span class="mi">114</span><span class="o">.</span><span class="mi">35</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">47</span><span class="o">.</span><span class="mi">68</span><span class="p">,</span> <span class="mi">98</span><span class="o">.</span><span class="mi">71</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">38</span><span class="o">.</span><span class="mi">98</span><span class="p">,</span> <span class="mi">84</span><span class="o">.</span><span class="mi">95</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">51</span><span class="o">.</span><span class="mi">20</span><span class="p">,</span> <span class="mi">74</span><span class="o">.</span><span class="mi">21</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">51</span><span class="o">.</span><span class="mi">32</span><span class="p">,</span> <span class="mi">57</span><span class="o">.</span><span class="mi">94</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">67</span><span class="o">.</span><span class="mi">41</span><span class="p">,</span> <span class="mi">55</span><span class="o">.</span><span class="mi">50</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addLineToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">76</span><span class="o">.</span><span class="mi">31</span><span class="p">,</span> <span class="mi">41</span><span class="o">.</span><span class="mi">88</span><span class="p">))</span>

  <span class="n">sun_path</span><span class="o">.</span><span class="n">closePath</span>

  <span class="c1"># Set the path into the layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span><span class="p">;</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_SunLayer.png" alt="Sun Layer" />
</div>
<div class="title">Figure 41. Sun Layer</div>
</div>
</div>
<div class="sect2">
<h3 id="_implicit_animations">Implicit Animations</h3>
<div class="paragraph"><p>When you change some properties of a CALayer at run time, what happens is that the properties are modified in an animated way. This properties that trigger animations are called <strong>Animatable Properties</strong>, and some of them are the following:</p></div>
<div class="ulist"><ul>
<li>
<p>
anchorPoint
</p>
</li>
<li>
<p>
backgroundColor
</p>
</li>
<li>
<p>
borderColor
</p>
</li>
<li>
<p>
borderWidth
</p>
</li>
<li>
<p>
bounds
</p>
</li>
<li>
<p>
cornerRadius
</p>
</li>
<li>
<p>
mask
</p>
</li>
<li>
<p>
opacity
</p>
</li>
<li>
<p>
position
</p>
</li>
<li>
<p>
shadowColor
</p>
</li>
<li>
<p>
shadowOffset
</p>
</li>
<li>
<p>
shadowOpacity
</p>
</li>
<li>
<p>
shadowRadius
</p>
</li>
</ul></div>
<div class="paragraph"><p>For this to happen a process works inside of Core Animation called <strong>Interpolation</strong>, the best way to explain it is using a example:</p></div>
<div class="paragraph"><p>Lets say that you implemented a layer, but its needed when the user touches the screen to disappear the layer. Do this is pretty straight forward, just set the opacity property to 0.0. Inside Core Animation the next will happen:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Because we are using a implicit animation, the default time for the whole animation is 0.3
</p>
</li>
<li>
<p>
Core Animation calculates the value at every millisecond that takes to execute the animation. Starting at second 0 with 1.0, 0.1 with 0.65, 0.2 with 0.45, 0.3 with 0.0. This process of determining the values of a property (or properties) at every given time of the animation is called <strong>Interpolation</strong>
</p>
</li>
<li>
<p>
Then the resulting matrix property values and times is executed, giving the effect that the layer is being animated.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If you think it its similar that the old cartoon animation process. Having the mouse drawn frame by frame and flipping them it quickly does the same trick.</p></div>
<div class="paragraph"><p>Enough of theory, lets do this in a practical way. Insert the following to the <strong>LayerViewController</strong> class:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_grass_layer</span>

  <span class="c1"># Instantiate a gesture recognizer to handle the user touch</span>
  <span class="n">tap_gesture_recognizer</span> <span class="o">=</span> <span class="no">UITapGestureRecognizer</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                                                       <span class="n">action</span><span class="ss">:&#39;view_tap:&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>

  <span class="c1">#Apply the position to our Sun Layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">tap_point_in_view</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now when you touch the screen the sun layer will animate to that particular position. Try another appearance changes or look again in the REPL part of the exercise.</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch20-CALayers/ch20_AnimatedLayer.png" alt="Sun Layer" />
</div>
<div class="title">Figure 42. Animated Layer</div>
</div>
</div>
<div class="sect2">
<h3 id="_challenges_4">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
At the same time the sun layer is moving to a new position, rotate it like it was spinning. (HINT: CGTransformationMatrix)
</p>
</li>
<li>
<p>
Change the background of the application when the sun layer is on top, and on bottom. Like if it was sunrise, dawn and night
</p>
</li>
</ol></div>
</div>
</div>
</div>
<h1 id="_chapter_21_core_animation">Chapter 21 - Core Animation</h1>
<div class="paragraph"><p>In this chapter we will continue learning Core Animation implementing more complex animations and transitions.</p></div>
<div class="paragraph"><p>Lets begin! When you need more control on the animation, lets say move the layer along a path, control the duration or some easing, its required that you implement a explicit animation.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Easing</div>
<div class="paragraph"><p>Easing means to control the acceleration or deceleration of the objects in the animation. This is used to simulate real life forces like friction or gravity.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Next we will look into the most basic type of explicit animations, CABasicAnimation</p></div>
<div class="sect1">
<h2 id="_cabasicanimation">CABasicAnimation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Its a single key-frame animation, this means that you can only set the initial and final step of such application. An proper example will illustrate this better:</p></div>
<div class="paragraph"><p>You need to move a layer from point A to point B. The initial step is A and the final is B, this is case of a single key-frame, but if you need to move from point A passing through point C, then point D and finally B this is a multi key-frame, which will cover it later.</p></div>
<div class="paragraph"><p>In this perspective this kind of explicit animations are a lot like the implicit ones, the difference is that you can have more control on it like:</p></div>
<div class="ulist"><ul>
<li>
<p>
Setting some delay on the animation
</p>
</li>
<li>
<p>
Know when the animation finished
</p>
</li>
<li>
<p>
Animation duration
</p>
</li>
<li>
<p>
Combine multiple animations at once
</p>
</li>
<li>
<p>
Reverse the animation on finish
</p>
</li>
<li>
<p>
Repeat the animation indefinitely
</p>
</li>
</ul></div>
<div class="paragraph"><p>The first thing we can do is change the sun move animation which is implicit to a explicit one, for this lets open our <strong>Layer</strong> project, and edit the <strong>view_tap</strong> method to look like the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one,</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>


  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position_animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationBlinkToStart.png" alt="Animation Blinking to Start" />
</div>
<div class="title">Figure 43. Animation Blinking to Start</div>
</div>
<div class="paragraph"><p>Uh? What happen? The sun move to the position we touch, but at the end of the animation it return to its initial value. This happens because the animation is independent of the layer that is running into, it will move the layer to the touch position but at the end if you don&#8217;t change the layer property it will return to the initial state.</p></div>
<div class="paragraph"><p>Try the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>


  <span class="c1"># Change the layer property that we want to be animated, the position of</span>
  <span class="c1"># this line is important. It must be before the addAnimation message.</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">tap_point_in_view</span>

  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position_animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationComplete.png" alt="Animation Complete" />
</div>
<div class="title">Figure 44. Animation Complete</div>
</div>
<div class="paragraph"><p>Now it works as expected! The animation is pretty slow because we set to it 1 second, try changing it for more fun.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Interpolation</div>
<div class="paragraph"><p>Did you notice that close the distance of the animation is more slow? This is because it has to cover less distance in the same duration.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Lets try something new, reverse the animation once is finished. This is accomplished with the following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>

  <span class="c1"># Tell the animation that we need to reverse at finish</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">autoreverses</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position_animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationReturningToStartingPoint.png" alt="Animation Returning to Starting Point" />
</div>
<div class="title">Figure 45. Animation Returning to Starting Point</div>
</div>
<div class="paragraph"><p>If we want to make that cycle of moving and returning happen 100 times?</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>

  <span class="c1"># Tell the animation that we need to reverse at finish</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">autoreverses</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Set the repeat count to 100</span>
  <span class="n">animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="mi">100</span>

  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position_animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationLoop.png" alt="Animation Loop" />
</div>
<div class="title">Figure 46. Animation Loop</div>
</div>
<div class="paragraph"><p>What about combining two animations: a spinning one with the moving one</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">view_tap</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="c1">#Get the position of the touch according to the view</span>
  <span class="n">tap_point_in_view</span> <span class="o">=</span> <span class="n">tap_gesture_recognizer</span><span class="o">.</span><span class="n">locationInView</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="p">)</span>


  <span class="c1"># When we create an instance of a CABasicAnimation, its needed</span>
  <span class="c1"># to set which property we want to animate. In this case the property</span>
  <span class="c1"># is position, but it can be backgroundColor, cornerRadius or any other</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">tap_point_in_view</span><span class="p">)</span>


  <span class="c1"># Change the layer property that we want to be animated, the position of</span>
  <span class="c1"># this line is important. It must be before the addAnimation message.</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">tap_point_in_view</span>

  <span class="c1"># Add the animation to the layer that we want to animate, and set a</span>
  <span class="c1"># name for it, in this case position animation. The name is used</span>
  <span class="c1"># if later we need to access the animation again in another part of the code</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;translation_animation&#39;</span><span class="p">)</span>


  <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
  <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
  <span class="c1"># y axis</span>
  <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>

  <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
  <span class="c1"># thats why the conversion PI * 2</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="no">Math</span><span class="o">::</span><span class="no">PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

  <span class="c1"># Set the duration according with the other animation</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># Add the animation to the layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;rotation_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationSpinning.png" alt="Animation Spinning and Moving" />
</div>
<div class="title">Figure 47. Animation Spinning and Moving</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_moving_the_clouds">Moving the clouds</h2>
<div class="sectionbody">
<div class="paragraph"><p>The sun looks a little lonely right? What about adding some clouds and make them move across the screen?</p></div>
<div class="paragraph"><p>The first step is adding the images of the clouds, please copy them from <strong>Define deployment target</strong> into the resources folder of the app.</p></div>
<div class="paragraph"><p>Next lets add the layers into our view, in the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1"># Instantiate a gesture recognizer to handle the user touch</span>
  <span class="n">tap_gesture_recognizer</span> <span class="o">=</span> <span class="no">UITapGestureRecognizer</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                                                       <span class="n">action</span><span class="ss">:&#39;view_tap:&#39;</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">tap_gesture_recognizer</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_cloud_layers</span>
  <span class="n">layout_grass_layer</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">layout_cloud_layers</span>

  <span class="c1">#Lets instance a new layer for our first cloud image</span>
  <span class="n">first_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">82</span><span class="p">)</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="c1">#Load the image into memory</span>
  <span class="n">first_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud1.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">first_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="p">)</span>


  <span class="c1"># New layer for our second cloud image</span>
  <span class="n">second_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud2.png&quot;</span><span class="p">)</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">second_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">second_cloud_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If we run now the application, you should see the following:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunAndClouds.png" alt="Sun & Clouds" />
</div>
<div class="title">Figure 48. Sun &amp; Clouds</div>
</div>
<div class="paragraph"><p>Pretty but not amazing!, Now lets add some animation to the clouds:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layout_cloud_layers</span>

  <span class="c1"># Lets instance a new layer for our first cloud image</span>
  <span class="n">first_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">82</span><span class="p">)</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">153</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="c1"># Load the image into memory</span>
  <span class="n">first_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud1.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">first_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="p">)</span>


  <span class="c1"># Instanciate a new animation for the first cloud move</span>
  <span class="n">first_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

   <span class="c1"># Set the animation duration</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">7</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

  <span class="c1"># Final position for the first cloud</span>
  <span class="n">first_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">473</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_final_position</span><span class="p">)</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">first_cloud_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>



  <span class="c1"># New layer for our second cloud image</span>
  <span class="n">second_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">185</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud2.png&quot;</span><span class="p">)</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">second_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">second_cloud_layer</span><span class="p">)</span>


  <span class="c1"># Instanciate a new animation for the second cloud move</span>
  <span class="n">second_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

  <span class="c1"># Final position for the second cloud</span>
  <span class="n">second_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">505</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">second_cloud_final_position</span><span class="p">)</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">second_cloud_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take notice that the cloud position changed</td>
</tr></table>
</div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationClouds.png" alt="Cloud Animation" />
</div>
<div class="title">Figure 49. Cloud Animation</div>
</div>
<div class="paragraph"><p>Yes, it looks kind of good. But the animation is too linear the clouds does not look like the real life, what we can do is adding some easing with a timing function. The objective is when the cloud appear on the screen go faster and then it decelerate until its finished. This kind of easing is called EasyOut:</p></div>
<div class="paragraph"><p>Lets apply it to the code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">layout_cloud_layers</span>

  <span class="c1"># Lets instance a new layer for our first cloud image</span>
  <span class="n">first_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">82</span><span class="p">)</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">153</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="c1"># Load the image into memory</span>
  <span class="n">first_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud1.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">first_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="p">)</span>


  <span class="c1"># Instanciate a new animation for the first cloud move</span>
  <span class="n">first_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

   <span class="c1"># Set the animation duration</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">7</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

  <span class="c1"># Final position for the first cloud</span>
  <span class="n">first_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">473</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>

  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_final_position</span><span class="p">)</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">first_cloud_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseOut</span><span class="p">)</span>

  <span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">first_cloud_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>



  <span class="c1"># New layer for our second cloud image</span>
  <span class="n">second_cloud_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span>
  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">185</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgCloud2.png&quot;</span><span class="p">)</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">second_cloud_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="n">second_cloud_layer</span><span class="p">)</span>


  <span class="c1"># Instanciate a new animation for the second cloud move</span>
  <span class="n">second_cloud_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="c1"># We need to set the initial value of the animation and the final one</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">fromValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">first_cloud_layer</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

  <span class="c1"># Final position for the second cloud</span>
  <span class="n">second_cloud_final_position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">505</span><span class="p">,</span> <span class="mi">130</span><span class="p">)</span>

  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="n">second_cloud_final_position</span><span class="p">)</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>


  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">second_cloud_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseOut</span><span class="p">)</span>

  <span class="n">second_cloud_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">second_cloud_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_AnimationCloudsWithEasing.png" alt="Cloud Animation with Easing" />
</div>
<div class="title">Figure 50. Cloud Animation with Easing</div>
</div>
<div class="paragraph"><p>Subtle right? Thats the idea! It now looks more that the wind blows stronger at the first and then it slows down. But what is really happening?</p></div>
<div class="paragraph"><p>Do you remember the part of the interpolation? We were saying in that moment that it is the calculus between the initial value and the final every millisecond of the sequence. It means that if we move 3 points during 3 seconds, it will move one point per second right?</p></div>
<div class="paragraph"><p>Yes it does if our timing function is linear (Which is the default), but if we change that to a EasyIn what is really happening is that in the first second it moves 1.5 points, in the second 1 point and in the final second .5 points. Thats makes the illusion of decelerating</p></div>
<div class="paragraph"><p>In iOS they are 4 default easing available for the timing functions:</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_Easings.png" alt="iOS Easings" />
</div>
<div class="title">Figure 51. iOS Easings</div>
</div>
<div class="paragraph"><p>Also if you don&#8217;t like anyone, you can implement your custom timing function.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_cakeyframeanimation">CAKeyFrameAnimation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Until this part we have created single key-frame animations, from a value to value, without intermediates. But what happens when we need to set more points into a moving animation, by example the arc that makes the sun in the sky during the day?</p></div>
<div class="paragraph"><p>If we start on the left bottom corner on the screen and use a CABasicAnimation to move the sun to the right bottom, it will move in a straight line, so we will need to add a middle point in top middle of the screen. This is done using a CAKeyFrameAnimation:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_cloud_layers</span>
  <span class="n">layout_grass_layer</span>
  <span class="n">load_sun_animation</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">load_sun_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="c1"># We need to have an array for containing all the positions</span>
  <span class="n">values</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>


  <span class="c1"># Initial Sun Position</span>
  <span class="n">initial_sun_position</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_sun_position</span><span class="p">)</span>

  <span class="c1"># Middle Sun Position</span>
  <span class="n">middle_sun_position</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">155</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
  <span class="n">values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">middle_sun_position</span><span class="p">)</span>

  <span class="n">final_sun_position</span> <span class="o">=</span> <span class="no">NSValue</span><span class="o">.</span><span class="n">valueWithCGPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">values</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_sun_position</span><span class="p">)</span>


  <span class="n">translation_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>

     <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunStraightAnimation.png" alt="Sun Straight Animation" />
</div>
<div class="title">Figure 52. Sun Straight Animation</div>
</div>
<div class="paragraph"><p>We are improving! But the sun does not move in a straight line, so lets change does points into an arc:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


  <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
  <span class="c1"># animation to cover, is better this way using lines and curves</span>
  <span class="c1"># than setting every point by ourselfs</span>
  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                           <span class="n">controlPoint1</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                           <span class="n">controlPoint2</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


  <span class="c1"># Assign the path to the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunArcAnimation.png" alt="Sun Arc Animation" />
</div>
<div class="title">Figure 53. Sun Arc Animation</div>
</div>
<div class="paragraph"><p>Great! Now this is working, but how about combining the translation animation with a spinning one? (CABasicAnimation &amp; CAKeyframeAnimation):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

 <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
 <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

 <span class="c1"># Set the animation duration</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


 <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
 <span class="c1"># animation to cover, is better this way using lines and curves</span>
 <span class="c1"># than setting every point by ourselves</span>
 <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                          <span class="n">controlPoint1</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                          <span class="n">controlPoint2</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


 <span class="c1"># Assign the path to the animation</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

 <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

 <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>


 <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>


 <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
 <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
 <span class="c1"># y axis</span>
 <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>

 <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
 <span class="c1"># thats why the conversion PI * 2</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="no">Math</span><span class="o">::</span><span class="no">PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

 <span class="c1"># Set the duration according with the other animation</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

 <span class="c1"># Add the animation to the layer</span>
 <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;rotation_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>But this is not the end of it, what about changing the colors of the sky according to the position of the sun? For this we will need to animate the background layer in the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

 <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
 <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

 <span class="c1"># Set the animation duration</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


 <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
 <span class="c1"># animation to cover, is better this way using lines and curves</span>
 <span class="c1"># than setting every point by ourselfs</span>
 <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
 <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                          <span class="n">controlPoint1</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                          <span class="n">controlPoint2</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


 <span class="c1"># Assign the path to the animation</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

 <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

 <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
 <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>


 <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>


 <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
 <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
 <span class="c1"># y axis</span>
 <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>

 <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
 <span class="c1"># thats why the conversion PI * 2</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="no">Math</span><span class="o">::</span><span class="no">PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

 <span class="c1"># Set the duration according with the other animation</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

  <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">rotation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

 <span class="c1"># Add the animation to the layer</span>
 <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;rotation_animation&#39;</span><span class="p">)</span>


 <span class="c1"># We need to create an array of the color gradients thar we want the</span>
 <span class="c1"># background transition into</span>
 <span class="n">animation_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

 <span class="c1"># Because we are using a gradient, we need to have a 3 pair of colors for</span>
 <span class="c1"># each transition</span>

 <span class="c1"># Morning Colors</span>
 <span class="n">initial_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

 <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">07</span><span class="mi">8</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">463</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
 <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
 <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

 <span class="c1"># Mid Day Colors</span>
 <span class="n">mid_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

 <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">388</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">714</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
 <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
 <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

 <span class="c1"># Dawn Day Colors</span>
 <span class="n">final_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

 <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">094</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">086</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
 <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
 <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>


 <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_colors</span><span class="p">)</span>
 <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">mid_colors</span><span class="p">)</span>
 <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_colors</span><span class="p">)</span>


 <span class="c1"># Create a new instance of CAKeyframeAnimation with the property</span>
 <span class="c1"># of colors</span>
 <span class="n">gradient_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>

 <span class="c1"># Set the animation duration</span>
 <span class="n">gradient_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>

 <span class="c1"># Set the matrix of gradient colors into the animation</span>
 <span class="n">gradient_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">animation_colors</span>

 <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
 <span class="n">gradient_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>
 <span class="n">gradient_animation</span><span class="o">.</span><span class="n">fillMode</span> <span class="o">=</span> <span class="no">KCAFillModeForwards</span>

 <span class="vi">@background_layer</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">final_colors</span>
 <span class="vi">@background_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">gradient_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;colors_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunSunsetAnimation.png" alt="Sun Sunset Animation" />
</div>
<div class="title">Figure 54. Sun Sunset Animation</div>
</div>
<div class="paragraph"><p>It looks pretty good! But we are missing the night part right? Thats the next part of the exercise</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_ready_set_action">Ready, Set, Action!</h2>
<div class="sectionbody">
<div class="paragraph"><p>Do you remember when we talk about know when a animation finish? We will need that part to present our night scene! The way to know when the animation finished is using the delegate pattern, lets implement it!</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_sun_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


  <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
  <span class="c1"># animation to cover, is better this way using lines and curves</span>
  <span class="c1"># than setting every point by ourselfs</span>
  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                           <span class="n">controlPoint1</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                           <span class="n">controlPoint2</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


  <span class="c1"># Assign the path to the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

  <span class="c1"># We assign self as delegate of the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">removedOnCompletion</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">)</span>

  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>


  <span class="c1"># Create another instance of the CABasicAnimation with the property &#39;transform.rotation.z&#39;</span>
  <span class="c1"># this property allows us to change the layer in any of the three dimensions, in this case</span>
  <span class="c1"># y axis</span>
  <span class="n">rotation_animation</span> <span class="o">=</span> <span class="no">CABasicAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;transform.rotation.z&#39;</span><span class="p">)</span>

  <span class="c1"># Take a note here we are setting 360 degrees, but Core Animation works with radians</span>
  <span class="c1"># thats why the conversion PI * 2</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">toValue</span> <span class="o">=</span> <span class="no">NSNumber</span><span class="o">.</span><span class="n">numberWithFloat</span><span class="p">(</span><span class="no">Math</span><span class="o">::</span><span class="no">PI</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

  <span class="c1"># Set the duration according with the other animation</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">5</span>

   <span class="c1"># Because we want a infinite animation we set the repeat count to Float Max</span>
  <span class="n">rotation_animation</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="nb">Float</span><span class="o">::</span><span class="no">MAX</span>

  <span class="c1"># Add the animation to the layer</span>
  <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">rotation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;rotation_animation&#39;</span><span class="p">)</span>


  <span class="c1"># We need to create an array of the color gradients thar we want the</span>
  <span class="c1"># background transition into</span>
  <span class="n">animation_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Because we are using a gradient, we need to have a 3 pair of colors for</span>
  <span class="c1"># each transition</span>


  <span class="c1"># Last Night Color</span>
  <span class="n">last_night_color</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">last_night_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithWhite</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_night_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_night_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="c1"># Morning Colors</span>
  <span class="n">initial_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">07</span><span class="mi">8</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">463</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">329</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">612</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">984</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="c1"># Mid Day Colors</span>
  <span class="n">mid_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">388</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">714</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">988</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">mid_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">553</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">808</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">992</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="c1"># Dawn Day Colors</span>
  <span class="n">final_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">094</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">086</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>


  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">last_night_color</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_colors</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">mid_colors</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_colors</span><span class="p">)</span>


  <span class="c1"># Create a new instance of CAKeyframeAnimation with the property</span>
  <span class="c1"># of colors</span>
  <span class="n">gradient_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="c1"># Set the matrix of gradient colors into the animation</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">animation_colors</span>

  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">final_colors</span>

  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">gradient_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;colors_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">animationDidStop</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">finished</span><span class="ss">:flag</span><span class="p">)</span>

  <span class="n">load_sun_animation</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If you look close at the code, we don&#8217;t change pretty much right? Only we remove the repeatCount and assign the view controller as delegate of the animation, this is for when the animation finishes we invoke the method <strong>load_sun_animation</strong> again to continue the loop</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Also we add one more color into the background transition, this last is important for the day break transition.</td>
</tr></table>
</div>
<div class="paragraph"><p>For the next step please copy the <strong>bgMoon.png</strong> from the <strong>Define deployment target</strong> into our application resources folder.</p></div>
<div class="paragraph"><p>Lets add a new layer to include the new moon image:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">loadView</span>

  <span class="c1"># Lets create a view for our view controller</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="n">layout_background_layer</span>
  <span class="n">layout_sun_layer</span>
  <span class="n">layout_cloud_layers</span>
  <span class="n">layout_moon_layer</span>
  <span class="n">layout_grass_layer</span>
  <span class="n">load_sun_animation</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">layout_moon_layer</span>

  <span class="c1"># Lets instance a new layer for our first cloud image</span>
  <span class="vi">@moon_layer</span> <span class="o">=</span> <span class="no">CALayer</span><span class="o">.</span><span class="n">layer</span>
  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="no">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>

  <span class="c1"># Load the image into memory</span>
  <span class="n">moon_image</span> <span class="o">=</span> <span class="no">UIImage</span><span class="o">.</span><span class="n">imageNamed</span><span class="p">(</span><span class="s2">&quot;bgMoon.png&quot;</span><span class="p">)</span>

  <span class="c1"># Set the image as content of the layer</span>
  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">moon_image</span><span class="o">.</span><span class="n">CGImage</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">addSublayer</span><span class="p">(</span><span class="vi">@moon_layer</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>We are close! Lets implement the moon animation adding the following method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load_moon_animation</span>

  <span class="c1"># Create a new instance of CAKeyframeAnimation</span>
  <span class="n">translation_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>


  <span class="c1"># Using a BezierPath we will create the Arc for the position</span>
  <span class="c1"># animation to cover, is better this way using lines and curves</span>
  <span class="c1"># than setting every point by ourselfs</span>
  <span class="n">sun_path</span> <span class="o">=</span> <span class="no">UIBezierPath</span><span class="o">.</span><span class="n">bezierPath</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">moveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">660</span><span class="p">))</span>
  <span class="n">sun_path</span><span class="o">.</span><span class="n">addCurveToPoint</span><span class="p">(</span><span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">),</span>
                           <span class="n">controlPoint1</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">),</span>
                           <span class="n">controlPoint2</span><span class="ss">:CGPointMake</span><span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">))</span>


  <span class="c1"># Assign the path to the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sun_path</span><span class="o">.</span><span class="n">CGPath</span>

  <span class="c1"># Apply the timing function to simulate the Easy out Easing</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">timingFunction</span> <span class="o">=</span> <span class="no">CAMediaTimingFunction</span><span class="o">.</span><span class="n">functionWithName</span><span class="p">(</span><span class="no">KCAMediaTimingFunctionEaseInEaseOut</span><span class="p">)</span>

  <span class="c1"># We assign self as delegate of the animation</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="n">translation_animation</span><span class="o">.</span><span class="n">removedOnCompletion</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">410</span><span class="p">,</span> <span class="mi">660</span><span class="p">)</span>

  <span class="vi">@moon_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">translation_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;position_animation&#39;</span><span class="p">)</span>


  <span class="c1"># We need to create an array of the color gradients thar we want the</span>
  <span class="c1"># background transition into</span>
  <span class="n">animation_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="c1"># Because we are using a gradient, we need to have a 3 pair of colors for</span>
  <span class="c1"># each transition</span>

  <span class="c1"># The last gradient used in the sun animation</span>
  <span class="n">last_day_color</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">last_day_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">094</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">086</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">686</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_day_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">last_day_color</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">635</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">404</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>


  <span class="c1"># Night Colors</span>
  <span class="n">initial_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">00</span><span class="mi">8</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">169</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">302</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">365</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">627</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">initial_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">365</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">627</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>


  <span class="c1"># Midnight Colors</span>
  <span class="n">final_colors</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithWhite</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mo">051</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>
  <span class="n">final_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">colorWithRed</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">157</span><span class="p">,</span> <span class="n">green</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">173</span><span class="p">,</span> <span class="n">blue</span><span class="p">:</span><span class="mi">0</span><span class="o">.</span><span class="mi">192</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">CGColor</span><span class="p">)</span>

  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">last_day_color</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">initial_colors</span><span class="p">)</span>
  <span class="n">animation_colors</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">final_colors</span><span class="p">)</span>


  <span class="c1"># Create a new instance of CAKeyframeAnimation with the property</span>
  <span class="c1"># of colors</span>
  <span class="n">gradient_animation</span> <span class="o">=</span> <span class="no">CAKeyframeAnimation</span><span class="o">.</span><span class="n">animationWithKeyPath</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">)</span>

  <span class="c1"># Set the animation duration</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="mi">15</span>

  <span class="c1"># Set the matrix of gradient colors into the animation</span>
  <span class="n">gradient_animation</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">animation_colors</span>

  <span class="vi">@background_layer</span><span class="o">.</span><span class="n">addAnimation</span><span class="p">(</span><span class="n">gradient_animation</span><span class="p">,</span> <span class="n">forKey</span><span class="ss">:&#39;colors_animation&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we have the sun and the moon layers and animations, so as last part we need to transition between animations to simulate night and day. The best we can do at this point is on the animation delegate, invoke the moon animation if the sun ended and otherwise. This is implemented the following way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># CAAnimation delegate call</span>
<span class="k">def</span> <span class="nf">animationDidStop</span><span class="p">(</span><span class="n">animation</span><span class="p">,</span> <span class="n">finished</span><span class="ss">:flag</span><span class="p">)</span>

  <span class="c1"># Using the key of the addAnimation we can get the animation and compare</span>
  <span class="c1"># it against the one that finish to know if it is the sun or the moon one</span>
  <span class="k">if</span> <span class="n">animation</span> <span class="o">==</span> <span class="vi">@sun_layer</span><span class="o">.</span><span class="n">animationForKey</span><span class="p">(</span><span class="s1">&#39;position_animation&#39;</span><span class="p">)</span>

    <span class="n">load_moon_animation</span>
  <span class="k">else</span>

    <span class="n">load_sun_animation</span>
  <span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Interesting how can we retrieve the animation instance from a layer using the same keypath used when we add it. Thats the way can we determinate which application was finished!</p></div>
<div class="paragraph"><p>Now run the application and enjoy!</p></div>
<div class="imageblock">
<div class="content">
<img src="resources/ch21-CoreAnimation/ch21_SunAndMoonAnimation.png" alt="Sun & Moon Animation" />
</div>
<div class="title">Figure 55. Sun &amp; Moon Animation</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenges_5">Challenges</h2>
<div class="sectionbody">
<div class="olist arabic"><ol class="arabic">
<li>
<p>
In the <strong>Define deployment path</strong> are a couple of star images, the challenge is make a animation with them moving from top to bottom, only when the moon is rising. And remove them with another animation when the sun is appears
</p>
</li>
<li>
<p>
Change the past animation to look like shooting stars, enter and leaving the screen
</p>
</li>
</ol></div>
</div>
</div>
<h1 id="_day_5">Day 5</h1>
<h1 id="_chapter_25_third_party_libraries">Chapter 25 - Third Party Libraries</h1>
<div class="paragraph"><p>Integrating Third Party Libraries (Even if they are in Objective-C ;) into our project is pretty simple using CocoaPods. For this application lets make a simple game called asteroids using a library called Cocos2D</p></div>
<div class="sect1">
<h2 id="_cocoapods">CocoaPods</h2>
<div class="sectionbody">
<div class="paragraph"><p>CocoaPods (cocoapods.org) is a dependency library manager for Objective-C projects, much more like bundler is in rails. Using CocoaPods with a RubyMotion project simplifies all the tasks needed to integrate the library: Just add the Pod to the <strong>RakeFile</strong> and then compile the app. It will download the library, also all of its dependencies and then link them to the app.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_cocos_2d">Cocos 2D</h2>
<div class="sectionbody">
<div class="paragraph"><p>Cocos 2D (cocos2d-iphone.org) is a framework made it in Objective-C that will allow us to create a 2D Video Game more easy. In this case it will be a old game called Asteroids, the objective of the game is that using a SpaceShip destroy as many meteors as you can without crashing into them</p></div>
<div class="sect2">
<h3 id="_getting_it_running">Getting it Running</h3>
<div class="paragraph"><p>First we need to install CocoaPods into our MacOSX, this is done running the following commands into our terminal:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo gem install cocoapods

<span class="nv">$ </span>pod setup

<span class="nv">$ </span>sudo gem install motion-cocoapods
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_create_the_app">Create the App</h3>
<div class="paragraph"><p>Lets create a new project called <strong>Asteroids</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>motion create Asteroids
</pre></div></div></div>
<div class="paragraph"><p>Then integrate Cocos2D into our project editing our <strong>RakeFile</strong></p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>Asteroids

<span class="nv">$ </span>open RakeFile
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;/Library/RubyMotion/lib&quot;</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">&#39;motion/project&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;motion-cocoapods&#39;</span>

<span class="no">Motion</span><span class="o">::</span><span class="no">Project</span><span class="o">::</span><span class="no">App</span><span class="o">.</span><span class="n">setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="c1"># Use `rake config&#39; to see complete project settings.</span>
  <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;asteroids&#39;</span>

  <span class="n">app</span><span class="o">.</span><span class="n">pods</span> <span class="k">do</span>

    <span class="n">pod</span> <span class="s1">&#39;cocos2d&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Well! Lets build our project (It can take a couple of seconds because the weight of the Cocos2D library):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>Now please copy the file <strong>RubyMotionSchedule.h</strong> from <strong>Define Deployment Target</strong> into /vendor/Pods/cocos2d/cocos2d, next delete the file <strong>Pods.bridgesupport</strong> that is on /vendor/Pods and finally clean the project:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>rake clean

<span class="nv">$ </span>rake
</pre></div></div></div>
<div class="paragraph"><p>The Cocos2D library is now integrated into our project! Easy right?</p></div>
</div>
<div class="sect2">
<h3 id="_building_a_game">Building a Game</h3>
<div class="paragraph"><p>The first thing we need to understand is how the video games work, different from a regular application where the code is executed when an event happen (User interaction, Notification, etc) on video games there is always a loop calling methods for different proposes like refreshing screen, calling the game physics or asking something to the AI. Thankfully in Cocos 2D we have an object that its main responsibility is manage the loop, this class is called <strong>CCDirector</strong></p></div>
<div class="paragraph"><p>Before start coding please copy the images from <strong>DEFINE DEPLOYMENT PATH</strong> into the project resources folder. Now implement the following on our <strong>AppDelegate</strong>:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The CCDirector is the responsible for running the game or pausing it, also it can handle when a phone call or text message happen so it can automatically pause the game</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The number of times the loop runs per second is called FPS (Frames per second), and it depends on how fast the methods are executed in every loop call</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>app

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AppDelegate</span>

  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

    <span class="c1"># Create a window to present our director</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="c1"># Lets create a Cocos 2D view that will be used by the director</span>
    <span class="c1"># to present the game scenes</span>
    <span class="n">gl_view</span> <span class="o">=</span> <span class="no">CCGLView</span><span class="o">.</span><span class="n">viewWithFrame</span><span class="p">(</span><span class="vi">@window</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>


    <span class="c1"># Get the Director shared instance for customization</span>
    <span class="vi">@director</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span>

    <span class="c1"># Specify that we want to run the game in fullscreen</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">wantsFullScreenLayout</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># Tell the director that we want to present the FPS on</span>
    <span class="c1"># the screen</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">displayStats</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># The prefered speed on our game (FPS)</span>
    <span class="c1"># Note: This is only a prefered value its not garantied you will</span>
    <span class="c1"># get that value</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">animationInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">60</span>

    <span class="c1"># Assign the view used for the director to present the</span>
    <span class="c1"># game scenes</span>
    <span class="vi">@director</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">gl_view</span>

    <span class="c1"># Create a navigation controller to store our game director and</span>
    <span class="c1"># hide its navigation bar so we can use all the sreen</span>
    <span class="vi">@navigation_controller</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@director</span><span class="p">)</span>
    <span class="vi">@navigation_controller</span><span class="o">.</span><span class="n">navigationBarHidden</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># Assign the navigation controller to the window</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="vi">@navigation_controller</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>


    <span class="c1"># Configuration for our game images, this is very helpful</span>
    <span class="c1"># when you want to use compressed images or with a different</span>
    <span class="c1"># pixel format</span>
    <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">defaultAlphaPixelFormat</span> <span class="o">=</span> <span class="no">KCCTexture2DPixelFormat_RGBA8888</span>
    <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">PVRImagesHavePremultipliedAlpha</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>

    <span class="c1"># Configuration for the names of the images that will be</span>
    <span class="c1"># used on the game</span>
    <span class="n">file_utils</span> <span class="o">=</span> <span class="no">CCFileUtils</span><span class="o">.</span><span class="n">sharedFileUtils</span>
    <span class="n">file_utils</span><span class="o">.</span><span class="n">enableFallbackSuffixes</span> <span class="o">=</span> <span class="kp">false</span>

    <span class="c1"># The retina display images will be named with &quot;-hd&quot; instead of</span>
    <span class="c1"># &quot;@2x&quot;</span>
    <span class="n">file_utils</span><span class="o">.</span><span class="n">setiPhoneRetinaDisplaySuffix</span> <span class="s2">&quot;-hd&quot;</span>

    <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>You should see the following:</p></div>
<div class="paragraph"><p><strong>IMAGE</strong></p></div>
<div class="paragraph"><p>If you look closely in the bottom left part of the screen are a bunch of numbers, they are the FPS of our game. The general idea is that our game have consistently 60.0 but you will look as we advance in the exercise that some times it drops, this is normal.</p></div>
</div>
<div class="sect2">
<h3 id="_scenes">Scenes</h3>
<div class="paragraph"><p>We can understand the <strong>Scenes</strong> as levels on a video game, but also can be used for the initial menus or score boards after. Its main responsibility is to manage all the objects that will appear on the screen when the scene is run. On our game this objects will be the space background, ship and asteroids</p></div>
<div class="paragraph"><p>Lets create a new scene named <strong>space_scene.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mkdir scenes

<span class="nv">$ </span><span class="nb">cd </span>scenes

<span class="nv">$ </span>touch space_scene.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SpaceScene</span> <span class="o">&lt;</span> <span class="no">CCScene</span>

 <span class="k">def</span> <span class="nf">init</span>

   <span class="k">if</span> <span class="k">super</span>


   <span class="k">end</span>

   <span class="nb">self</span>
 <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we have a new empty Scene that will allow us to start presenting the game images but before we get to that part we need to tell the <strong>Director</strong> to run this scene, this is do with the following in our <strong>app_delegate.rb</strong> file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>open app_delegate.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">didFinishLaunchingWithOptions</span><span class="ss">:launchOptions</span><span class="p">)</span>

  <span class="c1"># Create a window to present our director</span>
  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

  <span class="c1"># Lets create a Cocos 2D view that will be used by the director</span>
  <span class="c1"># to present the game scenes</span>
  <span class="n">gl_view</span> <span class="o">=</span> <span class="no">CCGLView</span><span class="o">.</span><span class="n">viewWithFrame</span><span class="p">(</span><span class="vi">@window</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>


  <span class="c1"># Get the Director shared instance for customization</span>
  <span class="vi">@director</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span>

  <span class="c1"># Specify that we want to run the game in fullscreen</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">wantsFullScreenLayout</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Tell the director that we want to present the FPS on</span>
  <span class="c1"># the screen</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">displayStats</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># The prefered speed on our game (FPS)</span>
  <span class="c1"># Note: This is only a prefered value its not garantied you will</span>
  <span class="c1"># get that value</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">animationInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">60</span>

  <span class="c1"># Assign the view used for the director to present the</span>
  <span class="c1"># game scenes</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">gl_view</span>

  <span class="c1"># Create a navigation controller to store our game director and</span>
  <span class="c1"># hide its navigation bar so we can use all the sreen</span>
  <span class="vi">@navigation_controller</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@director</span><span class="p">)</span>
  <span class="vi">@navigation_controller</span><span class="o">.</span><span class="n">navigationBarHidden</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># Assign the navigation controller to the window</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="vi">@navigation_controller</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>


  <span class="c1"># Configuration for our game images, this is very helpful</span>
  <span class="c1"># when you want to use compressed images or with a different</span>
  <span class="c1"># pixel format</span>
  <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">defaultAlphaPixelFormat</span> <span class="o">=</span> <span class="no">KCCTexture2DPixelFormat_RGBA8888</span>
  <span class="no">CCTexture2D</span><span class="o">.</span><span class="n">PVRImagesHavePremultipliedAlpha</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>

  <span class="c1"># Configuration for the names of the images that will be</span>
  <span class="c1"># used on the game</span>
  <span class="n">file_utils</span> <span class="o">=</span> <span class="no">CCFileUtils</span><span class="o">.</span><span class="n">sharedFileUtils</span>
  <span class="n">file_utils</span><span class="o">.</span><span class="n">enableFallbackSuffixes</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="c1"># The retina display images will be named with &quot;-hd&quot; instead of</span>
  <span class="c1"># &quot;@2x&quot;</span>
  <span class="n">file_utils</span><span class="o">.</span><span class="n">setiPhoneRetinaDisplaySuffix</span> <span class="s2">&quot;-hd&quot;</span>

  <span class="c1"># Tell the director to present the SpaceScene, it works similar to a</span>
  <span class="c1"># navigation controller: Push to present &amp; Pop to dismiss</span>
  <span class="c1">#</span>
  <span class="c1"># If you look closelly to the initialization of the scene we are using</span>
  <span class="c1"># the node method, instead of new or alloc init this is because Cocos 2D</span>
  <span class="c1"># do some memory allocation performance upgrades</span>
  <span class="vi">@director</span><span class="o">.</span><span class="n">pushScene</span><span class="p">(</span><span class="no">SpaceScene</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

  <span class="kp">true</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now we can start adding graphical elements to our game!</p></div>
</div>
<div class="sect2">
<h3 id="_layers">Layers</h3>
<div class="paragraph"><p>In Cocos 2D exists some objects to allow us to render graphical components (Sprites, Particles) on the screen, these are named <strong>CCLayers</strong>. But do not exist layers (CALayers) in iOS already?  Yes they are, but this have some differences: One of the more important is that the CCLayers can handle touches too!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">A sprite is a two dimensional image that is integrated in a bigger scene and can be moved on-screen or manipulated as a single unit. On short an image ;)</td>
</tr></table>
</div>
<div class="paragraph"><p>Knowing this lets create our first CCLayer named <strong>background_layer</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mkdir layers

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>touch background_layer.rb

<span class="nv">$ </span>open background_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">BackgroundLayer</span> <span class="o">&lt;</span> <span class="no">CCLayer</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="c1"># For testing proposes lets create a CCLabel to present</span>
      <span class="c1"># some text on the screen</span>
      <span class="n">label</span> <span class="o">=</span> <span class="no">CCLabelTTF</span><span class="o">.</span><span class="n">labelWithString</span><span class="p">(</span><span class="s1">&#39;Its so cool to make a game&#39;</span><span class="p">,</span>
                                         <span class="n">fontName</span><span class="ss">:&#39;Marker Felt&#39;</span><span class="p">,</span>
                                         <span class="n">fontSize</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span>

      <span class="c1"># We need to get the screen size for positioning the label</span>
      <span class="n">window_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

      <span class="c1"># Like the CALayers the position is set in reference to the center</span>
      <span class="c1"># of the label, in this case we want the label to be in the middle</span>
      <span class="c1"># of the screen</span>
      <span class="n">label</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">window_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">window_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

      <span class="c1"># Add the label to the Layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Great! Our layer is complete, now lets add it to the scene:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>scenes

<span class="nv">$ </span>open space_scene.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new instance of a Background Layer</span>
    <span class="n">background_layer</span> <span class="o">=</span> <span class="no">BackgroundLayer</span><span class="o">.</span><span class="n">node</span>

    <span class="c1"># Add it to the scene</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">background_layer</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>If you run the app you should see the following:</p></div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>Now we have all the necessary structure to make the game run: A director, scene and a layer! Its time to change the label into a space background:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open background_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new sprite with our background image</span>
    <span class="n">background_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpace.png&#39;</span><span class="p">)</span>

    <span class="c1"># We need to get the screen size for positioning the sprite</span>
    <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

    <span class="c1"># Like the CALayers the position is set in reference to the center</span>
    <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
    <span class="c1"># of the screen</span>
    <span class="n">background_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add the sprite to the Layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">background_sprite</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>We have a background for the game! Lets do something more fun: adding the space ship into the scene, for this we need to create a new layer called <strong>game_play_layer.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>touch game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">GamePlayLayer</span> <span class="o">&lt;</span> <span class="no">CCLayer</span>

  <span class="k">def</span> <span class="nf">init</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="c1"># Create a new sprite instance for drawing our spaceship</span>
      <span class="vi">@space_ship_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpaceShip.png&#39;</span><span class="p">)</span>

      <span class="c1"># We need to get the screen size for positioning the sprite</span>
      <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

      <span class="c1"># Like the CALayers the position is set in reference to the center</span>
      <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
      <span class="c1"># of the screen</span>
      <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

      <span class="c1"># Add the sprite to the Layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="vi">@space_ship_sprite</span><span class="p">)</span>

      <span class="c1"># Enable handle touches on the layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">isTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>

    <span class="nb">self</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now that we have our space ship layer its time to add it to the scene:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>scenes

<span class="nv">$ </span>open space_scene.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new instance of a Background Layer</span>
    <span class="n">background_layer</span> <span class="o">=</span> <span class="no">BackgroundLayer</span><span class="o">.</span><span class="n">node</span>

    <span class="c1"># Add it to the scene</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">background_layer</span><span class="p">)</span>


    <span class="c1"># Create a new instance of a Game Play Layer</span>
    <span class="n">game_play_layer</span> <span class="o">=</span> <span class="no">GamePlayLayer</span><span class="o">.</span><span class="n">node</span>

    <span class="c1"># Add it to the scene</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">game_play_layer</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>Awesome! The next step is to allow the user to move the space ship with his touches on the screen. Lets open again our <strong>game_play_layer.rb</strong> and add the following method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for handling the initial touch of the user</span>
<span class="c1"># Very similar to the way iOS manage it</span>
<span class="k">def</span> <span class="nf">ccTouchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="ss">:event</span><span class="p">)</span>

  <span class="c1"># Get any touch of the user</span>
  <span class="n">touch</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span>

  <span class="c1"># Because we are not using a UIView or anything related</span>
  <span class="c1"># we need to use a method to convert the touch position</span>
  <span class="c1"># coordinate space into the layer space</span>
  <span class="n">touch_location</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">convertTouchToNodeSpace</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>

  <span class="c1"># Move the spaceship to the touch position</span>
  <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">touch_location</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>Yes it moves! But it does without animation, this is because the sprites does not have implicit animations like a CALayer.</p></div>
</div>
<div class="sect2">
<h3 id="_animations_in_the_space">Animations in the Space</h3>
<div class="paragraph"><p>The animations in Cocos 2D are called actions, so lets create a action for the ship so it will move to the location of the touch in a animated way:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for handling the initial touch of the user</span>
<span class="c1"># Very similar to the way iOS manage it</span>
<span class="k">def</span> <span class="nf">ccTouchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="ss">:event</span><span class="p">)</span>

  <span class="c1"># Get any touch of the user</span>
  <span class="n">touch</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span>

  <span class="c1"># Because we are not using a UIView or anything related</span>
  <span class="c1"># we need to use a method to convert the touch position</span>
  <span class="c1"># coordinate space into the layer space</span>
  <span class="n">touch_location</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">convertTouchToNodeSpace</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>

  <span class="c1"># We need to create a MoveBy action for the animated movement</span>
  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span>
                                       <span class="n">position</span><span class="ss">:touch_location</span><span class="p">)</span>

  <span class="c1"># Execute the action in our Space Ship Sprite</span>
  <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">We are not really animating the movement, just making it frame by frame using the game FPS. (Interpolation ;)</td>
</tr></table>
</div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>Upps! What when wrong? The problem is the actions must receive the number of points of movement in a direction, not a exact position! You can try it! Just assign a <strong>CGPoint(100, 100)</strong> to the position parameter of the action.</p></div>
<div class="paragraph"><p>The fix is the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for handling the initial touch of the user</span>
<span class="c1"># Very similar to the way iOS manage it</span>
<span class="k">def</span> <span class="nf">ccTouchesBegan</span><span class="p">(</span><span class="n">touches</span><span class="p">,</span> <span class="n">withEvent</span><span class="ss">:event</span><span class="p">)</span>

  <span class="c1"># Get any touch of the user</span>
  <span class="n">touch</span> <span class="o">=</span> <span class="n">touches</span><span class="o">.</span><span class="n">anyObject</span>

  <span class="c1"># Because we are not using a UIView or anything related</span>
  <span class="c1"># we need to use a method to convert the touch position</span>
  <span class="c1"># coordinate space into the layer space</span>
  <span class="n">touch_location</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">convertTouchToNodeSpace</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>

  <span class="c1"># Get the current position of the space ship</span>
  <span class="n">current_location</span> <span class="o">=</span> <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span>

  <span class="c1"># Calculate the difference between the two points</span>
  <span class="n">location_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">touch_location</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">current_location</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">touch_location</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">current_location</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

  <span class="c1"># We need to create a MoveBy action for the animated movement</span>
  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span>
                                       <span class="n">position</span><span class="ss">:location_difference</span><span class="p">)</span>

  <span class="c1"># Execute the action in our Space Ship Sprite</span>
  <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>Now is working! We are done with the space ship, the next is to add some asteroids flying into the scene.</p></div>
</div>
<div class="sect2">
<h3 id="_ccsprite">CCSprite</h3>
<div class="paragraph"><p>Now is time to create some asteroids for our game, also its time to learn how to create more complex sprites. Lets begin adding a new class named <strong>asteroid_sprite.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span>mkdir sprites

<span class="nv">$ </span><span class="nb">cd </span>sprites

<span class="nv">$ </span>touch asteroid_sprite.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AsteroidSprite</span> <span class="o">&lt;</span> <span class="no">CCSprite</span>

  <span class="c1"># This is the designated initializer of the CCSprite</span>
  <span class="k">def</span> <span class="nf">initWithTexture</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span> <span class="n">rect</span><span class="ss">:rect</span><span class="p">)</span>

    <span class="k">if</span> <span class="k">super</span>

      <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="nb">self</span>

  <span class="k">end</span>

  <span class="c1"># Method for optimizing the code needed to instantiate</span>
  <span class="c1"># a new asteroid</span>
        <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">sprite</span>

    <span class="no">AsteroidSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgAsteroid.png&#39;</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Lets add our new sprite to the <strong>game_play_layer.rb</strong>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new sprite instance for drawing our spaceship</span>
    <span class="vi">@space_ship_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpaceShip.png&#39;</span><span class="p">)</span>

    <span class="c1"># We need to get the screen size for positioning the sprite</span>
    <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

    <span class="c1"># Like the CALayers the position is set in reference to the center</span>
    <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
    <span class="c1"># of the screen</span>
    <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add the sprite to the Layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="vi">@space_ship_sprite</span><span class="p">)</span>

    <span class="c1"># Enable handle touches on the layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">isTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1"># Add an asteroid sprite to our layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="no">AsteroidSprite</span><span class="o">.</span><span class="n">sprite</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>Easy right? But we have a problem the asteroid is too big: Imagine five of them flying into the screen, impossible to dodge!</p></div>
<div class="paragraph"><p>So lets create something more complex, the idea is to have asteroids of different sizes moving across the screen. So lets use some randoms for determinate the size of the asteroid:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>sprites

<span class="nv">$ </span>open asteroid_sprite.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kp">attr_accessor</span> <span class="ss">:state</span>

<span class="c1"># This is the designated initializer of the CCSprite</span>
<span class="k">def</span> <span class="nf">initWithTexture</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span> <span class="n">rect</span><span class="ss">:rect</span><span class="p">)</span>

  <span class="k">if</span> <span class="k">super</span>
    <span class="vi">@state</span> <span class="o">=</span> <span class="ss">:spawning</span>

    <span class="n">spawn</span>
  <span class="k">end</span>

  <span class="nb">self</span>

<span class="k">end</span>

<span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>IMAGE</strong></p></div>
<div class="paragraph"><p>Great! Now the size of the asteroid is completely random, to test it run the app multiple times!</p></div>
<div class="paragraph"><p>For make the illusion that the asteroids are coming from the space we need to set the initial position of it outside the screen and then move it across the screen. Again some randoms we will help us, lets add the following method to our file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method for calculating positions around the screen</span>
<span class="k">def</span> <span class="nf">position_outside_screen</span>

  <span class="c1"># Instantiate a new random</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>

  <span class="c1"># Generate a new random that we will use to determinate</span>
  <span class="c1"># in which screen side is the point</span>
  <span class="n">screen_side</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span><span class="p">)</span>

  <span class="c1"># We need to get the screen size for positioning the sprite</span>
  <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

  <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c1"># According to the side of the screen generate the coordinates</span>
  <span class="c1"># also we need to take in count the size of the sprite, so it</span>
  <span class="c1"># can be completely outside the screen</span>

  <span class="c1"># Top Side</span>
  <span class="k">if</span> <span class="n">screen_side</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span>

  <span class="c1"># Left Side</span>
  <span class="k">elsif</span> <span class="n">screen_side</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

  <span class="c1"># Right Side</span>
  <span class="k">elsif</span> <span class="n">screen_side</span> <span class="o">==</span> <span class="mi">3</span>

    <span class="n">x</span> <span class="o">=</span> <span class="mi">320</span> <span class="o">+</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

  <span class="c1"># Bottom Side</span>
  <span class="k">else</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.screen_size</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">480</span> <span class="o">+</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span>

  <span class="k">end</span>

  <span class="no">CGPointMake</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now lets use this method for assign an initial position to our asteroid and create an action for its movement across the screen:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


  <span class="c1"># Generate an initial and final position for the asteroid</span>
  <span class="n">initial_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>
  <span class="n">final_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>

  <span class="c1"># Calculate the difference between the two positions</span>
  <span class="n">position_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">final_position</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">final_position</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>


  <span class="c1"># Lets use another random that we will use for the movement speed</span>
  <span class="n">action_speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span>

  <span class="c1"># Create a Move By Action for its movement across the screen</span>
  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                       <span class="n">position</span><span class="ss">:position_difference</span><span class="p">)</span>

  <span class="c1"># Assign the initial position</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">initial_position</span>

  <span class="c1"># Run the movement action</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>IMAGE</strong></p></div>
<div class="paragraph"><p>You should see the asteroid fly across the screen! If you don&#8217;t please run it a couple of times remember we are using randoms! (The asteroid can fly too fast or in the edges of the screen, this is part of the magic ;)</p></div>
<div class="paragraph"><p>But the asteroids does not move like that! They rotate:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


  <span class="c1"># Generate an initial and final position for the asteroid</span>
  <span class="n">initial_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>
  <span class="n">final_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>

  <span class="c1"># Calculate the difference between the two positions</span>
  <span class="n">position_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">final_position</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">final_position</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>


  <span class="c1"># Lets use another random that we will use for the movement speed</span>
  <span class="n">action_speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="n">.</span><span class="mi">7</span><span class="p">)</span>

  <span class="c1"># Create a Move By Action for its movement across the screen</span>
  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                       <span class="n">position</span><span class="ss">:position_difference</span><span class="p">)</span>

  <span class="c1"># Assign the initial position</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">initial_position</span>

  <span class="c1"># Run the movement action</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

  <span class="c1"># Create a spinning action with the same speed that the movement one</span>
  <span class="c1"># also because we want it to spin a couple of times set the angle</span>
  <span class="c1"># to 1000 degrees</span>
  <span class="n">spinning_action</span> <span class="o">=</span> <span class="no">CCRotateTo</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                                  <span class="n">angle</span><span class="p">:</span><span class="mi">1000</span><span class="p">)</span>

  <span class="c1"># Run the spinning action</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">spinning_action</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>Image</strong></p></div>
<div class="paragraph"><p>Last part! We need to change the status of the sprite to <strong>:ended</strong> when the movement action ends:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Method that will manage the spawning points, size</span>
<span class="c1"># and trayectory of the asteroid</span>
<span class="k">def</span> <span class="nf">spawn</span>

  <span class="c1"># Lets create a Random and generate a number between</span>
  <span class="c1"># 25 and 75, the maximum and minimum size for the asteroid</span>
  <span class="n">random</span> <span class="o">=</span> <span class="no">Random</span><span class="o">.</span><span class="n">new</span>
  <span class="n">sprite_size</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">25</span><span class="o">.</span><span class="n">.</span><span class="mi">75</span><span class="p">)</span>

  <span class="c1"># Scale the sprite according to our new generated size</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleX</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">setScaleY</span><span class="p">(</span><span class="n">sprite_size</span> <span class="o">/</span> <span class="nb">self</span><span class="o">.</span><span class="n">contentSize</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>


  <span class="c1"># Generate an initial and final position for the asteroid</span>
  <span class="n">initial_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>
  <span class="n">final_position</span> <span class="o">=</span> <span class="n">position_outside_screen</span>

  <span class="c1"># Assign the initial position</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">initial_position</span>

  <span class="c1"># Calculate the difference between the two positions</span>
  <span class="n">position_difference</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">final_position</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                    <span class="n">final_position</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">initial_position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>


  <span class="c1"># Lets use another random that we will use for the movement speed</span>
  <span class="n">action_speed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span>

  <span class="c1"># Create a Move By Action for its movement across the screen</span>
  <span class="n">action</span> <span class="o">=</span> <span class="no">CCMoveBy</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                       <span class="n">position</span><span class="ss">:position_difference</span><span class="p">)</span>

  <span class="c1"># Instantiate a Call Function to excecute a method when the movement</span>
  <span class="c1"># action finished</span>
  <span class="n">finish_callback_action</span> <span class="o">=</span> <span class="no">CCCallFuncND</span><span class="o">.</span><span class="n">actionWithTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span>
                                                         <span class="n">selector</span><span class="ss">:&#39;movement_action_ended&#39;</span><span class="p">,</span>
                                                         <span class="n">data</span><span class="ss">:nil</span><span class="p">)</span>

  <span class="c1"># Chain the both actions using a sequence</span>
  <span class="n">movement_action_sequence</span> <span class="o">=</span> <span class="no">CCSequence</span><span class="o">.</span><span class="n">actionsWithArray</span><span class="p">(</span><span class="o">[</span><span class="n">action</span><span class="p">,</span> <span class="n">finish_callback_action</span><span class="o">]</span><span class="p">)</span>

  <span class="c1"># Run the movement action sequence</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">movement_action_sequence</span><span class="p">)</span>


  <span class="c1"># Create a spinning action with the same speed that the movement one</span>
  <span class="c1"># also because we want it to spin a couple of times set the angle</span>
  <span class="c1"># to 1000 degrees</span>
  <span class="n">spinning_action</span> <span class="o">=</span> <span class="no">CCRotateTo</span><span class="o">.</span><span class="n">actionWithDuration</span><span class="p">(</span><span class="n">action_speed</span><span class="p">,</span>
                                                  <span class="n">angle</span><span class="p">:</span><span class="mi">1000</span><span class="p">)</span>

  <span class="c1"># Run the spinning action</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">runAction</span><span class="p">(</span><span class="n">spinning_action</span><span class="p">)</span>

<span class="k">end</span>

<span class="c1"># Action Movement Callback Method</span>
<span class="k">def</span> <span class="nf">movement_action_ended</span>

  <span class="vi">@state</span> <span class="o">=</span> <span class="ss">:ended</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p>Now our asteroid sprite is finished! So for the game makes sense it should be multiple asteroids flying across the screen right? Thats next!</p></div>
</div>
<div class="sect2">
<h3 id="_fps_asteroid">FPS + Asteroid</h3>
<div class="paragraph"><p>Do you remember that at the beginning of the exercise we talk about that the director executes a method multiple times a second to let us do some work like talk to the AI, Physics or refreshing the screen? Lets use this method for maintain a constant number of asteroids on the screen: creating them and then when it movement finishes destroy them.</p></div>
<div class="paragraph"><p>Lets open again our <strong>GamePlayLayer</strong> and subscribe to the loop notification:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> ..

<span class="nv">$ </span><span class="nb">cd </span>layers

<span class="nv">$ </span>open game_play_layer.rb
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">def</span> <span class="nf">init</span>

  <span class="k">if</span> <span class="k">super</span>

    <span class="c1"># Create a new sprite instance for drawing our spaceship</span>
    <span class="vi">@space_ship_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgSpaceShip.png&#39;</span><span class="p">)</span>

    <span class="c1"># We need to get the screen size for positioning the sprite</span>
    <span class="n">screen_size</span> <span class="o">=</span> <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">winSize</span>

    <span class="c1"># Like the CALayers the position is set in reference to the center</span>
    <span class="c1"># of the label, in this case we want the sprite to be in the middle</span>
    <span class="c1"># of the screen</span>
    <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="n">screen_size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">screen_size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Add the sprite to the Layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="vi">@space_ship_sprite</span><span class="p">)</span>

    <span class="c1"># Enable handle touches on the layer</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">isTouchEnabled</span> <span class="o">=</span> <span class="kp">true</span>

    <span class="c1">#Create an array for storing our asteroid sprites</span>
    <span class="vi">@asteroids</span> <span class="o">=</span> <span class="no">NSMutableArray</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">init</span>

    <span class="c1"># Subscribe to the loop call</span>
    <span class="n">scheduleUpdate</span>

  <span class="k">end</span>

  <span class="nb">self</span>
<span class="k">end</span>

<span class="c1"># Loop callback method</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

<span class="k">end</span>
</pre></div></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please take a closer look to the code because we remove the add of the initial asteroid sprite and add an array for storing the asteroid sprites</td>
</tr></table>
</div>
<div class="paragraph"><p>Now is time to add some asteroids to our game, implement the following on the <strong>update</strong> method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Loop callback method</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

  <span class="n">spawn_asteroids</span>
<span class="k">end</span>


<span class="k">def</span> <span class="nf">spawn_asteroids</span>

  <span class="c1"># Delete the asteroids that are on ended state</span>
  <span class="vi">@asteroids</span><span class="o">.</span><span class="n">delete_if</span> <span class="p">{</span> <span class="o">|</span> <span class="n">asteroid</span> <span class="o">|</span>

    <span class="c1"># If the asteroid is on ended state</span>
    <span class="k">if</span> <span class="n">asteroid</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="ss">:ended</span>

      <span class="c1"># Remove from the layer also</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="n">asteroid</span><span class="p">,</span> <span class="n">cleanup</span><span class="ss">:true</span><span class="p">)</span>

      <span class="kp">true</span>
    <span class="k">end</span>
  <span class="p">}</span>

  <span class="c1"># Calculate the number of asteroids missing, taking</span>
  <span class="c1"># in count that we should have 20 moving around</span>
  <span class="n">missing_asteroids</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">-</span> <span class="vi">@asteroids</span><span class="o">.</span><span class="n">count</span>

  <span class="c1"># Iterate to create the missing asteroids</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="n">.missing_asteroids</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="c1"># Create an asteroid sprite</span>
    <span class="n">asteroid_sprite</span> <span class="o">=</span> <span class="no">AsteroidSprite</span><span class="o">.</span><span class="n">sprite</span>

    <span class="c1"># Add it to the layer and to the array</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">asteroid_sprite</span><span class="p">)</span>
    <span class="vi">@asteroids</span><span class="o">.</span><span class="n">addObject</span><span class="p">(</span><span class="n">asteroid_sprite</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>IMAGE</strong></p></div>
<div class="paragraph"><p>Awesome! Now the scene is complete, but is something missing right? Detect when the ship crashes with an asteroid!</p></div>
</div>
<div class="sect2">
<h3 id="_please_don_8217_t_crash">Please don&#8217;t crash!</h3>
<div class="paragraph"><p>The last part of our exercise is to detect when the asteroid crashes with our space ship! For this lets add the following method:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1"># Loop callback method</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

  <span class="n">spawn_asteroids</span>
  <span class="n">check_for_collisions</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">check_for_collisions</span>

  <span class="c1"># Iterate all the asteroids in the scene</span>
  <span class="vi">@asteroids</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span> <span class="n">asteroid</span> <span class="o">|</span>

    <span class="c1"># If any asteroid frame intersect the space ship frame</span>
    <span class="c1"># is a collision</span>
    <span class="k">if</span> <span class="no">CGRectIntersectsRect</span><span class="p">(</span><span class="n">asteroid</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">,</span> <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">)</span>

      <span class="c1"># Create a new sprite instance for our explosion</span>
      <span class="n">explosion_sprite</span> <span class="o">=</span> <span class="no">CCSprite</span><span class="o">.</span><span class="n">spriteWithFile</span><span class="p">(</span><span class="s1">&#39;bgBoom.jpeg&#39;</span><span class="p">)</span>

      <span class="c1"># Set the sprite in the same exact position of the</span>
      <span class="c1"># space ship</span>
      <span class="n">explosion_sprite</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="vi">@space_ship_sprite</span><span class="o">.</span><span class="n">position</span>

      <span class="c1"># Add the explosion sprite into our layer</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span><span class="n">explosion_sprite</span><span class="p">)</span>

      <span class="c1"># Pause the game</span>
      <span class="no">CCDirector</span><span class="o">.</span><span class="n">sharedDirector</span><span class="o">.</span><span class="n">pause</span>
    <span class="k">end</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div></div></div>
<div class="paragraph"><p><strong>IMAGE</strong></p></div>
<div class="paragraph"><p>Great! Now our little game is complete, if the user crashes into an asteroid the space ship explodes and the game is ended</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Even if you are a master moving your ship sometimes it will crash without touching any asteroid, this is because collision detection is more like an art and it depends on more advanced techniques like physics or sprite sheets to be pixel perfect. But that subjects are not in the scope of this course :'(</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_challenges_6">Challenges</h3>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Add a "Game Over" scene to the game when a collision happen, remember that the CCDirector can push new scenes into the screen
</p>
</li>
<li>
<p>
Detect when the user touches an asteroid so you can remove it from the screen, clearing the way for our space ship to move
</p>
</li>
</ol></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Version 0.1<br />
Last updated 2012-11-16 20:09:20 CST
</div>
</div>
</body>
</html>
